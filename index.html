<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานคนไข้ Home Ward</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
            color: #111827;
            font-weight: 400;
            line-height: 1.5;
        }

        .line-green {
            color: #06c755;
        }

        .bg-line-green {
            background-color: #06c755;
        }

        .bg-line-dark {
            background-color: #05a546;
        }

        .generate-btn-update {
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.35);
        }

        :focus-visible {
            outline: 3px solid rgba(6, 199, 85, 0.65);
            outline-offset: 2px;
        }

        /* Assessment (A) Button Style */
        .assess-btn-active {
            color: #ffffff !important;
        }

        .assess-btn-active-better {
            background-color: #16a34a !important;
            border-color: #16a34a !important;
        }

        .assess-btn-active-better:hover {
            background-color: #15803d !important;
            border-color: #15803d !important;
        }

        .assess-btn-active-same {
            background-color: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }

        .assess-btn-active-same:hover {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
        }

        .assess-btn-active-worse {
            background-color: #ef4444 !important;
            border-color: #ef4444 !important;
        }

        .assess-btn-active-worse:hover {
            background-color: #dc2626 !important;
            border-color: #dc2626 !important;
        }

        .assess-btn-inactive {
            background-color: #ffffff !important;
            color: #4b5563 !important;
            border-color: #d1d5db !important;
        }

        .assess-btn-inactive:hover {
            background-color: #f3f4f6 !important;
        }

        /* DTX Type Button Style (Avoid Tailwind dynamic class issues on mobile) */
        .dtx-btn-active {
            background-color: #2563eb !important;
            /* blue-600 */
            color: #ffffff !important;
            border-color: #2563eb !important;
        }

        .dtx-btn-active:hover {
            background-color: #1d4ed8 !important;
            /* blue-700 */
            border-color: #1d4ed8 !important;
        }

        .dtx-btn-inactive {
            background-color: #ffffff !important;
            color: #1e40af !important;
            /* blue-800 */
        }

        .dtx-btn-inactive:hover {
            background-color: #eff6ff !important;
            /* blue-50 */
        }

        /* DTX HI Button */
        .dtx-hi-active {
            background-color: #f97316 !important;
            /* orange-500 */
            color: #ffffff !important;
            border-color: #f97316 !important;
        }

        .dtx-hi-active:hover {
            background-color: #ea580c !important;
            /* orange-600 */
            border-color: #ea580c !important;
        }

        .dtx-hi-inactive {
            background-color: #ffffff !important;
            color: #9a3412 !important;
            /* orange-800 */
            border-color: #fed7aa !important;
            /* orange-200 */
        }

        .dtx-hi-inactive:hover {
            background-color: #fff7ed !important;
            /* orange-50 */
        }

        /* Chrome, Safari, Edge, Opera - Remove inner spin button for number inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Time input: hide native picker icon to keep UI consistent with our button */
        input[type="time"]::-webkit-calendar-picker-indicator {
            opacity: 0;
        }

        /* Icon buttons: ensure perfect centering */
        .icon-btn i {
            line-height: 1;
        }

        .tab-active {
            padding: 0.35rem 0.6rem;
            border-radius: 0.5rem;
            border-bottom: 2px solid #06c755;
            color: #06c755;
            font-weight: bold;
        }

        .tab-inactive {
            padding: 0.35rem 0.6rem;
            border-radius: 0.5rem;
            color: #374151;
        }

        #tabForm:hover,
        #tabText:hover {
            background-color: #e5e7eb;
        }

        /* Case Mode Toggle */
        .case-mode-btn {
            min-width: 8.5rem;
            padding: 0.55rem 0.9rem;
            border: 1px solid #d1d5db;
            font-weight: 700;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            line-height: 1.1;
            border-radius: 0.75rem;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .case-mode-btn:active {
            transform: translateY(1px);
        }

        .case-mode-inactive {
            background-color: #ffffff !important;
            color: #374151 !important;
            border-color: #d1d5db !important;
        }

        .case-mode-inactive:hover {
            background-color: #f3f4f6 !important;
        }

        .case-mode-active-existing {
            background-color: #2563eb !important;
            color: #ffffff !important;
            border-color: #2563eb !important;
            box-shadow: 0 10px 16px -12px rgba(37, 99, 235, 0.6);
        }

        .case-mode-active-new {
            background-color: #16a34a !important;
            color: #ffffff !important;
            border-color: #16a34a !important;
            box-shadow: 0 10px 16px -12px rgba(22, 163, 74, 0.6);
        }

        .case-mode-hint {
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .mode-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            box-shadow: 0 14px 36px -28px rgba(15, 23, 42, 0.35);
        }

        .mode-status-panel {
            display: flex;
            gap: 1.15rem;
            align-items: center;
            padding: 0;
            background-color: transparent;
            border: 0;
            width: 100%;
            justify-content: center;
        }

        .mode-status-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
            font-weight: 700;
            margin: 0;
        }

        .mode-status-content {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            align-items: center;
            text-align: center;
        }

        .mode-status-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
        }

        .mode-badge {
            --badge-bg: #dcfce7;
            --badge-border: #bbf7d0;
            --badge-text: #166534;
            --badge-dot: #166534;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.8rem;
            border-radius: 9999px;
            font-weight: 800;
            font-size: 0.95rem;
            border: 1px solid var(--badge-border);
            background: var(--badge-bg);
            color: var(--badge-text);
        }


        .mode-badge-existing {
            --badge-bg: #dcfce7;
            --badge-border: #bbf7d0;
            --badge-text: #166534;
            --badge-dot: #166534;
        }

        .mode-badge-new {
            --badge-bg: #fef3c7;
            --badge-border: #fcd34d;
            --badge-text: #b45309;
            --badge-dot: #b45309;
        }

        .mode-card-main {
            display: grid;
            gap: 1rem;
            align-items: center;
        }

        .mode-card-actions {
            display: grid;
            gap: 0.75rem;
            align-content: start;
            grid-template-columns: 1fr;
        }

        .mode-card-tips {
            border-top: 1px dashed #dbeafe;
            margin-top: 0.25rem;
            padding-top: 0.75rem;
        }

        .tips-toggle-btn {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            color: #1d4ed8;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .tips-toggle-btn:hover {
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.12);
        }

        .tips-toggle-btn:active {
            transform: translateY(1px);
        }

        .action-btn {
            width: 100%;
            min-width: 10rem;
            min-height: 3.6rem;
            padding: 0.85rem 1rem;
            border-radius: 1rem;
            font-weight: 800;
            letter-spacing: 0.2px;
            box-shadow: 0 12px 24px -18px rgba(15, 23, 42, 0.4);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .action-line {
            display: block;
            white-space: nowrap;
        }

        .action-btn::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0));
            opacity: 0.7;
            pointer-events: none;
        }

        .action-btn > * {
            position: relative;
            z-index: 1;
        }

        .action-btn:hover {
            box-shadow: 0 12px 24px -18px rgba(15, 23, 42, 0.45);
        }

        .action-btn:active {
            transform: translateY(1px);
        }

        .action-btn-line {
            background-color: #06c755;
            color: #0f172a;
            border: 1px solid #05a546;
        }

        .action-btn-line:hover {
            background-color: #05a546;
        }

        .action-btn-new {
            background-color: #fcd34d;
            color: #78350f;
            border: 1px solid #f59e0b;
        }

        .action-btn-new:hover {
            background-color: #fbbf24;
        }

        .action-btn-icon {
            width: 2.1rem;
            height: 2.1rem;
            border-radius: 0.75rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.32);
            border: 1px solid rgba(255, 255, 255, 0.45);
        }

        .meds-edit-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.55rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            background-color: #f8fafc;
            cursor: pointer;
            transition: background-color 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .meds-edit-row:hover {
            background-color: #f1f5f9;
        }

        .meds-edit-input {
            flex: 1;
            border: 0;
            background: transparent;
            font-size: 1rem;
            color: #0f172a;
        }

        .meds-edit-row.meds-edit-active {
            background-color: #fff7ed;
            border-color: #fdba74;
            box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.3);
        }

        .meds-edit-row.meds-edit-changed {
            background-color: #fef2f2;
            border-color: #fecaca;
        }

        .meds-edit-row.meds-edit-changed .meds-edit-input {
            color: #b91c1c;
            font-weight: 700;
        }

        .meds-edit-status {
            font-size: 0.75rem;
            font-weight: 700;
            color: #b91c1c;
            white-space: nowrap;
        }

        .meds-editor {
            min-height: 9rem;
            white-space: pre-wrap;
        }

        .meds-editor[contenteditable="false"] {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            cursor: not-allowed;
        }

        .meds-editor:empty::before {
            content: attr(data-placeholder);
            color: #9ca3af;
            white-space: pre-line;
            pointer-events: none;
        }

        .meds-inline-changed {
            color: #b91c1c;
            font-weight: 700;
        }

        @media (max-width: 640px) {
            .case-mode-btn {
                min-width: 6.5rem;
                font-size: 0.95rem;
                padding: 0.5rem 0.7rem;
            }

            .action-btn {
                min-width: 9.5rem;
            }
        }

        @media (min-width: 640px) {
            .mode-card-main {
                grid-template-columns: minmax(0, 0.55fr) minmax(0, 1.45fr);
            }

            .mode-card-actions {
                grid-template-columns: repeat(2, minmax(10rem, 1fr));
            }

            .mode-status-panel {
                justify-self: center;
            }
        }


        /* Animations */
        @keyframes pulse-once {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.95;
                transform: scale(0.99);
                background-color: #eff6ff;
            }

            /* Light blue flash */
        }

        .animate-pulse-once {
            animation: pulse-once 0.5s ease-in-out;
        }

        /* NEW: Error Visualization Styles */
        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        @keyframes scale-in {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-scale-in {
            animation: scale-in 0.2s ease-out forwards;
        }

        @keyframes fade-in-down {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-down {
            animation: fade-in-down 0.3s ease-out forwards;
        }

        .ring-error {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.6) !important;
            /* Red glow */
            border-color: #ef4444 !important;
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        :root {
            --placeholder-font-size: 1rem;
            --placeholder-line-height: 1.35;
        }

        input,
        textarea,
        select {
            line-height: 1.35;
        }

        /* ELDERLY FRIENDLY: High Contrast Placeholders */
        ::placeholder {
            color: #6b7280;
            /* Gray 500 - Darker than default */
            opacity: 1;
            /* Firefox */
            font-style: normal;
            font-size: var(--placeholder-font-size);
            line-height: var(--placeholder-line-height);
        }

        :-ms-input-placeholder {
            color: #6b7280;
            font-style: normal;
        }

        ::-ms-input-placeholder {
            color: #6b7280;
            font-style: normal;
        }

        @media (max-width: 640px) {
            :root {
                --placeholder-font-size: 0.9rem;
                --placeholder-line-height: 1.2;
            }
        }



        /* Accessibility: High Contrast Focus (Elderly Friendly) */
        input:focus,
        textarea:focus,
        select:focus,
        button:focus-visible {
            outline: 2px solid #06c755 !important;
            /* LINE green */
            outline-offset: 2px !important;
            box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.2) !important;
            border-color: #05a546 !important;
        }

        /* Enforce larger text for labels via utility class override if needed, 
           but we changed HTML classes directly. Adding helper just in case. */
        .text-base-force {
            font-size: 1.05rem !important;
            line-height: 1.6;
        }

        @media (prefers-reduced-motion: reduce) {
            .animate-pulse-once {
                animation: none !important;
            }

            .ring-error {
                animation: none !important;
            }
        }

        .report-tab {
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            border: 1px solid #bfdbfe;
            font-weight: 700;
            font-size: 0.9rem;
            transition: background-color 0.15s ease, color 0.15s ease;
        }

        .report-tab-active {
            background-color: #2563eb;
            border-color: #2563eb;
            color: #ffffff;
        }

        .report-tab-inactive {
            background-color: #ffffff;
            color: #1d4ed8;
        }

        .report-tab-inactive:hover {
            background-color: #eff6ff;
        }

        .report-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.7rem 0.8rem;
            background-color: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .report-sparkline {
            width: 100%;
            height: 36px;
        }
    </style>
</head>

<body class="p-4 md:p-8 min-h-screen">

    <!-- Hidden Date Picker Helper -->
    <input type="date" id="hiddenDatePicker" class="hidden" onchange="applyDateSelection()">
    <input type="hidden" id="dateTargetId">

    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden relative">
        <!-- Header -->
        <div class="bg-line-green p-4 text-white flex flex-wrap justify-between items-center gap-2">
            <h1 class="text-xl font-bold"><i class="fas fa-notes-medical mr-2"></i>รายงานคนไข้ Home Ward</h1>

            <div class="flex flex-wrap gap-2 items-center">
                <!-- Font Size Controls (Easy Access) -->
                <div class="bg-white/95 text-gray-900 rounded-lg p-0.5 flex items-center gap-1 shadow">
                    <button type="button" onclick="stepFontSize(-1)"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-900 font-bold text-base w-12 h-10 rounded-lg border border-gray-300 flex items-center justify-center"
                        aria-label="ลดขนาดตัวอักษร">A-</button>
                    <button type="button" onclick="resetFontSize()"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-900 font-bold text-base w-12 h-10 rounded-lg border border-gray-300 flex items-center justify-center"
                        aria-label="รีเซ็ตขนาดตัวอักษร">
                        <span id="fontSizeLabel">16</span>
                    </button>
                    <button type="button" onclick="stepFontSize(1)"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-900 font-bold text-base w-12 h-10 rounded-lg border border-gray-300 flex items-center justify-center"
                        aria-label="เพิ่มขนาดตัวอักษร">A+</button>
                </div>
            </div>
        </div>

        <div class="p-6 space-y-6">
            <!-- Case Mode Toggle + Tips (Clear, Low Learning Curve) -->
            <div class="mode-card p-4">
                <div class="flex flex-col gap-3">
                    <div class="mode-card-main">
                        <div class="mode-status-panel">
                            <button type="button" id="tipsToggleBtn" onclick="toggleTipsDetail()"
                                class="tips-toggle-btn bg-white border border-gray-200 text-blue-700 flex-shrink-0"
                                aria-label="แสดงวิธีใช้" aria-pressed="false" aria-expanded="false"
                                aria-controls="tipsContainer">
                                <i class="fas fa-lightbulb"></i>
                            </button>
                            <div class="mode-status-content">
                                <p class="mode-status-label">โหมดปัจจุบัน</p>
                                <div class="mode-status-row">
                                    <span id="caseModeBadge" class="mode-badge mode-badge-existing">เคสเดิม</span>
                                </div>
                            </div>
                        </div>
                        <div class="mode-card-actions">
                            <button onclick="openImportExistingCase()"
                                class="action-btn action-btn-line text-base flex items-center justify-center gap-3">
                                <i class="fas fa-file-import action-btn-icon"></i>
                                <span class="leading-tight text-center">
                                    <span class="action-line">เคสเดิม</span>
                                    <span class="action-line">นำเข้าจาก LINE</span>
                                </span>
                            </button>
                            <button onclick="openResetConfirmation()"
                                class="action-btn action-btn-new text-base flex items-center justify-center gap-3">
                                <i class="fas fa-user-plus action-btn-icon"></i>
                                <span class="leading-tight text-center">
                                    <span class="action-line">เริ่มเคสใหม่</span>
                                    <span class="action-line">(ล้างข้อมูลเดิม)</span>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div id="tipsContainer" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mode-card-tips">
                        <p id="tipsTitle" class="text-base font-bold text-gray-900">วิธีใช้ (เคสเดิม)</p>
                        <ol id="tipsExisting" class="mt-2 list-decimal list-inside space-y-1 text-base text-gray-900">
                            <li><span class="font-bold">กด</span> ปุ่ม <span
                                    class="font-bold text-blue-700">เคสเดิม: นำเข้าจาก LINE</span> แล้ววางข้อความ</li>
                            <li><span class="font-bold">ตรวจ</span> ชื่อ อายุ Dx/ข้อบ่งชี้ วัน Admit และ Allergy</li>
                            <li><span class="font-bold">เลือก</span> วันและเวลา กรอก S/O/A/P</li>
                            <li><span class="font-bold">ถ้ามีปรับยา</span> ให้ติ๊ก <span
                                    class="font-bold">มีการปรับยาในครั้งนี้</span> เพื่อเปิดแก้ไขรายการยา (บรรทัดที่แก้จะเป็นสีแดง)</li>
                            <li><span class="font-bold">แก้</span> เฉพาะบรรทัดที่เปลี่ยน ถ้าไม่ปรับยาให้กด
                                <span class="font-bold">ยกเลิกการปรับยา</span></li>
                            <li><span class="font-bold">ตรวจ</span> รายการยาและวันที่ปรับยาล่าสุด แล้วติ๊ก <span
                                    class="font-bold">รายการยาเป็นปัจจุบัน</span> กด <span
                                    class="font-bold">สร้างข้อความ</span></li>
                        </ol>
                        <ol id="tipsNew" class="hidden mt-2 list-decimal list-inside space-y-1 text-base text-gray-900">
                            <li><span class="font-bold">กด</span> ปุ่ม <span
                                    class="font-bold text-green-700">เริ่มเคสใหม่</span></li>
                            <li><span class="font-bold">กรอก</span> ชื่อ อายุ Dx/ข้อบ่งชี้ วัน Admit และ Allergy</li>
                            <li><span class="font-bold">กรอก</span> ข้อมูลแรกรับจาก OPD + แผนแรกรับ</li>
                            <li><span class="font-bold">ถ้ามียาต่อเนื่อง</span> ให้กด <span
                                    class="font-bold">คัดลอกไปรายการยาปัจจุบัน</span> (หรือ <span
                                    class="font-bold">คัดลอกจากยาต่อเนื่อง</span>)</li>
                            <li><span class="font-bold">ตรวจ</span> รายการยาปัจจุบันและวันที่ปรับยาล่าสุด</li>
                            <li><span class="font-bold">เลือก</span> วันและเวลา กรอก S/O/A/P</li>
                            <li><span class="font-bold">ติ๊ก</span> ยืนยันว่า “รายการยาเป็นปัจจุบัน” แล้วกด <span
                                    class="font-bold">สร้างข้อความ</span></li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Section 1: Fixed Info -->
            <div id="headerSection" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="flex flex-wrap justify-between items-center gap-2 mb-2 border-b border-gray-200 pb-2">
                    <label class="block text-gray-700 font-bold text-lg"><i class="fas fa-user-injured mr-1"></i>
                        ข้อมูลคนไข้พื้นฐาน</label>
                    <div class="flex flex-wrap items-center gap-3 text-base">
                        <div class="flex space-x-3">
                            <button onclick="switchHeaderView('form')" id="tabForm"
                                class="tab-active pb-1">กรอกทีละช่อง</button>
                            <button onclick="switchHeaderView('text')" id="tabText"
                                class="tab-inactive pb-1 hidden">แก้ไขข้อความรวม</button>
                        </div>
                        <button type="button" id="advancedModeToggle" onclick="toggleAdvancedMode()"
                            class="text-sm font-bold bg-gray-100 border border-gray-300 text-gray-700 px-3 py-2 rounded-full hover:bg-gray-200 transition flex items-center gap-2"
                            aria-pressed="false">
                            <i class="fas fa-sliders"></i> โหมดขั้นสูง: ปิด
                        </button>
                        <button type="button" id="headerSaveHideBtn" onclick="saveHeaderAndHide()"
                            class="text-sm font-bold bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded-full hover:bg-blue-100 transition flex items-center gap-2">
                            <i class="fas fa-save"></i> บันทึกและซ่อน
                        </button>
                    </div>
                </div>

                <!-- Form View -->
                <div id="headerFormView" class="space-y-3">
                    <div class="grid grid-cols-6 gap-3">
                        <div class="col-span-4">
                            <label class="block text-base text-gray-800 font-semibold">ชื่อ-นามสกุล</label>
                            <input type="text" id="pFName"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base"
                                placeholder="นางสมศรี ดีใจ" oninput="updateHeaderFromForm()">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-base text-gray-800 font-semibold">อายุ (ปี)</label>
                            <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="pAge"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base"
                                placeholder="75" oninput="updateHeaderFromForm()">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-base text-gray-800 font-semibold">การวินิจฉัย (Dx)</label>
                            <input type="text" id="pDx"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base"
                                placeholder="DM" oninput="updateHeaderFromForm()">
                        </div>
                        <div>
                            <label class="block text-base text-gray-800 font-semibold">ข้อบ่งชี้</label>
                            <input type="text" id="pIndication"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base"
                                placeholder="HbA1c 11.2" oninput="updateHeaderFromForm()">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-base text-gray-800 font-semibold">วันที่รับ Admit</label>
                            <div class="flex relative">
                                <input type="text" id="pAdmitDate"
                                    class="w-full border border-gray-300 rounded-l-lg px-3 py-2 h-11 text-base"
                                    placeholder="17 ธ.ค. 68" oninput="updateHeaderFromForm()">
                                <!-- Date Picker Trigger -->
                                <div class="relative">
                                    <button type="button"
                                        class="icon-btn bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg w-14 h-11 hover:bg-gray-200 text-gray-700 flex items-center justify-center">
                                        <i class="far fa-calendar-alt"></i>
                                    </button>
                                    <input type="date" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer"
                                        onchange="handleDateChange(this, 'pAdmitDate')">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-base text-red-700 font-semibold">ประวัติการแพ้ยา (Allergy) <span
                                class="text-red-700">*</span></label>
                        <input type="text" id="pAllergy"
                            class="w-full border border-red-300 bg-red-50 rounded-lg px-3 py-2 h-11 text-base text-red-900 placeholder-red-400"
                            placeholder="แพ้ Penicillin (ลมพิษ) หรือ ปฏิเสธ/ไม่มี" oninput="updateHeaderFromForm()">
                        <p id="allergyError" class="hidden mt-2 text-sm text-red-800 font-semibold" role="alert">
                            กรุณาระบุประวัติการแพ้ยา หากไม่มีให้พิมพ์ “ปฏิเสธ” หรือ “-”
                        </p>
                    </div>
                    <div>
                        <label class="block text-base text-gray-800 font-semibold">หมายเหตุ</label>
                        <textarea id="pNote" rows="2"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-base"
                            placeholder="เช่น ไม่มีโทรศัพท์ อสม. ให้วัดความดันส่ง" oninput="updateHeaderFromForm()"></textarea>
                    </div>
                </div>

                <!-- Text View -->
                <div id="headerTextView" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-2 flex flex-col gap-2">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-magic text-blue-500 mt-1"></i>
                            <div>
                                <p class="text-sm text-blue-900 font-bold">ระบบซ่อมแซมอัตโนมัติ (Smart Repair):</p>
                                <p class="text-sm text-blue-900">แก้ไขข้อความได้ตามสบาย
                                    ระบบจะพยายามจับคู่ข้อมูลให้ถูกต้องเมื่อสลับกลับไปหน้าฟอร์ม
                                    (แนะนำให้คงลำดับบรรทัดไว้: ชื่อ > โรค > วันที่ > ยา)</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="restoreTemplate()"
                                class="text-sm bg-white border border-blue-300 text-blue-800 px-3 py-2 rounded-lg hover:bg-blue-50 shadow-sm flex items-center">
                                <i class="fas fa-undo-alt mr-1"></i> คืนค่าโครงร่าง (Restore Template)
                            </button>
                        </div>
                    </div>
                    <textarea id="headerPart"
                        class="w-full h-64 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-base font-mono"
                        spellcheck="false" placeholder="พิมพ์ข้อมูลที่นี่..."></textarea>
                </div>
            </div>

            <div id="headerHiddenNotice"
                class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="text-blue-900">
                    <div class="flex items-center gap-2 font-bold text-base">
                        <i class="fas fa-eye-slash"></i>
                        <span>ซ่อนข้อมูลคนไข้พื้นฐานแล้ว</span>
                    </div>
                    <p class="text-sm text-blue-800">เพื่อป้องกันการแก้ไขข้อมูลเดิม หากต้องการตรวจหรือแก้ไขให้กดปุ่ม</p>
                </div>
                <button type="button" onclick="revealHeaderSectionForEdit()"
                    class="text-sm font-bold bg-white border border-blue-200 text-blue-800 px-4 py-2 rounded-full hover:bg-blue-100 transition flex items-center gap-2">
                    <i class="fas fa-user-edit"></i> แก้ไขข้อมูลคนไข้
                </button>
            </div>

            <!-- Admit (OPD Card) -->
            <div id="admitSection" class="hidden bg-amber-50 p-4 rounded-lg border border-amber-200 shadow-sm">
                <div class="flex items-center justify-between mb-2 border-b border-amber-200 pb-2">
                    <label class="block text-amber-900 font-bold text-lg"><i class="fas fa-hospital mr-1"></i>
                        ข้อมูลแรกรับจาก OPD (OPD card)</label>
                </div>

                <input type="hidden" id="isAdmitMode" value="false">

                <div class="space-y-4 mt-3">
                    <!-- Admit Fields -->
                    <div id="admitFields_container"
                        class="hidden space-y-3 bg-amber-50 p-3 rounded border border-amber-200 border-l-4 border-l-amber-600 relative">
                        <div
                            class="absolute -top-3 left-3 bg-amber-100 text-amber-900 text-sm font-bold px-2 py-1 rounded border border-amber-200">
                            ข้อมูลประวัติแรกรับ (Admission Note)
                        </div>
                        <div class="mt-2">
                            <label class="block text-base font-bold text-gray-800">CC (อาการสำคัญ)</label>
                            <input type="text" id="inputCC"
                                class="block w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base focus:ring-amber-200 focus:border-amber-400"
                                placeholder="ตัวอย่าง: น้ำตาลสูง, หายใจเหนื่อย, ปวดท้อง, แผลติดเชื้อ"
                                oninput="updateHeaderFromForm()">
                        </div>
                        <div>
                            <label class="block text-base font-bold text-gray-800">HPI (อาการปัจจุบัน)</label>
                            <textarea id="inputHPI" rows="2"
                                class="block w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-amber-200 focus:border-amber-400"
                                placeholder="ตัวอย่าง: 2 วันก่อนมีไข้ ไอมากขึ้น วันนี้เหนื่อย"
                                oninput="updateHeaderFromForm()"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-base font-bold text-gray-800">PH (ความเจ็บป่วยก่อนหน้า)</label>
                                <textarea id="inputPMH" rows="2"
                                    class="block w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-amber-200 focus:border-amber-400"
                                    placeholder="ตัวอย่าง: U/D, ประวัติการผ่าตัด, โรคประจำตัว"
                                    oninput="updateHeaderFromForm()"></textarea>
                            </div>
                            <div>
                                <label class="block text-base font-bold text-gray-800">FHx (ประวัติครอบครัว)</label>
                                <textarea id="inputFHx" rows="2"
                                    class="block w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-amber-200 focus:border-amber-400"
                                    placeholder="ตัวอย่าง: พ่อ/แม่เป็น DM, HT, หัวใจ"
                                    oninput="updateHeaderFromForm()"></textarea>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 text-right">*ข้อมูลแพ้ยาจะดึงมาจากส่วนที่ 1 (Header)
                            โดยอัตโนมัติ</p>
                    </div>

                    <!-- Admit Plan -->
                    <div id="admitPlan_container"
                        class="hidden space-y-3 bg-amber-50 p-3 rounded border border-amber-200 border-l-4 border-l-amber-600 relative">
                        <div
                            class="absolute -top-3 right-3 bg-amber-100 text-amber-900 text-sm font-bold px-2 py-1 rounded border border-amber-200">
                            แผนการรักษาแรกรับ (Admission Orders)
                        </div>

                        <div>
                            <label class="block text-base font-bold text-amber-900 mb-1"><i
                                    class="fas fa-hourglass-half mr-1"></i> คำสั่งวันเดียว (One Day Order)</label>
                        <textarea id="inputOneDay_Admit" rows="3"
                            class="w-full border border-amber-200 rounded-lg p-3 text-base font-mono focus:ring-amber-200 focus:border-amber-500"
                            placeholder="NSS 1000 ml IV 80 ml/hr..." data-autobullet="true"
                            onfocus="seedBulletOnFocus(event)" onkeydown="handleBulletKeydown(event)"></textarea>
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="block text-base font-bold text-amber-900"><i
                                        class="fas fa-sync-alt mr-1"></i> ยาต่อเนื่อง (Continuous Order)</label>
                                <button onclick="copyAdmitMedsToHeader()"
                                    class="text-sm bg-amber-100 text-amber-900 border border-amber-200 px-3 py-2 rounded-lg hover:bg-amber-200 transition flex items-center gap-2">
                                    <i class="fas fa-arrow-up"></i> คัดลอกไปรายการยาปัจจุบัน
                                </button>
                            </div>
                            <textarea id="inputCont_Admit" rows="4"
                                class="w-full border border-amber-200 rounded-lg p-3 text-base font-mono focus:ring-amber-200 focus:border-amber-500"
                                placeholder="DTX premeal ช ย&#10;Novomix 18-0-8 sc ac ช ย #1&#10;Simvastatin (20) 1x1 o hs #30"
                                data-autobullet="true" onfocus="seedBulletOnFocus(event)"
                                onkeydown="handleBulletKeydown(event)"></textarea>
                            <p class="text-sm text-gray-700 mt-1">*พิมพ์คำสั่งยาที่นี่
                                แล้วกดปุ่มด้านบนเพื่ออัปเดตรายการยาใน Header</p>
                        </div>

                        <div>
                            <label class="block text-base font-bold text-gray-800 mb-1"><i
                                    class="fas fa-user-md mr-1"></i> แผนแรกรับ (Plan/Management)</label>
                            <p
                                class="text-sm text-amber-900 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 mb-2">
                                ใช้เฉพาะตอนแรกรับ (Admit) หากเป็นบันทึกรายวันให้ปิดโหมดแรกรับก่อน
                            </p>
                            <textarea id="inputPlanMx_Admit" rows="3"
                                class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-gray-200 focus:border-gray-500"
                                placeholder="- Admit ward...
- Consult..." data-autobullet="true" onfocus="seedBulletOnFocus(event)"
                                onkeydown="handleBulletKeydown(event)" oninput="updateAdmissionSummary()"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Previous Logs -->
            <div id="historyContainer" class="bg-gray-50 p-4 rounded-lg border border-gray-200 hidden">
                <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-3">
                    <label class="block text-gray-700 font-bold text-lg"><i class="fas fa-history mr-1"></i>
                        ประวัติอาการเดิม</label>
                    <!-- Lock Toggle Button -->
                    <button onclick="toggleHistoryLock()" id="btnHistoryLock"
                        class="text-sm font-bold bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-full transition flex items-center gap-2 shadow-sm border border-gray-300">
                        <i class="fas fa-lock text-xs"></i> ล็อก
                    </button>
                    <button type="button" onclick="openHistoryReport()" id="btnHistoryReport"
                        class="text-sm font-bold bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-full transition flex items-center gap-2 shadow-sm border border-blue-200">
                        <i class="fas fa-file-medical text-xs"></i> รายงาน
                    </button>
                </div>
                <button onclick="toggleHistory()"
                    class="text-sm text-blue-700 underline px-2 py-1 rounded hover:bg-blue-50">ซ่อน</button>
            </div>
                <div id="admissionSummary" class="hidden mb-3 rounded-lg border border-blue-100 bg-white p-3">
                    <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
                        <div class="flex items-center gap-2 text-blue-800 font-bold text-sm">
                            <i class="fas fa-clipboard-list"></i>
                            <span>ข้อมูลแรกรับ (ย่อ)</span>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <button type="button" id="admissionSummaryToggle" onclick="toggleAdmissionSummaryDetails()"
                                class="text-xs font-bold text-blue-700 border border-blue-200 bg-blue-50 px-2.5 py-1 rounded-md hover:bg-blue-100 transition"
                                aria-expanded="false" aria-controls="admissionSummaryDetails">
                                ดูรายละเอียดแรกรับ
                            </button>
                            <div
                                class="inline-flex items-center gap-1.5 rounded-full bg-emerald-50 text-emerald-800 border border-emerald-200 px-2.5 py-1 text-xs font-bold">
                                <i class="fas fa-hourglass-half text-emerald-600"></i>
                                <span>LoS</span>
                                <span id="admissionSummaryLos"
                                    class="admission-summary-value text-emerald-900 font-bold">...</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-base text-gray-800">
                        <div class="flex items-baseline gap-2"><span class="font-semibold text-gray-700">ชื่อ:</span>
                            <span id="admissionSummaryName"
                                class="admission-summary-value text-gray-900 font-bold">...</span>
                        </div>
                        <div class="flex items-baseline gap-2"><span class="font-semibold text-gray-700">Dx:</span>
                            <span id="admissionSummaryDx"
                                class="admission-summary-value text-gray-900 font-bold">...</span>
                        </div>
                        <div class="flex items-baseline gap-2"><span class="font-semibold text-gray-700">Admit:</span>
                            <span id="admissionSummaryAdmit"
                                class="admission-summary-value text-gray-900 font-bold">...</span>
                        </div>
                        <div class="flex items-baseline gap-2"><span class="font-semibold text-gray-700">Allergy:</span>
                            <span id="admissionSummaryAllergy"
                                class="admission-summary-value text-gray-900 font-bold">...</span>
                        </div>
                    </div>
                    <div class="mt-3 border-t border-amber-100 pt-2">
                        <div class="flex items-center gap-2 text-amber-900 font-bold text-sm mb-1">
                            <i class="fas fa-clipboard-check"></i>
                            <span>แผนแรกรับ</span>
                        </div>
                        <div id="admissionPlanSummaryText"
                            class="whitespace-pre-line text-sm text-amber-900 font-semibold">ยังไม่ได้กรอก</div>
                    </div>
                    <div id="admissionSummaryNoteRow" class="hidden mt-3 border-t border-blue-100 pt-2">
                        <div class="text-sm font-bold text-blue-900 mb-1">หมายเหตุ</div>
                        <div id="admissionSummaryNote"
                            class="whitespace-pre-line text-sm text-blue-900 font-semibold"></div>
                    </div>
                    <div id="admissionSummaryDetails"
                        class="hidden mt-3 border-t border-gray-100 pt-2 text-sm text-gray-700 space-y-1">
                        <div><span class="font-semibold text-gray-900">CC:</span> <span id="admissionSummaryCc">...</span>
                        </div>
                        <div><span class="font-semibold text-gray-900">HPI:</span> <span id="admissionSummaryHpi">...</span>
                        </div>
                        <div><span class="font-semibold text-gray-900">PH:</span> <span id="admissionSummaryPmh">...</span>
                        </div>
                        <div><span class="font-semibold text-gray-900">FHx:</span> <span id="admissionSummaryFhx">...</span>
                        </div>
                    </div>
                </div>
                <!-- Default State: Readonly & Gray Background -->
                <textarea id="historyPart" readonly
                    class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-base font-mono bg-gray-100 text-gray-600 cursor-not-allowed transition-colors duration-200"
                    placeholder="ประวัติเก่าจะปรากฏที่นี่ (ปลดล็อกเพื่อแก้ไข)..."></textarea>
            </div>

            <div id="showHistoryBtn" class="text-center hidden">
                <button onclick="toggleHistory()"
                    class="text-base text-gray-700 hover:text-gray-900 underline border border-dashed border-gray-300 px-5 py-2 rounded-full bg-white">
                    <i class="fas fa-plus-circle mr-1"></i> แสดงประวัติอาการเดิม
                </button>
            </div>

            <!-- Section 3: New Entry -->
            <div id="dailyEntrySection" class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm relative">
                <div class="flex justify-between items-center mb-4">
                    <label class="block text-blue-800 font-bold text-lg"><i class="fas fa-edit mr-1"></i>
                        บันทึกอาการวันนี้ (Progress note)</label>
                    <button onclick="openClearFormConfirmation()"
                        class="text-sm text-blue-700 hover:text-blue-900 underline px-2 py-1 rounded hover:bg-blue-100">ล้างฟอร์มวันนี้</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-base font-semibold text-gray-800 mb-1">วันที่</label>
                        <div class="flex relative">
                                <input type="text" id="logDate"
                                    class="block w-full border border-gray-300 rounded-l-lg shadow-sm px-3 py-2 h-11 text-base text-center font-bold text-gray-800"
                                    oninput="updateAdmissionSummary()">
                            <div class="relative">
                                <button type="button"
                                    class="icon-btn bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg w-14 h-11 hover:bg-gray-200 text-gray-700 shadow-sm flex items-center justify-center"
                                    aria-label="เลือกวันที่">
                                    <i class="far fa-calendar-alt"></i>
                                </button>
                                <input type="date" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer"
                                    onchange="handleDateChange(this, 'logDate')">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-base font-semibold text-gray-800 mb-1">เวลา <span
                                class="text-red-700 text-sm">(ต้องเลือก)</span></label>
                        <div id="timePickerGroup" class="flex flex-col gap-2">
                            <div class="flex relative">
                                <input type="time" id="logTime"
                                    class="block w-full border border-gray-300 rounded-l-lg shadow-sm px-3 py-2 h-11 text-base text-center font-bold text-gray-800"
                                    aria-label="เวลาในการบันทึก">
                                <button type="button" onclick="openTimePicker('logTime')"
                                    class="icon-btn bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg w-14 h-11 hover:bg-gray-200 text-gray-700 shadow-sm flex items-center justify-center"
                                    aria-label="เลือกเวลา">
                                    <i class="far fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">

                    <!-- Standard S (Always Visible) -->
                    <div id="standardS_container">
                        <label class="block text-base font-bold text-blue-600 mb-1">S (Subjective -
                            อาการปัจจุบัน):</label>
                        <input type="text" id="inputS"
                            class="block w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 h-11 text-base"
                            placeholder="อาการที่คนไข้บอกขณะนี้ หรือ Notify Ward เช่น รู้สึกตัวดี, บ่นปวดแผล">
                    </div>

                    <!-- V/S Helper (Restored White Wrapper, Label Outside) -->
                    <div>
                        <label class="block text-base font-bold text-blue-600 mb-1">O (Objective -
                            ข้อมูลตรวจร่างกาย):</label>

                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
                                <!-- BT: Orange -->
                                <div class="relative">
                                    <label class="block text-base text-center font-bold text-orange-700 mb-1">
                                        <i class="fas fa-thermometer-half mr-1"></i>BT<br>
                                        <span class="text-sm text-gray-700 font-normal">อุณหภูมิ</span>
                                    </label>
                                    <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                        data-numeric="decimal1" id="valT"
                                        class="w-full border-2 border-orange-100 focus:border-orange-500 rounded-lg h-11 p-2 text-base text-center bg-white focus:ring-2 focus:ring-orange-200">
                                </div>
                                <!-- PR: Red -->
                                <div class="relative">
                                    <label class="block text-base text-center font-bold text-red-700 mb-1">
                                        <i class="fas fa-heartbeat mr-1"></i>PR<br>
                                        <span class="text-sm text-gray-700 font-normal">ชีพจร</span>
                                    </label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valP"
                                        class="w-full border-2 border-red-100 focus:border-red-500 rounded-lg h-11 p-2 text-base text-center bg-white focus:ring-2 focus:ring-red-200">
                                </div>
                                <!-- RR: Blue -->
                                <div class="relative">
                                    <label class="block text-base text-center font-bold text-cyan-700 mb-1">
                                        <i class="fas fa-lungs mr-1"></i>RR<br>
                                        <span class="text-sm text-gray-700 font-normal">หายใจ</span>
                                    </label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valR"
                                        class="w-full border-2 border-cyan-100 focus:border-cyan-500 rounded-lg h-11 p-2 text-base text-center bg-white focus:ring-2 focus:ring-cyan-200">
                                </div>
                                <!-- BP: Purple -->
                                <div>
                                    <label class="block text-base text-center font-bold text-indigo-700 mb-1">
                                        <i class="fas fa-tachometer-alt mr-1"></i>BP<br>
                                        <span class="text-sm text-gray-700 font-normal">ความดัน</span>
                                    </label>
                                    <div class="relative">
                                        <input type="text" id="valBP"
                                            class="w-full border-2 border-indigo-100 focus:border-indigo-500 rounded-lg h-11 p-2 pr-12 text-base text-center bg-white focus:ring-2 focus:ring-indigo-200"
                                            oninput="updateBpCountBadge()">
                                        <button type="button" onclick="openBpModal()"
                                            class="absolute right-1 top-1/2 -translate-y-1/2 w-9 h-9 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-900 hover:bg-indigo-100 flex items-center justify-center shadow-sm"
                                            aria-label="บันทึก BP หลายค่า">
                                            <i class="fas fa-plus"></i>
                                            <span id="bpCountBadge"
                                                class="hidden absolute -top-2 -right-2 bg-indigo-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">2</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3 pt-2 border-t border-dashed border-gray-200">
                                <!-- Updated DTX Section (Clean Design - No Box) -->
                                <div class="relative flex h-full flex-col">
                                    <label class="block text-base font-bold text-blue-700 mb-1">ค่า DTX (mg%)</label>
                                    <div class="flex items-center gap-2 mb-2">
                                        <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int"
                                            id="valDTX"
                                            class="flex-1 border-2 border-blue-100 focus:border-blue-500 rounded-lg h-11 p-2 text-base text-center placeholder-blue-400"
                                            placeholder="ระบุค่า">
                                        <button type="button" id="btnDtxHi" onclick="toggleDtxHi()"
                                            class="h-11 px-3 text-sm font-bold border rounded-lg dtx-hi-inactive"
                                            aria-pressed="false">
                                            HI
                                        </button>
                                    </div>

                                    <div class="mt-auto flex flex-col gap-2">
                                        <!-- Buttons -->
                                        <div class="flex shadow-sm rounded-md" role="group" id="dtxTypeButtonGroup"
                                            aria-label="เลือกช่วงเวลาเจาะ DTX">
                                            <button type="button" onclick="setDtxType('AC')" id="btnDtxAC"
                                                class="flex-1 px-2 py-2 text-base font-bold border border-blue-300 rounded-l focus:z-10 dtx-btn-inactive flex flex-col items-center justify-center gap-1 leading-none">
                                                <i class="fas fa-utensils text-base"></i>
                                                <span class="text-sm">ก่อนอาหาร</span>
                                            </button>
                                            <button type="button" onclick="setDtxType('PC')" id="btnDtxPC"
                                                class="flex-1 px-2 py-2 text-base font-bold border-t border-b border-r border-blue-300 focus:z-10 dtx-btn-inactive flex flex-col items-center justify-center gap-1 leading-none">
                                                <i class="fas fa-clock text-base"></i>
                                                <span class="text-sm">หลังอาหาร</span>
                                            </button>
                                            <button type="button" onclick="setDtxType('R')" id="btnDtxR"
                                                class="flex-1 px-2 py-2 text-base font-bold border border-blue-300 rounded-r focus:z-10 dtx-btn-inactive flex flex-col items-center justify-center gap-1 leading-none">
                                                <i class="fas fa-random text-base"></i>
                                                <span class="text-sm">สุ่ม</span>
                                            </button>
                                        </div>
                                        <input type="hidden" id="dtxType" value="">

                                        <!-- Hidden Time Input (Conditional) -->
                                        <div id="dtxTimeContainer" class="hidden relative animate-fade-in-down">
                                            <label class="block text-sm text-gray-600 mb-1 ml-1 font-bold">
                                                <i class="fas fa-stopwatch text-blue-500 mr-1"></i>ก่อน/หลังอาหารกี่ชั่วโมง
                                            </label>
                                            <div class="relative">
                                                <input type="text" inputmode="numeric" pattern="[0-9]*"
                                                    data-numeric="int" id="valDTX_Hr"
                                                    class="w-full border border-gray-300 rounded-lg h-11 p-2 pr-10 text-base text-center bg-blue-50 focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
                                                    placeholder="เช่น 2">
                                                <span
                                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">ชม.</span>
                                            </div>
                                        </div>

                                        <p id="dtxTypeError" class="hidden mt-2 text-sm text-red-800 font-semibold"
                                            role="alert">
                                            กรุณาเลือกช่วงเวลาเจาะ DTX
                                        </p>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-3">
                                    <div>
                                        <label class="block text-base text-gray-800 font-bold mb-1">SpO2</label>
                                        <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int"
                                            id="valSpO2"
                                            class="w-full border border-gray-300 rounded-lg h-11 p-2 text-base text-center bg-white"
                                            placeholder="%">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-base text-gray-800 text-center">ปัสสาวะ</label>
                                            <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int"
                                                id="valUrine"
                                                class="w-full border border-gray-300 rounded-lg h-11 p-2 text-base text-center bg-white"
                                                placeholder="ครั้ง">
                                        </div>
                                        <div>
                                            <label class="block text-base text-gray-800 text-center">ถ่าย</label>
                                            <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int"
                                                id="valStool"
                                                class="w-full border border-gray-300 rounded-lg h-11 p-2 text-base text-center bg-white"
                                                placeholder="ครั้ง">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-gray-100 pt-2 mt-2">
                                <div class="flex flex-wrap items-center justify-between gap-2 mb-1">
                                    <label class="block text-base text-gray-800">ข้อมูล O อื่นๆ</label>
                                    <div class="flex flex-wrap items-center gap-2">
                                        <button type="button" onclick="openLabModal()"
                                            class="text-sm bg-blue-50 text-blue-800 border border-blue-200 px-3 py-2 rounded-lg hover:bg-blue-100 transition flex items-center gap-2">
                                            <i class="fas fa-flask"></i> กรอก Lab
                                        </button>
                                        <button type="button" onclick="openPsychModal()"
                                            class="text-sm bg-amber-50 text-amber-800 border border-amber-200 px-3 py-2 rounded-lg hover:bg-amber-100 transition flex items-center gap-2">
                                            <i class="fas fa-brain"></i> กรอก Psych
                                        </button>
                                    </div>
                                </div>
                                <textarea id="inputO_Extra" rows="2"
                                    class="w-full border border-gray-300 rounded-lg p-3 text-base bg-gray-50"
                                    placeholder="ผล Lab หรืออื่นๆ..." data-autobullet="true"
                                    onfocus="seedBulletOnFocus(event)" onkeydown="handleBulletKeydown(event)"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- A (Assessment) Section -->
                    <div>
                        <label class="block text-base font-bold text-blue-600 mb-1">A (Assessment -
                            ประเมินอาการ):</label>
                        <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm mb-3">
                            <div class="flex shadow-sm rounded-md" role="group" id="assessmentButtonGroup"
                                aria-label="เลือก Assessment">
                                <button type="button" onclick="setAssessmentStatus('ดีขึ้น')" id="btnAssessBetter"
                                    aria-pressed="false"
                                    class="flex-1 px-3 py-3 text-base font-bold border rounded-l focus:z-10 assess-btn-inactive">ดีขึ้น</button>
                                <button type="button" onclick="setAssessmentStatus('พอเดิม')" id="btnAssessSame"
                                    aria-pressed="false"
                                    class="flex-1 px-3 py-3 text-base font-bold border-t border-b border-r focus:z-10 assess-btn-inactive">พอเดิม</button>
                                <button type="button" onclick="setAssessmentStatus('แย่ลง')" id="btnAssessWorse"
                                    aria-pressed="false"
                                    class="flex-1 px-3 py-3 text-base font-bold border rounded-r focus:z-10 assess-btn-inactive">แย่ลง</button>
                            </div>
                            <input type="hidden" id="assessmentStatus" value="">

                            <div class="mt-2 flex flex-wrap items-center gap-4">
                                <label class="flex items-center gap-2 text-sm font-bold text-gray-800 cursor-pointer select-none">
                                    <input type="checkbox" id="assessmentWatch"
                                        class="w-6 h-6 text-amber-600 rounded focus:ring-amber-500 border-gray-300">
                                    เฝ้าดูอาการใกล้ชิด
                                </label>
                                <label class="flex items-center gap-2 text-sm font-bold text-gray-800 cursor-pointer select-none">
                                    <input type="checkbox" id="assessmentRisk"
                                        class="w-6 h-6 text-red-600 rounded focus:ring-red-500 border-gray-300">
                                    เสี่ยงเกิดภาวะแทรกซ้อน
                                </label>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- P (Plan) Section -->
                <div>
                    <label id="planLabel" class="block text-base font-bold text-blue-600 mb-1">P (Plan -
                        แผนการรักษา):</label>

                    <!-- Standard A/P (Shown when NOT in Admit Mode) -->
                    <div id="standardAP_container">
                        <textarea id="inputAP" rows="4"
                            class="block w-full border border-gray-300 rounded-lg shadow-sm p-3 text-base focus:ring-blue-200 focus:border-blue-500"
                            placeholder="พิมพ์แผนการรักษา (1 บรรทัดต่อ 1 ข้อ)&#10;• เจาะเลือดพรุ่งนี้เช้า&#10;• ปรับยาแก้ปวดเป็น PRN&#10;• นัดตรวจซ้ำพรุ่งนี้เช้า"
                            data-autobullet="true" onfocus="seedBulletOnFocus(event)"
                            onkeydown="handleBulletKeydown(event)"></textarea>
                        <div class="mt-3 flex items-center bg-amber-50 p-2 rounded border border-amber-200 hover:bg-amber-100 cursor-pointer transition select-none"
                            onclick="toggleMedsChangedFromRow(event)">
                            <input type="checkbox" id="medsChanged"
                                class="w-6 h-6 text-amber-600 rounded focus:ring-amber-500 border-gray-300 mr-3 cursor-pointer"
                                onclick="event.stopPropagation()" onchange="handleMedsChanged(event)">
                            <label for="medsChanged" class="text-base font-bold text-amber-900 cursor-pointer">
                                มีการปรับยาในครั้งนี้
                            </label>
                        </div>
                    </div>

                    <div id="admitPlanHint"
                        class="hidden mt-2 bg-amber-50 border border-amber-200 border-l-4 border-l-amber-600 text-amber-900 rounded-lg px-3 py-2 text-base font-bold flex items-center gap-2">
                        <i class="fas fa-arrow-up"></i> กรอก Admission Orders ในส่วน “ข้อมูลแรกรับจาก OPD” ด้านบน
                    </div>
                </div>
            </div>
        </div>

        <!-- Single Continuous Order Block (MOVED HERE) -->
        <div class="bg-white p-3 rounded border-2 border-green-100 shadow-sm transition duration-300 mt-4"
            id="medsContainer">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-base font-bold text-green-800"><i class="fas fa-pills mr-1"></i>
                    รายการยาที่ใช้อยู่ (ตรวจสอบก่อนส่ง)</label>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="copyAdmitMedsToHeader()" id="btnCopyAdmitMeds"
                        class="hidden text-sm bg-green-50 text-green-800 border border-green-200 px-3 py-2 rounded-lg hover:bg-green-100 transition flex items-center gap-2">
                        <i class="fas fa-arrow-down"></i> คัดลอกจากยาต่อเนื่อง
                    </button>
                    <span id="medsStatusBadge"
                        class="text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold border border-red-200 shadow-sm">
                        <i class="fas fa-exclamation-circle"></i> รอการตรวจสอบ
                    </span>
                </div>
            </div>

            <div class="flex items-center justify-between mb-2 text-sm text-gray-700">
                <span><i class="fas fa-calendar-check text-green-600 mr-1"></i> วันที่ปรับยาล่าสุด</span>
                <span id="medsUpdateDateLabel" class="font-bold text-gray-900">-</span>
            </div>
            <input type="hidden" id="medsUpdateDate">
            <div id="pMedsCont"
                class="meds-editor w-full border border-gray-300 rounded-lg p-3 text-base placeholder-gray-400 font-mono mb-2 focus:ring-2 focus:ring-green-200 focus:border-green-500 outline-none transition"
                contenteditable="false" role="textbox" aria-multiline="true" aria-readonly="true"
                data-placeholder="ตัวอย่าง:&#10;• DrugName A 500mg 1x3 pc&#10;• DrugName B 10mg 1x1 hs&#10;(พิมพ์รายการยาที่นี่)"
                oninput="handleMedsInput()" onkeydown="handleMedsEditorKeydown(event)"
                onfocus="seedMedsEditorOnFocus()" onblur="handleMedsEditorBlur()"></div>

            <div id="medsChangeSummary"
                class="hidden mb-2 rounded-lg border border-rose-200 bg-rose-50 p-3">
                <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
                    <div class="flex items-center gap-2 text-rose-800 font-bold text-sm">
                        <i class="fas fa-pen-to-square"></i>
                        <span>สรุปยาที่ปรับ</span>
                        <span id="medsChangeCount"
                            class="text-xs font-bold text-rose-700 bg-rose-100 border border-rose-200 px-2 py-0.5 rounded-full">0 รายการ</span>
                    </div>
                    <button type="button" onclick="cancelMedsInlineChanges()"
                        class="text-xs font-bold text-rose-700 border border-rose-200 bg-white px-2.5 py-1 rounded-md hover:bg-rose-100 transition">
                        ยกเลิกการปรับยา
                    </button>
                </div>
                <ul id="medsChangeSummaryList"
                    class="list-disc list-inside space-y-1 text-sm font-semibold text-rose-700"></ul>
            </div>

            <!-- Verification Checkbox -->
            <div class="flex items-center bg-gray-50 p-2 rounded border border-gray-200 hover:bg-white cursor-pointer transition select-none"
                onclick="toggleMedsCheckFromRow()">
                <input type="checkbox" id="medsVerified"
                    class="w-6 h-6 text-green-600 rounded focus:ring-green-500 border-gray-300 mr-3 cursor-pointer"
                    onchange="updateMedsStatus(event)">
                <label for="medsVerified" class="text-base font-bold text-gray-800 cursor-pointer">
                    ฉันได้ตรวจสอบแล้วว่ารายการยาเป็นปัจจุบัน
                </label>
            </div>
        </div>

        <button onclick="generateLog()" id="generateBtn"
            class="w-full bg-line-green hover:bg-line-dark text-white font-bold py-4 px-4 rounded-lg shadow transition duration-200 flex justify-center items-center gap-2 text-xl">
            <i class="fas fa-magic"></i> <span id="generateBtnLabel">สร้างข้อความ</span>
        </button>

        <div id="resultSection" class="hidden">
            <div class="relative bg-gray-100 p-4 rounded-lg border border-gray-300">
                <label class="block text-base font-bold text-gray-700 mb-2">Preview:</label>
                <textarea id="outputArea"
                    class="w-full h-64 bg-white p-3 text-base font-mono border rounded-lg focus:outline-none"
                    readonly></textarea>
                <div class="mt-3 flex gap-2">
                    <button onclick="copyToClipboard()"
                        class="flex-1 bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg flex justify-center items-center gap-2 text-base">
                        <i class="fas fa-copy"></i> คัดลอก
                    </button>
                    <button onclick="shareToLine()"
                        class="flex-1 bg-line-green hover:bg-line-dark text-white font-bold py-3 px-4 rounded-lg flex justify-center items-center gap-2 text-base">
                        <i class="fa-brands fa-line"></i> แชร์ LINE
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-4 flex items-center justify-center gap-2 rounded-full border border-gray-200 bg-white px-4 py-2 text-xs text-gray-600">
            <span>with</span>
            <i class="fas fa-heart text-red-500" aria-hidden="true"></i>
            <span>by Gang FM</span>
            <span class="text-gray-300">|</span>
            <span>Home Ward รพ.กาฬสินธุ์</span>
        </div>
    </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2"><i class="fas fa-file-import text-green-600 mr-2"></i>
                นำเข้าข้อมูลจาก LINE</h2>
            <p class="text-sm text-gray-600 mb-3">วางข้อความทั้งหมดที่ Copy มาจาก LINE เพื่ออัปเดตยาและประวัติล่าสุด</p>
            <textarea id="importText" rows="10"
                class="w-full border-2 border-gray-200 rounded-lg p-3 text-base font-mono focus:border-yellow-500 focus:ring-0"
                placeholder="วางข้อความทั้งหมดที่นี่..."></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeImportModal()"
                    class="px-5 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 font-bold">ยกเลิก</button>
                <button id="importPrimaryBtn" onclick="handleImportPrimaryAction()"
                    class="px-5 py-3 bg-line-green text-white font-bold rounded-lg hover:bg-line-dark">วางจากคลิปบอร์ด</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white w-full max-w-3xl rounded-xl shadow-2xl p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2"><i class="fas fa-file-medical text-blue-600 mr-2"></i>
                รายงานสรุปจากประวัติอาการเดิม</h2>
            <p class="text-sm text-gray-600 mb-3">สรุปรายการล่าสุดเพื่อส่งต่อหรือแจ้งทีม</p>
            <div class="mt-4 space-y-4">
                <div class="flex flex-wrap gap-2">
                    <button type="button" id="reportTabSummary" class="report-tab report-tab-active"
                        onclick="setReportView('summary')">ภาพรวม</button>
                    <button type="button" id="reportTabTable" class="report-tab report-tab-inactive"
                        onclick="setReportView('table')">ตาราง V/S</button>
                    <button type="button" id="reportTabText" class="report-tab report-tab-inactive"
                        onclick="setReportView('text')">ข้อความ</button>
                </div>

                <div id="reportViewSummary" class="space-y-3">
                    <div class="text-sm text-gray-600">แนวโน้มค่าล่าสุด (เรียงตามเวลา)</div>
                    <div id="reportSummaryRange" class="text-sm font-semibold text-gray-700">ช่วงเวลา: -</div>
                    <div id="reportSummaryGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                    <p id="reportSummaryEmpty" class="hidden text-sm text-gray-500">ยังไม่มีข้อมูล V/S หรือ DTX ในประวัติ</p>
                </div>

                <div id="reportViewTable" class="hidden">
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100 text-gray-700">
                                <tr>
                                    <th class="px-2 py-2 text-center font-bold">วันที่</th>
                                    <th class="px-2 py-2 text-center font-bold">เวลา</th>
                                    <th class="px-2 py-2 text-center font-bold">BT</th>
                                    <th class="px-2 py-2 text-center font-bold">PR</th>
                                    <th class="px-2 py-2 text-center font-bold">RR</th>
                                    <th class="px-2 py-2 text-center font-bold">BP</th>
                                    <th class="px-2 py-2 text-center font-bold">SpO2</th>
                                    <th class="px-2 py-2 text-left font-bold">DTX</th>
                                </tr>
                            </thead>
                            <tbody id="reportVitalsTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                    <p id="reportTableEmpty" class="hidden text-sm text-gray-500 mt-2">ยังไม่มีข้อมูล V/S หรือ DTX ในประวัติ</p>
                </div>

                <div id="reportViewText" class="hidden">
                    <textarea id="reportOutput" rows="10"
                        class="w-full border-2 border-gray-200 rounded-lg p-3 text-base font-mono focus:border-blue-500 focus:ring-0"
                        readonly></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button type="button" onclick="closeReportModal()"
                    class="px-5 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 font-bold">ปิด</button>
                <button type="button" onclick="copyReportToClipboard()"
                    class="px-5 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">คัดลอก</button>
            </div>
        </div>
    </div>

    <!-- Meds Change Modal -->
    <div id="medsChangeModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2"><i class="fas fa-notes-medical text-amber-600 mr-2"></i>
                รายการยาที่ปรับในครั้งนี้</h2>
            <p class="text-sm text-gray-600 mb-3">แตะรายการยาที่ต้องการแก้ไข (รายการที่แก้จะขึ้นสีแดง)</p>
            <button type="button" onclick="addMedsNewRow()"
                class="mb-3 inline-flex items-center gap-2 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-sm font-bold text-amber-900 hover:bg-amber-100">
                <i class="fas fa-plus-circle"></i> เพิ่มยาใหม่
            </button>
            <div id="medsChangeList" class="space-y-2 max-h-72 overflow-y-auto pr-1"></div>
            <p id="medsChangeEmpty" class="hidden text-sm text-gray-500 mt-2">ยังไม่มีรายการยาในช่อง “รายการยาที่ใช้อยู่”
            </p>
            <textarea id="medsChangedList" class="hidden" aria-hidden="true"></textarea>
            <textarea id="medsChangeBaseline" class="hidden" aria-hidden="true"></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeMedsChangeModal({ discard: true })"
                    class="px-5 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 font-bold">ยกเลิก</button>
                <button onclick="saveMedsChanges()"
                    class="px-5 py-3 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- NEW CASE CONFIRM MODAL (Fixes the issue with blocked confirm()) -->
    <div id="newCaseModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-user-plus text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">เริ่มเคสใหม่?</h3>
                <div class="mt-2">
                    <p class="text-base text-gray-700">ข้อมูลปัจจุบันทั้งหมดจะถูกล้างหายไป เพื่อเตรียมรับผู้ป่วยรายใหม่
                    </p>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 grid grid-cols-2 gap-3">
                <button type="button" onclick="closeConfirmation()"
                    class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-5 py-3 bg-white text-base font-bold text-gray-800 hover:bg-gray-50 focus:outline-none">
                    ยกเลิก
                </button>
                <button type="button" onclick="executeNewCase()"
                    class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-5 py-3 bg-green-600 text-base font-bold text-white hover:bg-green-700 focus:outline-none">
                    ยืนยัน
                </button>
            </div>
        </div>
    </div>

    <!-- CLEAR FORM CONFIRM MODAL -->
    <div id="clearFormModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-bold text-gray-900 mb-2">ล้างฟอร์มวันนี้?</h3>
            <p class="text-base text-gray-700 mb-4">ข้อมูลอาการที่กรอกวันนี้จะหายไป (Header และประวัติเดิมยังอยู่)</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeConfirmation()"
                    class="w-full rounded-lg border border-gray-300 px-5 py-3 bg-white text-gray-800 hover:bg-gray-50 font-bold">ยกเลิก</button>
                <button onclick="executeClearForm()"
                    class="w-full rounded-lg border border-transparent px-5 py-3 bg-red-600 text-white hover:bg-red-700 font-bold">ล้างข้อมูล</button>
            </div>
        </div>
    </div>

    <!-- GENERATE CONFIRM MODAL (Safety Check) -->
    <div id="safetyCheckModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 border-l-4 border-red-500">
            <h3 class="text-lg font-bold text-red-600 mb-2"><i
                    class="fas fa-exclamation-triangle mr-2"></i>คำเตือนความปลอดภัย</h3>
            <p class="text-base text-gray-800 mb-4">คุณยังไม่ได้ติ๊ก 'ยืนยัน' รายการยา Continuous Order</p>
            <div class="flex flex-col gap-2">
                <button onclick="confirmSafetyCheck()"
                    class="w-full rounded-lg bg-green-600 text-white px-5 py-3 hover:bg-green-700 font-bold text-base">ยืนยันว่ายาถูกต้อง
                    (ดำเนินการต่อ)</button>
                <button onclick="cancelSafetyCheck()"
                    class="w-full rounded-lg bg-gray-200 text-gray-800 px-5 py-3 hover:bg-gray-300 font-bold text-base">กลับไปตรวจสอบ</button>
            </div>
        </div>
    </div>

    <!-- BP MULTI MEASURE MODAL -->
    <div id="bpModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="relative bg-white w-full max-w-md rounded-xl shadow-2xl p-6 mx-4">
            <div class="flex items-start justify-between gap-3">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="fas fa-tachometer-alt text-indigo-600 mr-2"></i>บันทึก BP หลายค่า
                </h3>
                <button type="button" onclick="closeBpModal()"
                    class="text-gray-500 hover:text-gray-800 text-2xl leading-none" aria-label="ปิด">×</button>
            </div>
            <p class="text-sm text-gray-700 mt-1">ใส่ค่าความดันได้หลายค่า (ระบบจะเอาไปแสดงในบรรทัด O:)
            </p>

            <div id="bpListContainer" class="mt-4 space-y-2"></div>

            <button type="button" onclick="addBpRow()"
                class="mt-3 w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-900 border border-indigo-200 font-bold py-2.5 rounded-lg flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> เพิ่มการวัด
            </button>

            <div class="mt-4 grid grid-cols-2 gap-3">
                <button type="button" onclick="closeBpModal()"
                    class="w-full rounded-lg border border-gray-300 px-5 py-3 bg-white text-gray-800 hover:bg-gray-50 font-bold">ยกเลิก</button>
                <button type="button" onclick="saveBpReadings()"
                    class="w-full rounded-lg border border-transparent px-5 py-3 bg-indigo-600 text-white hover:bg-indigo-700 font-bold">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- LAB HELPER MODAL -->
    <div id="labModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="relative bg-white w-full max-w-3xl rounded-xl shadow-2xl p-6 mx-4">
            <div class="flex items-start justify-between gap-3">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="fas fa-flask text-blue-600 mr-2"></i>กรอก Lab
                </h3>
                <button type="button" onclick="closeLabModal()"
                    class="text-gray-500 hover:text-gray-800 text-2xl leading-none" aria-label="ปิด">×</button>
            </div>
            <p class="text-sm text-gray-700 mt-1">ใส่เฉพาะค่าที่มี แล้วกด “เพิ่มลงในข้อมูล O อื่นๆ”</p>

            <div class="mt-4 max-h-[70vh] overflow-y-auto pr-1 space-y-4">
                <div>
                    <p class="text-sm font-bold text-gray-800">CBC</p>
                    <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <div>
                            <label class="block text-sm text-gray-700">WBC</label>
                            <input type="text" id="labCbcWbc" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Hb</label>
                            <input type="text" id="labCbcHb" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Hct</label>
                            <input type="text" id="labCbcHct" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Plt</label>
                            <input type="text" id="labCbcPlt" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Neu</label>
                            <input type="text" id="labCbcNeu" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Lym</label>
                            <input type="text" id="labCbcLym" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                    </div>
                </div>

                <div>
                    <p class="text-sm font-bold text-gray-800">Renal</p>
                    <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <div>
                            <label class="block text-sm text-gray-700">BUN</label>
                            <input type="text" id="labBun" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Cr</label>
                            <input type="text" id="labCr" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Uric acid</label>
                            <input type="text" id="labUric" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                    </div>
                </div>

                <div>
                    <p class="text-sm font-bold text-gray-800">Electrolytes</p>
                    <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <div>
                            <label class="block text-sm text-gray-700">Na</label>
                            <input type="text" id="labNa" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">K</label>
                            <input type="text" id="labK" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Cl</label>
                            <input type="text" id="labCl" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">HCO3</label>
                            <input type="text" id="labHco3" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Ca</label>
                            <input type="text" id="labCa" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Mg</label>
                            <input type="text" id="labMg" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">PO4</label>
                            <input type="text" id="labPo4" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                    </div>
                </div>

                <div>
                    <p class="text-sm font-bold text-gray-800">Glucose</p>
                    <div class="mt-2 grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm text-gray-700">FBS</label>
                            <input type="text" id="labFbs" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">HbA1c</label>
                            <input type="text" id="labHba1c" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                    </div>
                </div>

                <div>
                    <p class="text-sm font-bold text-gray-800">LFT</p>
                    <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <div>
                            <label class="block text-sm text-gray-700">AST</label>
                            <input type="text" id="labAst" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">ALT</label>
                            <input type="text" id="labAlt" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">ALP</label>
                            <input type="text" id="labAlp" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">TB</label>
                            <input type="text" id="labTb" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                    </div>
                </div>

                <div>
                    <p class="text-sm font-bold text-gray-800">Urinalysis</p>
                    <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <div>
                            <label class="block text-sm text-gray-700">Spec gr.</label>
                            <input type="text" id="labUaSg" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">pH</label>
                            <input type="text" id="labUaPh" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">RBC</label>
                            <input type="text" id="labUaRbc" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">WBC</label>
                            <input type="text" id="labUaWbc" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700">Epi</label>
                            <input type="text" id="labUaEpi" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="lab-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-3">
                <button type="button" onclick="clearLabInputs()"
                    class="w-full rounded-lg border border-gray-300 px-5 py-3 bg-white text-gray-800 hover:bg-gray-50 font-bold">ล้างค่า</button>
                <button type="button" onclick="addLabsToOExtra()"
                    class="w-full rounded-lg border border-transparent px-5 py-3 bg-blue-600 text-white hover:bg-blue-700 font-bold">เพิ่มลงในข้อมูล
                    O อื่นๆ</button>
            </div>
        </div>
    </div>

    <!-- PSYCH HELPER MODAL -->
    <div id="psychModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="relative bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 mx-4">
            <div class="flex items-start justify-between gap-3">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="fas fa-brain text-amber-600 mr-2"></i>กรอกแบบประเมินจิตเวช
                </h3>
                <button type="button" onclick="closePsychModal()"
                    class="text-gray-500 hover:text-gray-800 text-2xl leading-none" aria-label="ปิด">×</button>
            </div>
            <p class="text-sm text-gray-700 mt-1">ใส่เฉพาะค่าที่มี แล้วกด “เพิ่มลงในข้อมูล O อื่นๆ”</p>

            <div class="mt-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm text-gray-700">OAS</label>
                        <input type="text" id="psychOas" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                            class="psych-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700">CIWA-Ar</label>
                        <input type="text" id="psychCiwa" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                            class="psych-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-800">แบบคัดกรอง 2Q / 9Q / 8Q</label>
                    <div class="mt-2 grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600">2Q</label>
                            <input type="text" id="psych2Q" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="psych-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">9Q</label>
                            <input type="text" id="psych9Q" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="psych-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">8Q</label>
                            <input type="text" id="psych8Q" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="psych-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base text-center">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm text-gray-700">Stage of change</label>
                    <select id="psychStage"
                        class="psych-input w-full border border-gray-300 rounded-lg h-10 px-2 text-base bg-white">
                        <option value="">เลือก...</option>
                        <option value="Pre-contemplation">Pre-contemplation</option>
                        <option value="Contemplation">Contemplation</option>
                        <option value="Determination">Determination</option>
                        <option value="Action">Action</option>
                        <option value="Maintenance">Maintenance</option>
                    </select>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-3">
                <button type="button" onclick="clearPsychInputs()"
                    class="w-full rounded-lg border border-gray-300 px-5 py-3 bg-white text-gray-800 hover:bg-gray-50 font-bold">ล้างค่า</button>
                <button type="button" onclick="addPsychToOExtra()"
                    class="w-full rounded-lg border border-transparent px-5 py-3 bg-amber-600 text-white hover:bg-amber-700 font-bold">เพิ่มลงในข้อมูล
                    O อื่นๆ</button>
            </div>
        </div>
    </div>

    <!-- Copy Success Modal (Big Feedback) -->
    <div id="copySuccessModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-4 relative"
        onclick="if(event.target.id==='copySuccessModal') closeCopyModal()">
        <div
            class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center transform transition-all scale-100 flex flex-col items-center gap-4 animate-scale-in">
            <div class="h-20 w-20 bg-green-100 rounded-full flex items-center justify-center mb-2">
                <i class="fas fa-check text-4xl text-green-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">คัดลอกสำเร็จ!</h3>
            <p class="text-gray-600">ข้อความถูกบันทึกลงในคลิปบอร์ดแล้ว<br>สามารถไปกด <b>"วาง" (Paste)</b> ใน LINE
                ได้เลยครับ</p>
            <button onclick="closeCopyModal()"
                class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg text-lg shadow">
                ตกลง (OK)
            </button>
        </div>
        <!-- Confetti effect can be added here if desired later -->
    </div>

    <div id="toast"
        class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-4 rounded-xl shadow-lg transform transition-all duration-300 z-50 text-base max-w-[90vw]"
        role="status" aria-live="polite">
        <i id="toastIcon" class="fas fa-check-circle mr-2" style="color:#86efac"></i> <span
            id="toastMsg">Success!</span>
    </div>

    <script>
        const defaultHeader = [
            `ผู้ป่วย: ... (อายุ ... ปี)`,
            `Dx: ...`,
            `Admit: ...`,
            `  CC: ...`,
            `  HPI: ...`,
            `  PH: ...`,
            `  FHx: ...`,
            `  Allergy: ...`,
            `==============`,
            `💊 ยาปัจจุบัน (ปรับยาล่าสุด ...)`,
            `• ...`
        ].join('\n');

        const blankTemplate = [
            `ผู้ป่วย: ... (อายุ ... ปี)`,
            `Dx: ...`,
            `Admit: ...`,
            `  CC: ...`,
            `  HPI: ...`,
            `  PH: ...`,
            `  FHx: ...`,
            `  Allergy: ...`,
            `==============`,
            `💊 ยาปัจจุบัน (ปรับยาล่าสุด ...)`,
            `• ...`
        ].join('\n');
        const defaultHistory = ``;

        const FORM_STORAGE_KEY = 'patientLog_formState';
        const ADVANCED_MODE_STORAGE_KEY = 'patientLog_advancedMode';
        const FORM_TEXT_IDS = [
            'pFName', 'pAge', 'pDx', 'pIndication', 'pAdmitDate', 'pAllergy', 'pNote', 'pMedsCont', 'medsUpdateDate',
            'inputCC', 'inputHPI', 'inputPMH', 'inputFHx',
            'inputOneDay_Admit', 'inputCont_Admit', 'inputPlanMx_Admit',
            'logDate', 'logTime', 'inputS',
            'valBP', 'valT', 'valP', 'valR', 'valDTX', 'dtxType', 'valDTX_Hr',
            'valSpO2', 'valUrine', 'valStool',
            'inputO_Extra', 'inputAP', 'medsChangedList', 'medsChangeBaseline',
            'assessmentStatus', 'headerPart', 'historyPart', 'isAdmitMode',
        ];
        const FORM_CHECK_IDS = ['medsVerified', 'assessmentWatch', 'assessmentRisk'];

        function isContentEditableElement(el) {
            return Boolean(el && (el.isContentEditable || el.hasAttribute('contenteditable')));
        }

        function readFormValue(el) {
            if (!el) return '';
            if (isContentEditableElement(el)) return el.innerText ?? '';
            return el.value ?? '';
        }

        function writeFormValue(el, value) {
            if (!el) return;
            if (isContentEditableElement(el)) {
                el.innerText = value ?? '';
                return;
            }
            el.value = value ?? '';
        }

        const GENERATE_LABEL_DEFAULT = 'สร้างข้อความ';
        const GENERATE_LABEL_DIRTY = 'อัปเดตข้อความ';
        let hasGenerated = false;
        let isDirty = false;
        let isRestoringForm = false;
        let hasRestoredFormState = false;
        let hasManualTime = false;
        let medsDirty = false;
        let isAdvancedMode = false;

        function updateGenerateButtonState() {
            const btn = document.getElementById('generateBtn');
            const label = document.getElementById('generateBtnLabel');
            if (!btn || !label) return;

            if (hasGenerated && isDirty) {
                label.textContent = GENERATE_LABEL_DIRTY;
                btn.classList.add('generate-btn-update');
            } else {
                label.textContent = GENERATE_LABEL_DEFAULT;
                btn.classList.remove('generate-btn-update');
            }
        }

        function markDirty() {
            if (isRestoringForm) return;
            if (!hasGenerated || isDirty) return;
            isDirty = true;
            updateGenerateButtonState();
        }

        function clearDirtyState() {
            isDirty = false;
            updateGenerateButtonState();
        }

        function initDirtyTracking() {
            const selectors = [
                '#headerFormView input',
                '#headerFormView textarea',
                '#headerTextView textarea',
                '#admitSection input',
                '#admitSection textarea',
                '#historyPart',
                '#dailyEntrySection input',
                '#dailyEntrySection textarea',
                '#medsContainer input',
                '#medsContainer textarea',
            ];
            const tracked = document.querySelectorAll(selectors.join(','));
            tracked.forEach((el) => {
                el.addEventListener('input', markDirty);
                el.addEventListener('change', markDirty);
                el.addEventListener('input', saveFormState);
                el.addEventListener('change', saveFormState);
            });
        }

        function saveFormState() {
            if (isRestoringForm) return;
            const data = {
                values: {},
                checks: {},
                headerView: document.getElementById('headerTextView')?.classList.contains('hidden') ? 'form' : 'text',
                tipsMode: tipsModeState,
                timeIsManual: hasManualTime,
                headerHidden: Boolean(document.getElementById('headerSection')?.classList.contains('hidden')),
            };
            FORM_TEXT_IDS.forEach((id) => {
                const el = document.getElementById(id);
                if (el) data.values[id] = readFormValue(el);
            });
            FORM_CHECK_IDS.forEach((id) => {
                const el = document.getElementById(id);
                if (el) data.checks[id] = Boolean(el.checked);
            });
            localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(data));
        }

        function loadFormState() {
            const raw = localStorage.getItem(FORM_STORAGE_KEY);
            if (!raw) return;
            let data;
            try {
                data = JSON.parse(raw);
            } catch (_) {
                return;
            }
            hasRestoredFormState = true;
            isRestoringForm = true;
            if (data?.values) {
                FORM_TEXT_IDS.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el && Object.prototype.hasOwnProperty.call(data.values, id)) {
                        writeFormValue(el, data.values[id]);
                    }
                });
            }
            hasManualTime = Boolean(data?.timeIsManual);
            const savedLogDate = (data?.values?.logDate || '').trim();
            if (!savedLogDate || savedLogDate !== getTodayDisplayDate()) {
                hasManualTime = false;
            }
            if (data?.checks) {
                FORM_CHECK_IDS.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el && Object.prototype.hasOwnProperty.call(data.checks, id)) {
                        el.checked = Boolean(data.checks[id]);
                    }
                });
            }
            const admitVal = data?.values?.isAdmitMode;
            if (typeof admitVal === 'string') {
                toggleAdmitMode(admitVal === 'true');
            }
            const headerView = data?.headerView;
            if (headerView === 'form' || headerView === 'text') {
                switchHeaderView(headerView, { skipParse: true });
            }
            const dtxTypeVal = data?.values?.dtxType ?? '';
            setDtxType(dtxTypeVal);
            updateAssessmentButtons(document.getElementById('assessmentStatus')?.value || '');
            updateMedsStatus();
            syncMedsEditorState();
            updateMedsChangeSummary();
            updateAdmissionSummary();
            const headerHidden = Boolean(data?.headerHidden);
            setHeaderSectionHidden(headerHidden, { persist: false });
            updateBpCountBadge();
            if (data?.tipsMode === 'new' || data?.tipsMode === 'existing') {
                setTipsMode(data.tipsMode);
            }
            medsDirty = false;
            isRestoringForm = false;
        }

        function clearFormState() {
            localStorage.removeItem(FORM_STORAGE_KEY);
        }

        function sanitizeNumericInput(input) {
            const mode = input?.dataset?.numeric;
            if (!mode) return;

            const before = input.value;
            let after = before;

            if (input.id === 'valDTX') {
                const trimmed = before.trim().toUpperCase();
                if (trimmed === 'HI') {
                    after = 'HI';
                    if (after !== before) input.value = after;
                    setDtxHiState(true);
                    return;
                }
            }

            if (mode === 'int') {
                after = before.replace(/\D+/g, '');
            } else if (mode === 'decimal1') {
                after = before.replace(/,/g, '.').replace(/[^0-9.]/g, '');
                if (after.startsWith('.')) after = '0' + after;
                const dotIndex = after.indexOf('.');
                if (dotIndex !== -1) {
                    const intPart = after.slice(0, dotIndex);
                    const fracPart = after.slice(dotIndex + 1).replace(/\./g, '');
                    after = intPart + '.' + fracPart.slice(0, 1);
                }
            }

            if (after !== before) input.value = after;

            if (input.id === 'valDTX') {
                setDtxHiState(false);
            }

            // If DTX value is cleared, reset DTX type selection (no default)
            if (input.id === 'valDTX' && !input.value.trim()) {
                setDtxType('');
            }
        }

        function initNumericInputs() {
            document.querySelectorAll('input[data-numeric]').forEach((input) => {
                input.addEventListener('input', () => sanitizeNumericInput(input));
                sanitizeNumericInput(input);
            });
        }

        // --- Font Size Controls (Accessibility) ---
        const FONT_SIZE_STORAGE_KEY = 'patientLog_fontSizePx';
        const FONT_SIZE_STEPS = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
        const DEFAULT_FONT_SIZE_PX = 16;

        function updateFontSizeLabel(px) {
            const label = document.getElementById('fontSizeLabel');
            if (!label) return;
            label.textContent = String(px);
        }

        function applyFontSizePx(px, { persist = true, announce = true } = {}) {
            const safePx = Number.isFinite(px) ? px : DEFAULT_FONT_SIZE_PX;
            const clampedPx = Math.max(FONT_SIZE_STEPS[0], Math.min(FONT_SIZE_STEPS[FONT_SIZE_STEPS.length - 1], safePx));

            document.documentElement.style.fontSize = `${clampedPx}px`;
            updateFontSizeLabel(clampedPx);

            if (persist) localStorage.setItem(FONT_SIZE_STORAGE_KEY, String(clampedPx));
            if (announce) showToast(`ขนาดตัวอักษร: ${clampedPx}`, 'info');
        }

        function getClosestFontSizeIndex(px) {
            let bestIndex = 0;
            let bestDiff = Infinity;
            FONT_SIZE_STEPS.forEach((s, i) => {
                const diff = Math.abs(s - px);
                if (diff < bestDiff) { bestDiff = diff; bestIndex = i; }
            });
            return bestIndex;
        }

        function stepFontSize(direction) {
            const current = parseInt(getComputedStyle(document.documentElement).fontSize, 10) || DEFAULT_FONT_SIZE_PX;
            const currentIndex = getClosestFontSizeIndex(current);
            const nextIndex = Math.max(0, Math.min(FONT_SIZE_STEPS.length - 1, currentIndex + (direction < 0 ? -1 : 1)));
            applyFontSizePx(FONT_SIZE_STEPS[nextIndex], { persist: true, announce: true });
        }

        function resetFontSize() {
            localStorage.removeItem(FONT_SIZE_STORAGE_KEY);
            document.documentElement.style.fontSize = `${DEFAULT_FONT_SIZE_PX}px`;
            updateFontSizeLabel(DEFAULT_FONT_SIZE_PX);
            showToast('รีเซ็ตขนาดตัวอักษรแล้ว', 'info');
        }

        function initFontSize() {
            const saved = parseInt(localStorage.getItem(FONT_SIZE_STORAGE_KEY) || '', 10);
            if (Number.isFinite(saved) && saved > 0) {
                applyFontSizePx(saved, { persist: false, announce: false });
            } else {
                document.documentElement.style.fontSize = `${DEFAULT_FONT_SIZE_PX}px`;
                updateFontSizeLabel(DEFAULT_FONT_SIZE_PX);
            }
        }

        function markMedsDirty() {
            medsDirty = true;
        }

        function getTodayShortDate() {
            const today = new Date();
            const day = today.getDate();
            const month = today.getMonth() + 1;
            const year = (today.getFullYear() + 543).toString().slice(-2);
            return `${day}/${month}/${year}`;
        }

        function setMedsUpdateDate(value, { persist = true } = {}) {
            const input = document.getElementById('medsUpdateDate');
            const label = document.getElementById('medsUpdateDateLabel');
            const next = (value || '').trim();
            if (input) input.value = next;
            if (label) label.textContent = next || '-';
            if (persist) saveFormState();
        }

        function extractMedsUpdateDateFromText(text) {
            const source = text || '';
            const medsLineMatch = source.match(/^\s*💊\s*(?:ยาปัจจุบัน|ยาที่ใช้ปัจจุบัน|ยาที่ใช้ที่ใช้ปัจจุบัน).*$/m);
            if (!medsLineMatch) return '';
            const dateMatch = medsLineMatch[0].match(/\(([^)]+)\)/);
            if (!dateMatch) return '';
            let rawDate = dateMatch[1].trim();
            rawDate = rawDate.replace(/^(?:วันที่ปรับยา|ปรับยาล่าสุด)\s*/i, '').trim();
            if (!/\d/.test(rawDate)) return '';
            return rawDate;
        }

        function initMedsUpdateDate() {
            const input = document.getElementById('medsUpdateDate');
            if (!input) return;
            let value = (input.value || '').trim();
            let shouldPersist = false;
            if (!value) {
                const headerText = document.getElementById('headerPart')?.value || '';
                value = extractMedsUpdateDateFromText(headerText);
                if (value) {
                    input.value = value;
                    shouldPersist = true;
                }
            }
            setMedsUpdateDate(value, { persist: shouldPersist });
        }

        function getMedsContent() {
            const el = document.getElementById('pMedsCont');
            if (!el) return '';
            if (isContentEditableElement(el)) {
                return (el.innerText || '').replace(/\u00a0/g, ' ');
            }
            return el.value || '';
        }

        function setMedsContent(value) {
            const el = document.getElementById('pMedsCont');
            if (!el) return;
            if (isContentEditableElement(el)) {
                el.innerText = normalizeMedsDisplayText(value || '');
                return;
            }
            el.value = value || '';
        }

        function placeCaretAtEnd(el) {
            const range = document.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            const selection = window.getSelection();
            if (!selection) return;
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function handleMedsEditorKeydown(event) {
            const editor = event.currentTarget;
            if (!editor || !editor.isContentEditable) return;
            if (event.key !== 'Enter') return;
            event.preventDefault();
            const selection = window.getSelection();
            if (!selection || !selection.rangeCount) return;
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const br = document.createElement('br');
            range.insertNode(br);
            const bullet = document.createTextNode('• ');
            range.setStartAfter(br);
            range.insertNode(bullet);
            range.setStartAfter(bullet);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function seedMedsEditorOnFocus() {
            const el = document.getElementById('pMedsCont');
            if (!el || !el.isContentEditable) return;
            if (el.innerText.trim() !== '') return;
            el.textContent = '• ';
            placeCaretAtEnd(el);
        }

        let medsInlineResetPending = false;

        function handleMedsEditorBlur() {
            const el = document.getElementById('pMedsCont');
            if (!el || !el.isContentEditable) return;
            const normalized = normalizeMedsDisplayText(el.innerText || '');
            if ((el.innerText || '') !== normalized) {
                el.innerText = normalized;
            }
            const cleaned = normalized.trim();
            if (!cleaned || cleaned === '•') {
                el.textContent = '';
            }
            if (medsInlineResetPending) {
                renderMedsInlineChanges([]);
                medsInlineResetPending = false;
            }
            if (document.getElementById('medsChanged')?.checked) {
                updateMedsChangedFromInline();
            }
        }

        function handleMedsInput() {
            document.getElementById('medsVerified').checked = false;
            const medsChanged = document.getElementById('medsChanged');
            const isEditing = Boolean(medsChanged?.checked);
            if (isEditing) {
                updateMedsChangedFromInline({ deferRender: true });
            } else {
                const medsChangedList = document.getElementById('medsChangedList');
                if (medsChangedList) {
                    removeMedsChangesFromPlan(parseMedsChangedData(medsChangedList.value || ''));
                    medsChangedList.value = '';
                    medsInlineResetPending = true;
                }
            }
            updateMedsStatus();
            markMedsDirty();
            updateHeaderFromForm();
            updateMedsChangeSummary();
            saveFormState();
        }

        function parseCurrentMedsLines(sourceText) {
            const raw = typeof sourceText === 'string' ? sourceText : getMedsContent();
            return raw
                .split('\n')
                .map((line) => line.trim())
                .filter(Boolean)
                .map((line) => line.replace(/^[•\-]\s*/, '').trim())
                .filter((line) => line && line !== '...' && !line.includes('ยังไม่มีรายการยา'));
        }

        function normalizeMedsDisplayText(text) {
            const lines = String(text || '')
                .replace(/\u00a0/g, ' ')
                .split('\n');
            const normalized = lines.map((line) => {
                const trimmed = line.trim();
                if (!trimmed) return '';
                if (trimmed === '...' || trimmed.includes('ยังไม่มีรายการยา')) return trimmed;
                if (/^[•\-]\s*/.test(trimmed)) {
                    const rest = trimmed.replace(/^[•\-]\s*/, '').trim();
                    return rest ? `• ${rest}` : '•';
                }
                return `• ${trimmed}`;
            });
            return normalized.join('\n');
        }

        function setMedsEditorEditable(isEditable) {
            const editor = document.getElementById('pMedsCont');
            if (!editor) return;
            editor.setAttribute('contenteditable', isEditable ? 'true' : 'false');
            editor.setAttribute('aria-readonly', isEditable ? 'false' : 'true');
        }

        function getMedsChangeBaseline() {
            return document.getElementById('medsChangeBaseline')?.value || '';
        }

        function setMedsChangeBaseline(value) {
            const input = document.getElementById('medsChangeBaseline');
            if (input) input.value = value || '';
        }

        function ensureMedsChangeBaseline({ force = false } = {}) {
            const input = document.getElementById('medsChangeBaseline');
            if (!input) return;
            if (force || !input.value.trim()) {
                input.value = getMedsContent();
            }
        }

        function buildMedsEditsFromBaseline() {
            const baselineLines = parseCurrentMedsLines(getMedsChangeBaseline());
            const currentLines = parseCurrentMedsLines();
            const edits = [];
            currentLines.forEach((line, index) => {
                const original = baselineLines[index] || '';
                if (line && line !== original) {
                    edits.push({ index, original, updated: line });
                }
            });
            return edits;
        }

        function updateMedsChangedFromInline({ deferRender = false } = {}) {
            const input = document.getElementById('medsChangedList');
            if (!input) return;
            ensureMedsChangeBaseline();
            const previousEdits = parseMedsChangedData(input.value || '');
            const edits = buildMedsEditsFromBaseline();
            setMedsChangedData(edits);
            applyMedsChangesToPlan(edits, previousEdits);
            if (!deferRender) renderMedsInlineChanges(edits);
            updateMedsChangeSummary();
        }

        function cancelMedsInlineChanges() {
            const checkbox = document.getElementById('medsChanged');
            const input = document.getElementById('medsChangedList');
            const baseline = getMedsChangeBaseline();

            setMedsContent(baseline);
            if (input) {
                removeMedsChangesFromPlan(parseMedsChangedData(input.value || ''));
                input.value = '';
            }
            if (checkbox) checkbox.checked = false;
            setMedsEditorEditable(false);
            renderMedsInlineChanges([]);
            updateMedsChangeSummary();
            updateHeaderFromForm();
            updateMedsStatus();
            medsDirty = false;
            markDirty();
            saveFormState();
        }

        function syncMedsEditorState() {
            const checkbox = document.getElementById('medsChanged');
            if (!checkbox) return;
            const hasEdits = parseMedsChangedData(document.getElementById('medsChangedList')?.value || '').length > 0;
            if (hasEdits) checkbox.checked = true;
            if (checkbox.checked) ensureMedsChangeBaseline();
            setMedsEditorEditable(Boolean(checkbox.checked));
        }

        function normalizeMedsChangedLine(line) {
            const cleaned = (line || '').replace(/^[\s•\-\*]+/g, '').trim();
            return cleaned.replace(/^ปรับยา:\s*/i, '').trim();
        }

        function parseMedsChangedData(raw) {
            const trimmed = (raw || '').trim();
            if (!trimmed) return [];
            try {
                const data = JSON.parse(trimmed);
                if (Array.isArray(data)) {
                    return data
                        .map((item) => ({
                            index: Number.isFinite(Number(item.index)) ? Number(item.index) : 0,
                            original: item?.original ? String(item.original) : '',
                            updated: item?.updated ? String(item.updated) : '',
                        }))
                        .filter((item) => item.updated);
                }
            } catch (_) { }

            return trimmed
                .split('\n')
                .map((line, index) => ({
                    index,
                    original: '',
                    updated: normalizeMedsChangedLine(line),
                }))
                .filter((item) => item.updated);
        }

        function setMedsChangedData(edits) {
            const input = document.getElementById('medsChangedList');
            if (!input) return;
            input.value = edits && edits.length ? JSON.stringify(edits) : '';
        }

        function getMedsChangedLines() {
            const medsChanged = document.getElementById('medsChanged')?.checked;
            if (!medsChanged) return [];
            const raw = document.getElementById('medsChangedList')?.value || '';
            const edits = parseMedsChangedData(raw);
            return edits
                .map((item) => normalizeMedsChangedLine(item.updated))
                .filter(Boolean)
                .map((line) => `- ปรับยา: ${line}`);
        }

        function removeMedsChangesFromPlan(edits) {
            const plan = document.getElementById('inputAP');
            if (!plan) return;
            const lines = (plan.value || '').split('\n');
            if (!lines.length) return;
            const removeSet = new Set(
                (edits || [])
                    .map((item) => normalizeMedsChangedLine(item.updated))
                    .filter(Boolean)
            );
            if (!removeSet.size) return;
            const filtered = lines.filter((line) => {
                const normalized = normalizeMedsChangedLine(line);
                if (!normalized) return true;
                if (!/ปรับยา:/i.test(line)) return true;
                return !removeSet.has(normalized);
            });
            plan.value = filtered.join('\n').trimEnd();
        }

        function applyMedsChangesToPlan(edits, previousEdits) {
            removeMedsChangesFromPlan(previousEdits || []);
            const plan = document.getElementById('inputAP');
            if (!plan) return;
            const baseLines = (plan.value || '')
                .split('\n')
                .map((line) => line.trimEnd())
                .filter((line) => line.trim() !== '');
            const existing = new Set(
                baseLines
                    .filter((line) => /ปรับยา:/i.test(line))
                    .map(normalizeMedsChangedLine)
                    .filter(Boolean)
            );
            const additions = (edits || [])
                .map((item) => normalizeMedsChangedLine(item.updated))
                .filter(Boolean)
                .filter((line) => !existing.has(line))
                .map((line) => `• ปรับยา: ${line}`);
            if (additions.length) {
                baseLines.push(...additions);
            }
            plan.value = baseLines.join('\n');
        }

        function applyMedsChangesToCurrentList(edits, previousEdits) {
            const textarea = document.getElementById('pMedsCont');
            if (!textarea) return;
            const lines = (getMedsContent() || '').split('\n');
            if (!lines.length) return;

            const medLineIndices = [];
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (!trimmed) return;
                const normalized = trimmed.replace(/^[•\-]\s*/, '').trim();
                if (!normalized) return;
                if (normalized === '...' || normalized.includes('ยังไม่มีรายการยา')) return;
                medLineIndices.push(index);
            });
            if (!medLineIndices.length) return;

            const updatesByIndex = new Map(
                (edits || [])
                    .map((item) => [item.index, normalizeMedsChangedLine(item.updated)])
                    .filter(([, value]) => value)
            );
            const resetsByIndex = new Map(
                (previousEdits || [])
                    .filter((item) => !updatesByIndex.has(item.index))
                    .map((item) => [
                        item.index,
                        normalizeMedsChangedLine(item.original || item.updated || '')
                    ])
                    .filter(([, value]) => value)
            );

            const applyUpdate = (medIndex, value) => {
                const lineIndex = medLineIndices[medIndex];
                if (lineIndex === undefined) return;
                const originalLine = lines[lineIndex];
                const prefixMatch = originalLine.match(/^(\s*[•\-]\s*)/);
                const prefix = prefixMatch ? prefixMatch[1] : '• ';
                lines[lineIndex] = `${prefix}${value}`;
            };

            const medCount = medLineIndices.length;
            const appendUpdates = [];

            updatesByIndex.forEach((value, medIndex) => {
                if (medIndex >= medCount) {
                    appendUpdates.push({ index: medIndex, value });
                } else {
                    applyUpdate(medIndex, value);
                }
            });
            resetsByIndex.forEach((value, medIndex) => {
                if (medIndex < medCount) applyUpdate(medIndex, value);
            });

            if (appendUpdates.length) {
                const trailing = [];
                while (lines.length && lines[lines.length - 1].trim() === '') {
                    trailing.unshift(lines.pop());
                }
                appendUpdates
                    .sort((a, b) => a.index - b.index)
                    .forEach(({ value }) => lines.push(`• ${value}`));
                lines.push(...trailing);
            }

            setMedsContent(lines.join('\n'));
        }

        function updateMedsEditRowState(row, input, status) {
            const original = row.dataset.medOriginal || '';
            const current = (input.value || '').trim();
            const isChanged = current && current !== original;
            row.classList.toggle('meds-edit-changed', isChanged);
            if (status) status.classList.toggle('hidden', !isChanged);
        }

        function enableMedsEdit(row, input) {
            if (!row || !input || !input.readOnly) return;
            input.readOnly = false;
            row.classList.add('meds-edit-active');
            input.focus();
            if (typeof input.select === 'function') input.select();
        }

        function createMedsEditRow({ index, value, originalValue, labelText, isNew = false }) {
            const row = document.createElement('div');
            row.className = 'meds-edit-row';
            row.dataset.medIndex = String(index);
            row.dataset.medOriginal = originalValue;
            if (isNew) row.dataset.medNew = 'true';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'meds-edit-input';
            input.value = value;
            input.readOnly = true;
            input.setAttribute('aria-label', isNew ? 'เพิ่มยาใหม่' : `แก้ไขยา: ${labelText || value}`);

            const status = document.createElement('span');
            status.className = 'meds-edit-status hidden';
            status.textContent = isNew ? 'ยาใหม่' : 'แก้แล้ว';

            row.appendChild(input);
            row.appendChild(status);

            row.addEventListener('click', () => enableMedsEdit(row, input));
            input.addEventListener('click', (event) => {
                if (input.readOnly) {
                    event.preventDefault();
                    enableMedsEdit(row, input);
                }
            });
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && input.readOnly) {
                    event.preventDefault();
                    enableMedsEdit(row, input);
                }
            });
            input.addEventListener('input', () => updateMedsEditRowState(row, input, status));
            input.addEventListener('blur', () => {
                const trimmed = input.value.trim();
                if (!trimmed) {
                    if (row.dataset.medNew === 'true') {
                        row.remove();
                        return;
                    }
                    input.value = originalValue;
                }
                row.classList.remove('meds-edit-active');
                updateMedsEditRowState(row, input, status);
            });

            updateMedsEditRowState(row, input, status);
            return row;
        }

        function buildMedsChangeList() {
            const list = document.getElementById('medsChangeList');
            const empty = document.getElementById('medsChangeEmpty');
            if (!list) return;
            list.innerHTML = '';
            const meds = parseCurrentMedsLines();
            if (!meds.length) {
                if (empty) empty.classList.remove('hidden');
                return;
            }
            if (empty) empty.classList.add('hidden');

            const stored = parseMedsChangedData(document.getElementById('medsChangedList')?.value || '');
            const editsByIndex = new Map(stored.map((item) => [item.index, item]));

            meds.forEach((line, index) => {
                const edit = editsByIndex.get(index);
                const value = edit?.updated ? edit.updated : line;
                const originalValue = edit?.original ? edit.original : line;
                const row = createMedsEditRow({
                    index,
                    value,
                    originalValue,
                    labelText: line,
                    isNew: false,
                });
                list.appendChild(row);
            });
        }

        function addMedsNewRow() {
            const list = document.getElementById('medsChangeList');
            if (!list) return;
            const meds = parseCurrentMedsLines();
            if (!meds.length) {
                showToast('ยังไม่มีรายการยาในช่องรายการยาที่ใช้อยู่', 'warning');
                return;
            }
            const existingNewRows = list.querySelectorAll('.meds-edit-row[data-med-new="true"]').length;
            const nextIndex = meds.length + existingNewRows;
            const row = createMedsEditRow({
                index: nextIndex,
                value: '',
                originalValue: '',
                labelText: '',
                isNew: true,
            });
            list.appendChild(row);
            const input = row.querySelector('input');
            if (input) enableMedsEdit(row, input);
            row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function collectMedsChangedEdits() {
            const list = document.getElementById('medsChangeList');
            if (!list) return [];
            const rows = list.querySelectorAll('.meds-edit-row');
            const edits = [];
            rows.forEach((row) => {
                const input = row.querySelector('input');
                const original = row.dataset.medOriginal || '';
                const index = Number(row.dataset.medIndex || 0);
                const value = (input?.value || '').trim();
                if (value && value !== original) {
                    edits.push({ index, original, updated: value });
                }
            });
            return edits;
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderMedsInlineChanges(edits) {
            const editor = document.getElementById('pMedsCont');
            if (!editor) return;

            if (document.activeElement === editor) return;

            const rawText = getMedsContent();
            const rawLines = rawText.split('\n');
            const lineToMedIndex = new Map();
            let medIndex = 0;

            rawLines.forEach((line, index) => {
                const trimmed = line.trim();
                if (!trimmed) return;
                const normalized = trimmed.replace(/^[•\-]\s*/, '').trim();
                if (!normalized) return;
                if (normalized === '...' || normalized.includes('ยังไม่มีรายการยา')) return;
                lineToMedIndex.set(index, medIndex);
                medIndex += 1;
            });

            const editsList = Array.isArray(edits)
                ? edits
                : parseMedsChangedData(document.getElementById('medsChangedList')?.value || '');
            const editsByIndex = new Map(
                editsList
                    .map((item) => [item.index, normalizeMedsChangedLine(item.updated)])
                    .filter(([, value]) => value)
            );

            if (!editsByIndex.size && !editor.querySelector('.meds-inline-changed')) {
                return;
            }

            const htmlLines = rawLines.map((line, index) => {
                if (line === '') return '';
                const currentMedIndex = lineToMedIndex.get(index);
                if (currentMedIndex === undefined || !editsByIndex.has(currentMedIndex)) {
                    return escapeHtml(line);
                }
                const prefixMatch = line.match(/^(\s*[•\-]\s*)/);
                const prefix = prefixMatch ? prefixMatch[1] : '';
                const rest = line.slice(prefix.length);
                if (!rest) return escapeHtml(line);
                return `${escapeHtml(prefix)}<span class="meds-inline-changed">${escapeHtml(rest)}</span>`;
            });

            editor.innerHTML = htmlLines.join('<br>');
        }

        function updateMedsChangeSummary() {
            const container = document.getElementById('medsChangeSummary');
            const list = document.getElementById('medsChangeSummaryList');
            const count = document.getElementById('medsChangeCount');
            if (!container || !list) return;

            const edits = parseMedsChangedData(document.getElementById('medsChangedList')?.value || '');
            const lines = edits
                .map((item) => normalizeMedsChangedLine(item.updated))
                .filter(Boolean);

            list.innerHTML = '';
            if (!lines.length) {
                container.classList.add('hidden');
                if (count) count.textContent = '0 รายการ';
                return;
            }
            container.classList.remove('hidden');
            lines.forEach((line) => {
                const item = document.createElement('li');
                item.textContent = line;
                list.appendChild(item);
            });
            if (count) count.textContent = `${lines.length} รายการ`;
        }

        function toggleMedsCheckFromRow() {
            const checkbox = document.getElementById('medsVerified');
            checkbox.checked = !checkbox.checked;
            updateMedsStatus();
            markDirty();
            saveFormState();
        }

        function toggleMedsChangedFromRow(e) {
            if (e) {
                const target = e.target;
                if (target && (target.closest('input') || target.closest('label'))) {
                    return;
                }
            }
            const checkbox = document.getElementById('medsChanged');
            if (!checkbox) return;
            checkbox.checked = !checkbox.checked;
            handleMedsChangedToggle();
        }

        function handleMedsChanged(e) {
            if (e) e.stopPropagation();
            handleMedsChangedToggle();
        }

        let medsChangedDraft = '';
        let medsChangedWasChecked = false;

        function handleMedsChangedToggle() {
            const checkbox = document.getElementById('medsChanged');
            if (!checkbox) return;
            if (checkbox.checked) {
                setMedsChangeBaseline(getMedsContent());
                setMedsEditorEditable(true);
                updateMedsChangedFromInline();
                markDirty();
                saveFormState();
                return;
            }
            cancelMedsInlineChanges();
        }

        function openMedsChangeModal() {
            const modal = document.getElementById('medsChangeModal');
            const input = document.getElementById('medsChangedList');
            const checkbox = document.getElementById('medsChanged');
            if (!modal || !input) return;
            const meds = parseCurrentMedsLines();
            if (!meds.length) {
                if (checkbox) checkbox.checked = false;
                showToast('ยังไม่มีรายการยาในช่องรายการยาที่ใช้อยู่', 'warning');
                saveFormState();
                return;
            }
            medsChangedDraft = input.value || '';
            medsChangedWasChecked = parseMedsChangedData(medsChangedDraft).length > 0;
            buildMedsChangeList();
            modal.classList.remove('hidden');
            setTimeout(() => {
                const first = modal.querySelector('.meds-edit-input');
                if (first) first.focus();
            }, 50);
        }

        function closeMedsChangeModal({ discard = false, resetCheckbox = false } = {}) {
            const modal = document.getElementById('medsChangeModal');
            const input = document.getElementById('medsChangedList');
            const checkbox = document.getElementById('medsChanged');
            if (!modal || !input) return;
            if (resetCheckbox && checkbox) {
                if (discard) {
                    removeMedsChangesFromPlan(parseMedsChangedData(medsChangedDraft));
                }
                input.value = '';
                checkbox.checked = false;
                markDirty();
                saveFormState();
            } else if (discard) {
                input.value = medsChangedDraft;
                if (checkbox) checkbox.checked = medsChangedWasChecked;
            }
            modal.classList.add('hidden');
            renderMedsInlineChanges();
            updateMedsChangeSummary();
        }

        function saveMedsChanges() {
            const edits = collectMedsChangedEdits();
            const previousEdits = parseMedsChangedData(medsChangedDraft);
            setMedsChangedData(edits);
            const checkbox = document.getElementById('medsChanged');
            if (checkbox) checkbox.checked = edits.length > 0;
            applyMedsChangesToCurrentList(edits, previousEdits);
            applyMedsChangesToPlan(edits, previousEdits);
            const medsVerified = document.getElementById('medsVerified');
            if (medsVerified) medsVerified.checked = false;
            markMedsDirty();
            updateHeaderFromForm();
            updateMedsStatus();
            closeMedsChangeModal();
            markDirty();
            renderMedsInlineChanges();
            saveFormState();
            if (!edits.length) showToast('ยังไม่มีการปรับยา', 'info');
        }

        function updateMedsStatus(e) {
            if (e) e.stopPropagation();
            const isChecked = document.getElementById('medsVerified').checked;
            const container = document.getElementById('medsContainer');
            const badge = document.getElementById('medsStatusBadge');
            const medsChanged = document.getElementById('medsChanged');
            const shouldUpdateDate = medsChanged?.checked;

            if (isChecked && medsDirty && shouldUpdateDate) {
                setMedsUpdateDate(getTodayShortDate(), { persist: true });
                medsDirty = false;
                updateHeaderFromForm();
            }

            if (isChecked) {
                container.classList.remove('border-red-300', 'bg-red-50');
                container.classList.add('border-green-400', 'bg-green-50');
                badge.className = "text-sm px-3 py-1 rounded-full bg-green-100 text-green-800 font-bold border border-green-200 shadow-sm";
                badge.innerHTML = '<i class="fas fa-check-circle"></i> ตรวจสอบแล้ว';
            } else {
                container.classList.remove('border-green-400', 'bg-green-50');
                container.classList.add('border-red-300', 'bg-red-50');
                badge.className = "text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold border border-red-200 shadow-sm";
                badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> รอการตรวจสอบ';
            }
            renderMedsInlineChanges();
        }

        const IMPORT_PRIMARY_LABEL_PASTE = 'วางจากคลิปบอร์ด';
        const IMPORT_PRIMARY_LABEL_CONFIRM = 'ตกลงนำเข้าข้อมูล';
        let importModalInitialized = false;

        function openImportModal() {
            const modal = document.getElementById('importModal');
            const input = document.getElementById('importText');
            if (modal) modal.classList.remove('hidden');
            if (input) input.value = '';
            updateImportPrimaryButton();

            if (!importModalInitialized && input) {
                input.addEventListener('input', updateImportPrimaryButton);
                importModalInitialized = true;
            }

            if (input) {
                setTimeout(() => {
                    input.focus();
                    if (typeof input.select === 'function') input.select();
                }, 50);
            }
        }

        function updateImportPrimaryButton() {
            const input = document.getElementById('importText');
            const btn = document.getElementById('importPrimaryBtn');
            if (!input || !btn) return;
            const hasText = Boolean(input.value.trim());
            btn.textContent = hasText ? IMPORT_PRIMARY_LABEL_CONFIRM : IMPORT_PRIMARY_LABEL_PASTE;
        }

        async function tryPasteImportText({ announce = false } = {}) {
            const input = document.getElementById('importText');
            if (!input) return false;
            if (!navigator.clipboard || typeof navigator.clipboard.readText !== 'function') {
                if (announce) showToast('ไม่สามารถอ่านคลิปบอร์ดได้ในอุปกรณ์นี้', 'warning');
                return false;
            }
            try {
                const text = await navigator.clipboard.readText();
                if (text && !input.value.trim()) {
                    input.value = text;
                    if (announce) showToast('วางข้อความจากคลิปบอร์ดให้อัตโนมัติแล้ว', 'info');
                    return true;
                }
            } catch (_) {
                if (announce) showToast('ไม่สามารถอ่านคลิปบอร์ดได้', 'warning');
            }
            return false;
        }

        async function handleImportPrimaryAction() {
            const input = document.getElementById('importText');
            if (!input) return;
            if (!input.value.trim()) {
                const didPaste = await tryPasteImportText({ announce: true });
                if (didPaste) updateImportPrimaryButton();
                return;
            }
            processImport();
        }
        function closeImportModal() { document.getElementById('importModal').classList.add('hidden'); }

        function openImportExistingCase() {
            startExistingCase({ skipImportPrompt: true });
            openImportModal();
        }

        function processImport() {
            const text = document.getElementById('importText').value;
            if (!text.trim()) return;
            resetCaseForImport();
            handleFullTextImport(text);
            closeImportModal();
            switchHeaderView('form');
            setHeaderSectionHidden(true, { scroll: true });
            document.getElementById('medsVerified').checked = false;
            updateMedsStatus();
            showToast("นำเข้าข้อมูลเรียบร้อย! กรุณาตรวจสอบยาอีกครั้ง", "warning");
            markDirty();
            saveFormState();
        }

        function handleFullTextImport(text) {
            const markerRegex = /\n={10,}\n\(ส่วนที่ 2: บันทึกอาการรายวัน\)\n?/m;
            const match = text.match(markerRegex);

            let newHeader = "";
            let newHistory = "";
            if (match && typeof match.index === 'number') {
                newHeader = text.slice(0, match.index).trim();
                newHistory = text.slice(match.index + match[0].length).trim();
            } else {
                const separators = [...text.matchAll(/^={10,}\s*$/gm)];
                if (separators.length > 1) {
                    const last = separators[separators.length - 1];
                    const sepIndex = last.index ?? -1;
                    if (sepIndex !== -1) {
                        newHeader = text.slice(0, sepIndex).trim();
                        newHistory = text.slice(sepIndex + last[0].length).trim();
                    } else {
                        newHeader = text.trim();
                    }
                } else {
                    newHeader = text.trim();
                }
            }

            // AUTOMATIC ALLERGY DETECTION
            // Look for "Allergy" or "แพ้ยา" patterns in the FULL text, not just header
            const allergyMatch = text.match(/(?:แพ้ยา|Allergy)[\s:]*([^\n]+)/i);
            if (allergyMatch && allergyMatch[1]) {
                const detectedAllergy = allergyMatch[1].trim();
                // Update form field directly to ensure it sticks
                const allergyInput = document.getElementById('pAllergy');
                // Only update if current field is empty or contains "..." (placeholder)
                if (!allergyInput.value || allergyInput.value.includes("...")) {
                    allergyInput.value = detectedAllergy;
                }
            }

            document.getElementById('headerPart').value = newHeader;
            const medsDate = extractMedsUpdateDateFromText(newHeader);
            if (medsDate) setMedsUpdateDate(medsDate, { persist: false });
            if (newHistory) document.getElementById('historyPart').value = newHistory;
            const planInput = document.getElementById('inputPlanMx_Admit');
            if (planInput) {
                const importedPlan = extractAdmitPlanFromHistory(newHistory);
                planInput.value = importedPlan || '';
            }
            updateAdmissionSummary();
            saveData();
            switchHeaderView('text');
            checkHistoryVisibility();
            saveFormState();
        }

        document.getElementById('hiddenDatePicker').style.display = 'block';
        document.getElementById('hiddenDatePicker').style.position = 'absolute';
        document.getElementById('hiddenDatePicker').style.opacity = '0';
        document.getElementById('hiddenDatePicker').style.height = '0';
        document.getElementById('hiddenDatePicker').style.width = '0';
        document.getElementById('hiddenDatePicker').style.bottom = '0';
        document.getElementById('hiddenDatePicker').style.left = '0';

        function handleDateChange(input, targetId) {
            document.getElementById('dateTargetId').value = targetId;
            document.getElementById('hiddenDatePicker').value = input.value;
            applyDateSelection();
        }

        function applyDateSelection() {
            const dateVal = document.getElementById('hiddenDatePicker').value;
            if (!dateVal) return;
            const targetId = document.getElementById('dateTargetId').value;
            const targetInput = document.getElementById(targetId);
            const parts = dateVal.split('-');
            const yearAD = parseInt(parts[0]);
            const month = parts[1];
            const day = parts[2];
            const yearBE = (yearAD + 543).toString().slice(-2);

            const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const mIndex = parseInt(month) - 1;
            targetInput.value = `${parseInt(day)} ${months[mIndex]} ${yearBE}`;

            if (targetId === 'pAdmitDate') updateHeaderFromForm();
            if (targetId === 'logDate') {
                hasManualTime = false;
                if (isLogDateToday()) setCurrentTime({ force: true });
                updateAdmissionSummary();
            }
            markDirty();
            saveFormState();
        }

        function setDtxHiState(isActive) {
            const btn = document.getElementById('btnDtxHi');
            if (!btn) return;
            btn.classList.toggle('dtx-hi-active', isActive);
            btn.classList.toggle('dtx-hi-inactive', !isActive);
            btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        }

        function toggleDtxHi() {
            const input = document.getElementById('valDTX');
            if (!input) return;
            const isHi = (input.value || '').trim().toUpperCase() === 'HI';
            input.value = isHi ? '' : 'HI';
            sanitizeNumericInput(input);
            markDirty();
            saveFormState();
        }

        // NEW: Function to handle DTX Type Buttons
        function setDtxType(type) {
            const allowed = ['AC', 'PC', 'R'];
            const normalized = allowed.includes(type) ? type : '';
            const dtxTypeInput = document.getElementById('dtxType');
            const prevValue = dtxTypeInput?.value || '';
            if (dtxTypeInput) dtxTypeInput.value = normalized;
            const didChange = prevValue !== normalized;
            if (didChange) markDirty();
            const btnIds = { AC: 'btnDtxAC', PC: 'btnDtxPC', R: 'btnDtxR' };
            const activeClass = 'dtx-btn-active';
            const inactiveClass = 'dtx-btn-inactive';

            allowed.forEach((t) => {
                const btn = document.getElementById(btnIds[t]);
                if (!btn) return;

                // Reset State
                btn.classList.remove(activeClass, inactiveClass);

                if (t === normalized) {
                    btn.classList.add(activeClass);
                    btn.setAttribute('aria-pressed', 'true');
                } else {
                    btn.classList.add(inactiveClass);
                    btn.setAttribute('aria-pressed', 'false');
                }
            });

            // Toggle Time Input (Show ONLY for AC or PC, but mostly meaningful for PC)
            // User requested less confusion. Let's show it for PC mainly.
            // Actually, some use "AC 8hr" (Fasting). Let's show for AC and PC, but hide for Random.
            const timeContainer = document.getElementById('dtxTimeContainer');
            if (['AC', 'PC'].includes(normalized)) {
                timeContainer.classList.remove('hidden');
                // Auto focus logic? Maybe annoying on mobile.
            } else {
                timeContainer.classList.add('hidden');
                document.getElementById('valDTX_Hr').value = ''; // Clear if hidden
            }

            const dtxVal = document.getElementById('valDTX')?.value?.trim() || '';
            const dtxGroup = document.getElementById('dtxTypeButtonGroup');
            const dtxError = document.getElementById('dtxTypeError');
            if (normalized || !dtxVal) {
                if (dtxGroup) dtxGroup.classList.remove('ring-error');
                if (dtxError) dtxError.classList.add('hidden');
            }
            if (didChange) saveFormState();
        }

        // NEW: Function to handle Assessment (A) Buttons
        function setAssessmentStatus(status) {
            const allowed = ['ดีขึ้น', 'แย่ลง', 'พอเดิม'];
            const normalized = allowed.includes(status) ? status : '';
            const input = document.getElementById('assessmentStatus');
            if (!input) return;
            const nextValue = (input.value === normalized) ? '' : normalized;
            const didChange = input.value !== nextValue;
            if (didChange) markDirty();
            input.value = nextValue;
            updateAssessmentButtons(nextValue);
            if (didChange) saveFormState();
        }

        function updateAssessmentButtons(activeStatus) {
            const items = [
                { id: 'btnAssessBetter', value: 'ดีขึ้น' },
                { id: 'btnAssessWorse', value: 'แย่ลง' },
                { id: 'btnAssessSame', value: 'พอเดิม' },
            ];
            const activeClass = 'assess-btn-active';
            const inactiveClass = 'assess-btn-inactive';
            const statusClassMap = {
                'ดีขึ้น': 'assess-btn-active-better',
                'พอเดิม': 'assess-btn-active-same',
                'แย่ลง': 'assess-btn-active-worse',
            };
            const statusClasses = Object.values(statusClassMap);

            items.forEach(({ id, value }) => {
                const btn = document.getElementById(id);
                if (!btn) return;
                btn.classList.remove(activeClass, inactiveClass, ...statusClasses);
                if (value === activeStatus) {
                    btn.classList.add(activeClass);
                    if (statusClassMap[value]) btn.classList.add(statusClassMap[value]);
                    btn.setAttribute('aria-pressed', 'true');
                } else {
                    btn.classList.add(inactiveClass);
                    btn.setAttribute('aria-pressed', 'false');
                }
            });
        }

        // --- BP MULTI MEASURE (Compact via Modal) ---
        function parseBpReadings(text) {
            if (!text) return [];
            const normalized = text.replace(/->|→/g, ',');
            const stripLabel = (value) => value
                .replace(/^BP\s*\d*\)?\s*/i, '')
                .replace(/^[•\-]\s*/, '')
                .trim();
            const parts = normalized
                .split(/[\n,;|]+/g)
                .map(stripLabel)
                .filter(Boolean);
            if (parts.length > 1) return parts;

            const matches = normalized.match(/\d{2,3}\s*\/\s*\d{2,3}(?:\s*\/\s*\d{2,3})?/g);
            if (matches && matches.length > 1) {
                return matches.map(match => match.replace(/\s+/g, ' ').trim());
            }
            return parts;
        }

        function updateBpCountBadge() {
            const badge = document.getElementById('bpCountBadge');
            const bpInput = document.getElementById('valBP');
            if (!badge || !bpInput) return;

            const values = parseBpReadings(bpInput.value);
            if (values.length > 1) {
                badge.textContent = String(values.length);
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function openBpModal() {
            const modal = document.getElementById('bpModal');
            const container = document.getElementById('bpListContainer');
            const bpInput = document.getElementById('valBP');
            if (!modal || !container || !bpInput) return;

            container.innerHTML = '';
            const values = parseBpReadings(bpInput.value);
            const seed = values.length ? values : [''];
            seed.forEach(v => addBpRow(v, false));

            modal.classList.remove('hidden');
            setTimeout(() => {
                const first = container.querySelector('input');
                if (first) {
                    first.focus();
                    if (typeof first.select === 'function') first.select();
                }
            }, 50);
        }

        function closeBpModal() {
            const modal = document.getElementById('bpModal');
            if (!modal) return;
            modal.classList.add('hidden');
        }

        // NEW: Update indices for BP rows
        function updateBpRowIndicies() {
            const container = document.getElementById('bpListContainer');
            if (!container) return;
            const rows = container.querySelectorAll('.bp-row'); // helper class
            rows.forEach((row, index) => {
                const label = row.querySelector('.bp-label');
                if (label) {
                    label.textContent = `BP ${index + 1})`;
                }
            });
        }

        function addBpRow(value = '', focus = true) {
            const container = document.getElementById('bpListContainer');
            if (!container) return;

            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center bp-row'; // Added bp-row class

            // NEW: Label
            const label = document.createElement('span');
            label.className = 'text-base font-bold text-indigo-700 whitespace-nowrap bp-label w-12 text-right';
            label.textContent = 'BP'; // Placeholder

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'ระบุ BP';
            input.value = value;
            input.className = 'flex-1 border border-gray-300 rounded-lg px-3 py-2 h-11 text-base text-center bg-white';
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addBpRow('', true);
                }
            });

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'w-11 h-11 rounded-lg bg-gray-100 border border-gray-300 text-gray-700 hover:bg-gray-200 font-bold flex-shrink-0';
            removeBtn.setAttribute('aria-label', 'ลบค่า BP');
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener('click', () => {
                row.remove();
                if (container.children.length === 0) {
                    addBpRow('', true);
                } else {
                    updateBpRowIndicies();
                }
            });

            row.appendChild(label); // Prepend label
            row.appendChild(input);
            row.appendChild(removeBtn);
            container.appendChild(row);

            updateBpRowIndicies(); // Update specific indices

            if (focus) input.focus();
        }

        function saveBpReadings() {
            const container = document.getElementById('bpListContainer');
            const bpInput = document.getElementById('valBP');
            if (!container || !bpInput) return;

            const inputs = Array.from(container.querySelectorAll('input'));
            const values = inputs.map(i => (i.value || '').trim()).filter(Boolean);
            bpInput.value = values.join(', ');
            closeBpModal();
            updateBpCountBadge();
            showToast(values.length ? 'บันทึก BP แล้ว' : 'ล้างค่า BP แล้ว', values.length ? 'success' : 'info');
            markDirty();
            saveFormState();
        }

        function openLabModal() {
            const modal = document.getElementById('labModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => {
                const first = modal.querySelector('.lab-input');
                if (first) {
                    first.focus();
                    if (typeof first.select === 'function') first.select();
                }
            }, 50);
        }

        function closeLabModal() {
            const modal = document.getElementById('labModal');
            if (!modal) return;
            modal.classList.add('hidden');
        }

        function clearLabInputs() {
            document.querySelectorAll('#labModal .lab-input').forEach((input) => {
                input.value = '';
            });
        }

        function addLabsToOExtra() {
            const getVal = (id) => document.getElementById(id)?.value?.trim() || '';
            const buildLine = (label, items) => {
                const parts = items
                    .map(({ key, value }) => (value ? `${key} ${value}` : ''))
                    .filter(Boolean);
                return parts.length ? `• ${label}: ${parts.join(', ')}` : '';
            };

            const lines = [];
            lines.push(buildLine('CBC', [
                { key: 'WBC', value: getVal('labCbcWbc') },
                { key: 'Hb', value: getVal('labCbcHb') },
                { key: 'Hct', value: getVal('labCbcHct') },
                { key: 'Plt', value: getVal('labCbcPlt') },
                { key: 'Neu', value: getVal('labCbcNeu') },
                { key: 'Lym', value: getVal('labCbcLym') },
            ]));
            lines.push(buildLine('Renal', [
                { key: 'BUN', value: getVal('labBun') },
                { key: 'Cr', value: getVal('labCr') },
                { key: 'Uric', value: getVal('labUric') },
            ]));
            lines.push(buildLine('Electrolytes', [
                { key: 'Na', value: getVal('labNa') },
                { key: 'K', value: getVal('labK') },
                { key: 'Cl', value: getVal('labCl') },
                { key: 'HCO3', value: getVal('labHco3') },
                { key: 'Ca', value: getVal('labCa') },
                { key: 'Mg', value: getVal('labMg') },
                { key: 'PO4', value: getVal('labPo4') },
            ]));
            lines.push(buildLine('Glucose', [
                { key: 'FBS', value: getVal('labFbs') },
                { key: 'HbA1c', value: getVal('labHba1c') },
            ]));
            lines.push(buildLine('LFT', [
                { key: 'AST', value: getVal('labAst') },
                { key: 'ALT', value: getVal('labAlt') },
                { key: 'ALP', value: getVal('labAlp') },
                { key: 'TB', value: getVal('labTb') },
            ]));
            lines.push(buildLine('UA', [
                { key: 'Spec gr.', value: getVal('labUaSg') },
                { key: 'pH', value: getVal('labUaPh') },
                { key: 'RBC', value: getVal('labUaRbc') },
                { key: 'WBC', value: getVal('labUaWbc') },
                { key: 'Epi', value: getVal('labUaEpi') },
            ]));

            const filledLines = lines.filter(Boolean);
            if (!filledLines.length) {
                showToast('ยังไม่มีค่า Lab ให้เพิ่ม', 'warning');
                return;
            }

            const oExtra = document.getElementById('inputO_Extra');
            if (!oExtra) return;
            const current = oExtra.value.trim();
            const isEmptyBullet = current === '•';
            const base = current && !isEmptyBullet ? current : '';
            oExtra.value = base ? `${base}\n${filledLines.join('\n')}` : filledLines.join('\n');

            clearLabInputs();
            closeLabModal();
            showToast('เพิ่มผล Lab ลงในข้อมูล O อื่นๆ แล้ว');
            oExtra.focus();
            markDirty();
            saveFormState();
        }

        function openPsychModal() {
            const modal = document.getElementById('psychModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => {
                const first = modal.querySelector('.psych-input');
                if (first) {
                    first.focus();
                    if (typeof first.select === 'function') first.select();
                }
            }, 50);
        }

        function closePsychModal() {
            const modal = document.getElementById('psychModal');
            if (!modal) return;
            modal.classList.add('hidden');
        }

        function clearPsychInputs() {
            document.querySelectorAll('#psychModal .psych-input').forEach((input) => {
                if (input.tagName === 'SELECT') {
                    input.value = '';
                } else {
                    input.value = '';
                }
            });
        }

        function addPsychToOExtra() {
            const getVal = (id) => document.getElementById(id)?.value?.trim() || '';
            const stage = document.getElementById('psychStage')?.value?.trim() || '';

            const lines = [];
            const oas = getVal('psychOas');
            if (oas) lines.push(`• OAS: ${oas}`);
            const q2 = getVal('psych2Q');
            const q9 = getVal('psych9Q');
            const q8 = getVal('psych8Q');
            const qParts = [];
            if (q2) qParts.push(`2Q = ${q2}`);
            if (q9) qParts.push(`9Q = ${q9}`);
            if (q8) qParts.push(`8Q = ${q8}`);
            if (qParts.length) lines.push(`• ${qParts.join(' | ')}`);
            const ciwa = getVal('psychCiwa');
            if (ciwa) lines.push(`• CIWA-Ar: ${ciwa}`);
            if (stage) lines.push(`• Stage of change: ${stage}`);

            if (!lines.length) {
                showToast('ยังไม่มีแบบประเมินจิตเวชให้เพิ่ม', 'warning');
                return;
            }

            const oExtra = document.getElementById('inputO_Extra');
            if (!oExtra) return;
            const current = oExtra.value.trim();
            const isEmptyBullet = current === '•';
            const base = current && !isEmptyBullet ? current : '';
            oExtra.value = base ? `${base}\n${lines.join('\n')}` : lines.join('\n');

            clearPsychInputs();
            closePsychModal();
            showToast('เพิ่มแบบประเมินจิตเวชลงในข้อมูล O อื่นๆ แล้ว');
            oExtra.focus();
            markDirty();
            saveFormState();
        }

        function toggleAdmitMode(forceState = null) {
            const isAdmitInput = document.getElementById('isAdmitMode');
            const currentVal = isAdmitInput.value === 'true';
            const newState = (forceState !== null) ? forceState : !currentVal;

            isAdmitInput.value = newState ? 'true' : 'false';

            const btn = document.getElementById('btnToggleAdmit');
            const admitSection = document.getElementById('admitSection');
            const admitFields = document.getElementById('admitFields_container');
            const standardAP = document.getElementById('standardAP_container');
            const admitPlan = document.getElementById('admitPlan_container');
            const admitPlanHint = document.getElementById('admitPlanHint');
            const copyAdmitMedsBtn = document.getElementById('btnCopyAdmitMeds');

            // const apTitle = document.getElementById('apSectionTitle'); // Removed
            const planLabel = document.getElementById('planLabel');

            const updatePlanLabels = (isAdmitMode) => {
                if (planLabel) {
                    planLabel.textContent = isAdmitMode
                        ? 'P (Plan) - แผนการรักษา (Admission Orders):'
                        : 'P (Plan - แผนการรักษา):';
                }
            };

            if (newState) {
                if (btn) {
                    btn.classList.remove('bg-white', 'text-amber-800', 'border-amber-300');
                    btn.classList.add('bg-amber-700', 'text-white', 'border-amber-700', 'shadow-md');
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> แสดงข้อมูลแรกรับ (เปิด)';
                }
                if (admitSection) admitSection.classList.remove('hidden');
                updatePlanLabels(true);
                if (admitFields) {
                    admitFields.classList.remove('hidden');
                    admitFields.classList.add('animate-pulse-once');
                    setTimeout(() => admitFields.classList.remove('animate-pulse-once'), 500);
                }
                if (standardAP) standardAP.classList.add('hidden');
                if (admitPlan) admitPlan.classList.remove('hidden');
                if (admitPlanHint) admitPlanHint.classList.remove('hidden');
                if (copyAdmitMedsBtn) copyAdmitMedsBtn.classList.remove('hidden');
            } else {
                if (btn) {
                    btn.classList.add('bg-white', 'text-amber-800', 'border-amber-300');
                    btn.classList.remove('bg-amber-700', 'text-white', 'border-amber-700', 'shadow-md');
                    btn.innerHTML = '<i class="fas fa-plus-circle"></i> เพิ่มข้อมูลแรกรับ (Admit Note)';
                }
                if (admitSection) admitSection.classList.add('hidden');
                updatePlanLabels(false);
                if (admitFields) admitFields.classList.add('hidden');
                if (standardAP) standardAP.classList.remove('hidden');
                if (admitPlan) admitPlan.classList.add('hidden');
                if (admitPlanHint) admitPlanHint.classList.add('hidden');
                if (copyAdmitMedsBtn) copyAdmitMedsBtn.classList.add('hidden');
            }

            if (newState !== currentVal) markDirty();
        }

        function setCurrentTime({ force = false } = {}) {
            const timeEl = document.getElementById('logTime');
            if (!timeEl) return;
            if (!force && !isLogDateToday()) return;
            if (hasManualTime && !force) return;
            const nowValue = formatTimeHHMM(new Date());
            if (timeEl.value !== nowValue) {
                timeEl.value = nowValue;
                if (!isRestoringForm) {
                    markDirty();
                    saveFormState();
                }
            }
        }

        function initDate({ force = false } = {}) {
            const todayLabel = getTodayDisplayDate();
            const logDateInput = document.getElementById('logDate');
            if (logDateInput && (force || !logDateInput.value.trim())) {
                logDateInput.value = todayLabel;
            }
            const timeEl = document.getElementById('logTime');
            if (timeEl && (force || !timeEl.value.trim())) {
                if (force) hasManualTime = false;
                setCurrentTime({ force: true });
            } else {
                setCurrentTime();
            }

            if (force || !hasRestoredFormState) {
                toggleAdmitMode(false);
            }
        }

        function formatTimeHHMM(date) {
            const d = date instanceof Date ? date : new Date();
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        function getTodayDisplayDate() {
            const today = new Date();
            const day = today.getDate();
            const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const monthShort = months[today.getMonth()];
            const year = (today.getFullYear() + 543).toString().slice(-2);
            return `${day} ${monthShort} ${year}`;
        }

        function isLogDateToday() {
            const logDateInput = document.getElementById('logDate');
            const current = logDateInput?.value?.trim() || '';
            return current === getTodayDisplayDate();
        }

        function openTimePicker(targetId) {
            const el = document.getElementById(targetId);
            if (!el) return;
            el.focus();
            if (typeof el.showPicker === 'function') {
                try { el.showPicker(); } catch (_) { }
            }
        }

        function loadData() {
            const savedHeader = localStorage.getItem('patientLog_header') || defaultHeader;
            const normalizedHeader = normalizeHeaderLines(savedHeader);
            const savedHistory = localStorage.getItem('patientLog_history') || defaultHistory;
            document.getElementById('headerPart').value = normalizedHeader;
            if (normalizedHeader !== savedHeader) {
                localStorage.setItem('patientLog_header', normalizedHeader);
            }
            document.getElementById('historyPart').value = savedHistory;
            checkHistoryVisibility();
        }

        function saveData() {
            localStorage.setItem('patientLog_header', document.getElementById('headerPart').value);
            localStorage.setItem('patientLog_history', document.getElementById('historyPart').value);
        }

        function restoreTemplate() {
            if (confirm("ต้องการวางโครงร่างมาตรฐานทับข้อความปัจจุบันหรือไม่?")) {
                document.getElementById('headerPart').value = blankTemplate;
                markDirty();
                saveFormState();
            }
        }

        const HEADER_INLINE_LABEL_REGEX = /(?:\b(?:CC|HPI|PH|FHx|Allergy|Note)\b|หมายเหตุ)\s*:/i;
        const stripInlineHeaderLabels = (value) => {
            const trimmed = (value || '').trim();
            if (!trimmed) return '';
            const match = trimmed.match(HEADER_INLINE_LABEL_REGEX);
            if (!match) return trimmed;
            if (match.index === 0) return '';
            return trimmed.slice(0, match.index).trim();
        };

        const normalizeHeaderLines = (text) => {
            if (!text) return text;
            let changed = false;
            const lines = text.split('\n').map((line) => {
                const match = line.match(/^(\s*)(CC|HPI|PH|FHx|Allergy|Note|หมายเหตุ):\s*(.*)$/i);
                if (!match) return line;
                const indent = match[1];
                const label = match[2];
                const valueRaw = match[3];
                const cleaned = stripInlineHeaderLabels(valueRaw);
                if (cleaned !== valueRaw.trim()) changed = true;
                return `${indent}${label}: ${cleaned}`.trimEnd();
            });
            return changed ? lines.join('\n') : text;
        };

        function parseHeaderToForm() {
            const raw = document.getElementById('headerPart').value.trim();
            if (!raw) return;
            const separatorMatches = raw.match(/^={10,}\s*$/gm);
            if (raw.includes("(ส่วนที่ 2: บันทึกอาการรายวัน)") || (separatorMatches && separatorMatches.length > 1)) {
                handleFullTextImport(raw);
                return;
            }
            const lines = raw.split('\n').map(l => l.trim()).filter(l => l);
            let nameVal = "", ageVal = "", dxVal = "", indicationVal = "", allergyVal = "", admitVal = "", medsText = "";
            let ccVal = "", hpiVal = "", pmhVal = "", fhxVal = "", noteVal = "";

            const nameMatch = raw.match(/ผู้ป่วย:\s*(.*?)(?:\s*\((\d+)\s*ปี\))?$/m);
            if (nameMatch) { nameVal = nameMatch[1]; ageVal = nameMatch[2] || ""; }
            else if (lines.length > 0) {
                let line0 = lines[0].replace("ผู้ป่วย:", "").trim();
                const ageMatch = line0.match(/(.*?)(?:\s*\((\d+)\s*ปี\))?$/);
                if (ageMatch) { nameVal = ageMatch[1]; ageVal = ageMatch[2] || ""; } else { nameVal = line0; }
            }

            const dxMatch = raw.match(/^\s*Dx\/Indication:\s*(.*?)(?:\n|$)/mi) || raw.match(/^\s*Dx:\s*(.*?)(?:\n|$)/mi);
            if (dxMatch) {
                dxVal = dxMatch[1].trim();
            } else if (lines.length > 1) {
                let potentialDx = lines[1];
            if (!potentialDx.includes("วันที่รับ") && !potentialDx.includes("Admit") && !potentialDx.includes("ยาที่ใช้")) {
                dxVal = potentialDx.replace("Dx/Indication:", "").replace("Dx:", "").replace("แพ้ยา:", "").trim();
            }
            }

            if (dxVal) {
                const dxParenMatch = dxVal.match(/^(.*)\(([^()]*)\)\s*$/);
                if (dxParenMatch) {
                    dxVal = dxParenMatch[1].trim();
                    indicationVal = dxParenMatch[2].trim();
                }
            }

            // const indicationMatch = ... // Removed as it's merged

            const ccMatch = raw.match(/^\s*CC:\s*(.*?)(?:\n|$)/m);
            if (ccMatch) ccVal = stripInlineHeaderLabels(ccMatch[1]);
            const hpiMatch = raw.match(/^\s*HPI:\s*(.*?)(?:\n|$)/m);
            if (hpiMatch) hpiVal = stripInlineHeaderLabels(hpiMatch[1]);
            const pmhMatch = raw.match(/^\s*PH:\s*(.*?)(?:\n|$)/m);
            if (pmhMatch) pmhVal = stripInlineHeaderLabels(pmhMatch[1]);
            const fhxMatch = raw.match(/^\s*FHx:\s*(.*?)(?:\n|$)/m);
            if (fhxMatch) fhxVal = stripInlineHeaderLabels(fhxMatch[1]);

            const allergyMatch =
                raw.match(/^\s*Allergy:\s*(.*?)(?:\n|={5,}|$)/mi) ||
                raw.match(/^\s*แพ้ยา:\s*(.*?)(?:\n|={5,}|$)/mi);
            if (allergyMatch) allergyVal = stripInlineHeaderLabels(allergyMatch[1]);

            const noteMatch =
                raw.match(/^\s*หมายเหตุ:\s*(.*?)(?:\n|={5,}|$)/mi) ||
                raw.match(/^\s*Note:\s*(.*?)(?:\n|={5,}|$)/mi);
            if (noteMatch) noteVal = stripInlineHeaderLabels(noteMatch[1]);

            const admitMatch = raw.match(/^\s*(?:Admit|วันที่รับ):\s*(.*?)(?:\n|$)/mi);
            if (admitMatch) admitVal = admitMatch[1].trim();
            else {
                for (const line of lines) {
                    if (line.match(/(\d{1,2}[\/\s][^\s]+[\/\s]\d{2,4})/) && !line.includes("ยาที่ใช้")) {
                        admitVal = line.replace(/^(?:Admit|วันที่รับ):/i, "").trim();
                        break;
                    }
                }
            }

            const medsHeaderRegex = /^\s*(?:[•-]\s*)?(?:💊|💉)?\s*(?:ยาปัจจุบัน|ยาที่ใช้ปัจจุบัน|ยาที่ใช้ที่ใช้ปัจจุบัน)/i;
            const rawLines = raw.split('\n');
            let medsStartLineIndex = -1;
            for (let i = 0; i < rawLines.length; i++) {
                if (medsHeaderRegex.test(rawLines[i])) {
                    medsStartLineIndex = i;
                    break;
                }
            }
            if (medsStartLineIndex !== -1) {
                medsText = rawLines.slice(medsStartLineIndex + 1).join('\n').trim();
            } else {
                let startMedsIndex = -1;
                for (let i = 3; i < lines.length; i++) { if (lines[i].startsWith('•') || lines[i].startsWith('-')) { startMedsIndex = i; break; } }
                if (startMedsIndex !== -1) medsText = lines.slice(startMedsIndex).join('\n');
            }
            if (medsText) {
                medsText = medsText
                    .split('\n')
                    .map(l => l.trim())
                    .filter(l => l && !l.includes('อัปเดต') && !l.includes('Update'))
                    .filter(l => !/ปรับยาล่าสุด|วันที่ปรับยา/i.test(l))
                    .map(l => l.replace(/^[•-]\s*/, ''))
                    .filter(l => l && l !== '(ยังไม่มีรายการยา)' && !/^\(\s*.*\s*\)$/.test(l))
                    .join('\n');
            }
            const medsDate = extractMedsUpdateDateFromText(raw);
            if (medsDate) setMedsUpdateDate(medsDate, { persist: false });

            document.getElementById('pFName').value = nameVal === "..." ? "" : nameVal;
            document.getElementById('pAge').value = ageVal;
            document.getElementById('pDx').value = dxVal === "..." ? "" : dxVal;
            document.getElementById('pIndication').value = indicationVal === "..." ? "" : indicationVal;
            document.getElementById('pAllergy').value = allergyVal === "..." ? "" : allergyVal;
            document.getElementById('pNote').value = noteVal === "..." ? "" : noteVal;
            document.getElementById('pAdmitDate').value = admitVal === "..." ? "" : admitVal;
            setMedsContent(medsText === "..." ? "" : medsText);
            const ccEl = document.getElementById('inputCC');
            const hpiEl = document.getElementById('inputHPI');
            const pmhEl = document.getElementById('inputPMH');
            const fhxEl = document.getElementById('inputFHx');
            if (ccEl) ccEl.value = ccVal === "..." ? "" : ccVal;
            if (hpiEl) hpiEl.value = hpiVal === "..." ? "" : hpiVal;
            if (pmhEl) pmhEl.value = pmhVal === "..." ? "" : pmhVal;
            if (fhxEl) fhxEl.value = fhxVal === "..." ? "" : fhxVal;
        }

        function getCurrentHeaderView() {
            const headerTextView = document.getElementById('headerTextView');
            return headerTextView && !headerTextView.classList.contains('hidden') ? 'text' : 'form';
        }

        function setHeaderTabs(view) {
            const tabForm = document.getElementById('tabForm');
            const tabText = document.getElementById('tabText');
            if (tabForm) tabForm.className = view === 'form' ? "tab-active pb-1" : "tab-inactive pb-1";
            if (tabText) {
                tabText.className = view === 'text' ? "tab-active pb-1" : "tab-inactive pb-1";
                tabText.classList.toggle('hidden', !isAdvancedMode);
            }
        }

        function setAdvancedMode(isEnabled, { persist = true, syncView = true } = {}) {
            isAdvancedMode = Boolean(isEnabled);
            const btn = document.getElementById('advancedModeToggle');
            if (btn) {
                btn.classList.toggle('bg-gray-100', !isAdvancedMode);
                btn.classList.toggle('border-gray-300', !isAdvancedMode);
                btn.classList.toggle('text-gray-700', !isAdvancedMode);
                btn.classList.toggle('hover:bg-gray-200', !isAdvancedMode);
                btn.classList.toggle('bg-amber-600', isAdvancedMode);
                btn.classList.toggle('border-amber-600', isAdvancedMode);
                btn.classList.toggle('text-white', isAdvancedMode);
                btn.classList.toggle('hover:bg-amber-700', isAdvancedMode);
                btn.innerHTML = isAdvancedMode
                    ? '<i class="fas fa-sliders"></i> โหมดขั้นสูง: เปิด'
                    : '<i class="fas fa-sliders"></i> โหมดขั้นสูง: ปิด';
                btn.setAttribute('aria-pressed', isAdvancedMode ? 'true' : 'false');
            }

            if (!isAdvancedMode && syncView) {
                switchHeaderView('form');
            } else {
                setHeaderTabs(getCurrentHeaderView());
            }

            if (persist) {
                localStorage.setItem(ADVANCED_MODE_STORAGE_KEY, isAdvancedMode ? '1' : '0');
            }
        }

        function toggleAdvancedMode() {
            setAdvancedMode(!isAdvancedMode);
        }

        function switchHeaderView(view, options = {}) {
            const { skipParse = false } = options;
            if (view === 'text' && !isAdvancedMode) view = 'form';
            if (view === 'form') {
                if (!skipParse) parseHeaderToForm();
                document.getElementById('headerFormView').classList.remove('hidden');
                document.getElementById('headerTextView').classList.add('hidden');
                document.getElementById('medsContainer').classList.remove('hidden');
                setHeaderTabs('form');
                const allergyError = document.getElementById('allergyError');
                if (allergyError) allergyError.classList.add('hidden');
                document.getElementById('pAllergy').classList.remove('ring-error');
                updateHeaderFromForm();
            } else {
                document.getElementById('headerFormView').classList.add('hidden');
                document.getElementById('headerTextView').classList.remove('hidden');
                document.getElementById('medsContainer').classList.add('hidden');
                setHeaderTabs('text');
            }
            saveFormState();
        }

        function updateHeaderFromForm() {
            const name = document.getElementById('pFName').value.trim() || 'ชื่อ-นามสกุล';
            const age = document.getElementById('pAge').value.trim();
            const dxBaseValue = document.getElementById('pDx').value.trim();
            const dxBase = dxBaseValue || '...';
            const indicationRaw = (document.getElementById('pIndication')?.value || '').trim();
            let dx = dxBase;
            if (indicationRaw) {
                dx = dxBaseValue ? `${dxBase} (${indicationRaw})` : indicationRaw;
            }
            // const indication = document.getElementById('pIndication').value.trim() || '...'; // Removed
            const admitDate = document.getElementById('pAdmitDate').value.trim() || '...';
            const allergy = stripInlineHeaderLabels(document.getElementById('pAllergy').value.trim());
            const note = stripInlineHeaderLabels((document.getElementById('pNote')?.value || '').trim());
            const medsCont = getMedsContent().trim();

            const allergyError = document.getElementById('allergyError');
            if (allergyError && allergy) allergyError.classList.add('hidden');
            if (allergy) document.getElementById('pAllergy').classList.remove('ring-error');
            const ageStr = age ? ` (${age} ปี)` : '';
            const toSingleLine = (text) => (text || '').replace(/\s*\n\s*/g, ' ').trim();
            const cc = stripInlineHeaderLabels(toSingleLine(document.getElementById('inputCC')?.value));
            const hpi = stripInlineHeaderLabels(toSingleLine(document.getElementById('inputHPI')?.value));
            const pmh = stripInlineHeaderLabels(toSingleLine(document.getElementById('inputPMH')?.value));
            const fhx = stripInlineHeaderLabels(toSingleLine(document.getElementById('inputFHx')?.value));
            const medsUpdateDate = (document.getElementById('medsUpdateDate')?.value || '').trim();
            const medsDateLabel = medsUpdateDate || '...';
            let medsBlock = `💊 ยาปัจจุบัน (ปรับยาล่าสุด ${medsDateLabel})`;
            if (medsCont) {
                const lines = medsCont.split('\n');
                lines.forEach(line => { const cleanLine = line.trim(); if (cleanLine) medsBlock += `\n${cleanLine.startsWith('•') ? cleanLine : '• ' + cleanLine}`; });
            } else { medsBlock += `\n• (ยังไม่มีรายการยา)`; }
            const headerLines = [
                `ผู้ป่วย: ${name}${ageStr}`,
                `Dx: ${dx}`,
                // `Indication: ${indication}`, // Removed
                `Admit: ${admitDate}`,
                `  CC: ${cc}`,
                `  HPI: ${hpi}`,
                `  PH: ${pmh}`,
                `  FHx: ${fhx}`,
                `  Allergy: ${allergy}`,
            ];
            if (note) headerLines.push(`  หมายเหตุ: ${note}`);
            headerLines.push(`==============`, medsBlock);
            document.getElementById('headerPart').value = headerLines.join('\n');
            updateAdmissionSummary();
            saveData();
        }

        function formatPlanSummaryText(text) {
            const raw = (text || '').trim();
            if (!raw) return '...';
            return raw
                .split('\n')
                .map((line) => line.trim())
                .filter(Boolean)
                .map((line) => {
                    if (/^[•\u2022]/.test(line)) return line;
                    if (line.startsWith('-')) return `• ${line.replace(/^-+\s*/, '')}`;
                    return line;
                })
                .join('\n');
        }

        function extractPlanFromEntry(lines) {
            if (!Array.isArray(lines) || lines.length === 0) return '';
            let capture = false;
            const planLines = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (/^\s*P:\s*/.test(line)) {
                    capture = true;
                    const first = line.replace(/^\s*P:\s*/, '');
                    if (first.trim()) planLines.push(first);
                    continue;
                }
                if (!capture) continue;
                if (/^\s*(S:|O:|A:)\s*/.test(line)) break;
                if (line.startsWith('🔻 ')) break;
                if (/^\s*(One Day Order|Continuous Order):/i.test(line)) break;
                if (!line.trim()) continue;
                planLines.push(line);
            }
            if (!planLines.length) return '';
            return planLines
                .map((line) => line.replace(/\s+$/, ''))
                .map((line) => line.replace(/^\s+/, ''))
                .filter(Boolean)
                .map((line) => {
                    if (/^[•\u2022]/.test(line)) return line;
                    if (/^-/.test(line)) return `• ${line.replace(/^-+\s*/, '')}`;
                    return line;
                })
                .join('\n');
        }

        function extractAdmitPlanFromHistory(historyText) {
            const text = (historyText || '').trim();
            if (!text) return '';
            const lines = text.split('\n');
            const entries = [];
            let current = [];
            lines.forEach((line) => {
                if (line.startsWith('🔻 ')) {
                    if (current.length) entries.push(current);
                    current = [line];
                } else if (current.length) {
                    current.push(line);
                }
            });
            if (current.length) entries.push(current);
            if (!entries.length) return '';

            const admitEntry = entries.find((entry) => entry[0]?.includes('(แรกรับ)'));
            let plan = extractPlanFromEntry(admitEntry || []);
            if (plan) return plan;

            for (const entry of entries) {
                plan = extractPlanFromEntry(entry);
                if (plan) return plan;
            }
            return '';
        }

        function parseThaiDateInput(value) {
            const trimmed = (value || '').trim();
            if (!trimmed) return null;
            const monthMap = {
                'ม.ค.': 0, 'ม.ค': 0,
                'ก.พ.': 1, 'ก.พ': 1,
                'มี.ค.': 2, 'มี.ค': 2,
                'เม.ย.': 3, 'เม.ย': 3,
                'พ.ค.': 4, 'พ.ค': 4,
                'มิ.ย.': 5, 'มิ.ย': 5,
                'ก.ค.': 6, 'ก.ค': 6,
                'ส.ค.': 7, 'ส.ค': 7,
                'ก.ย.': 8, 'ก.ย': 8,
                'ต.ค.': 9, 'ต.ค': 9,
                'พ.ย.': 10, 'พ.ย': 10,
                'ธ.ค.': 11, 'ธ.ค': 11,
            };
            let day;
            let monthIdx;
            let yearToken;
            let match = trimmed.match(/^(\d{1,2})\s+([^\s]+)\s+(\d{2,4})$/);
            if (match) {
                day = parseInt(match[1], 10);
                monthIdx = monthMap[match[2]];
                yearToken = match[3];
                if (monthIdx === undefined) return null;
            } else {
                match = trimmed.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
                if (!match) return null;
                day = parseInt(match[1], 10);
                monthIdx = parseInt(match[2], 10) - 1;
                yearToken = match[3];
                if (monthIdx < 0 || monthIdx > 11) return null;
            }
            let yearNum = parseInt(yearToken, 10);
            if (Number.isNaN(yearNum)) return null;
            let yearAD;
            if (yearNum < 100) {
                yearAD = 2500 + yearNum - 543;
            } else if (yearNum >= 2400) {
                yearAD = yearNum - 543;
            } else {
                yearAD = yearNum;
            }
            const date = new Date(yearAD, monthIdx, day);
            if (Number.isNaN(date.getTime())) return null;
            return date;
        }

        function calculateLosDays(admitDate, refDate) {
            if (!admitDate || !refDate) return null;
            const start = new Date(admitDate.getFullYear(), admitDate.getMonth(), admitDate.getDate());
            const end = new Date(refDate.getFullYear(), refDate.getMonth(), refDate.getDate());
            const diffMs = end.getTime() - start.getTime();
            if (!Number.isFinite(diffMs)) return null;
            const days = Math.floor(diffMs / 86400000) + 1;
            if (days < 1) return null;
            return days;
        }

        function isNegativeAllergy(value) {
            const raw = (value || '').trim();
            if (!raw || raw === '...') return true;
            const lower = raw.toLowerCase();
            if (raw === '-') return true;
            if (/ปฏิเสธ|ปฎิเสธ|ไม่มี/.test(raw)) return true;
            if (/\bno\b|\bnone\b/.test(lower)) return true;
            return false;
        }

        function updateAdmissionSummary() {
            const nameEl = document.getElementById('admissionSummaryName');
            const dxEl = document.getElementById('admissionSummaryDx');
            const admitEl = document.getElementById('admissionSummaryAdmit');
            const allergyEl = document.getElementById('admissionSummaryAllergy');
            const losEl = document.getElementById('admissionSummaryLos');
            const noteRow = document.getElementById('admissionSummaryNoteRow');
            const noteEl = document.getElementById('admissionSummaryNote');
            const ccEl = document.getElementById('admissionSummaryCc');
            const hpiEl = document.getElementById('admissionSummaryHpi');
            const pmhEl = document.getElementById('admissionSummaryPmh');
            const fhxEl = document.getElementById('admissionSummaryFhx');
            if (!nameEl || !dxEl || !admitEl || !allergyEl || !losEl || !noteRow || !noteEl || !ccEl || !hpiEl || !pmhEl || !fhxEl) return;

            const toSingleLine = (text) => (text || '').replace(/\s*\n\s*/g, ' ').trim();
            const safeText = (text) => (text ? text : '...');

            const name = (document.getElementById('pFName')?.value || '').trim();
            const age = (document.getElementById('pAge')?.value || '').trim();
            let nameDisplay = safeText(name);
            if (age) nameDisplay = `${nameDisplay} (${age} ปี)`;

            const dxRaw = (document.getElementById('pDx')?.value || '').trim();
            const indicationRaw = (document.getElementById('pIndication')?.value || '').trim();
            let dxCombined = dxRaw || '...';
            if (indicationRaw) {
                dxCombined = dxRaw ? `${dxRaw} (${indicationRaw})` : indicationRaw;
            }
            const dx = safeText(dxCombined);
            const admitRaw = (document.getElementById('pAdmitDate')?.value || '').trim();
            const admit = safeText(admitRaw);
            const allergyRaw = (document.getElementById('pAllergy')?.value || '').trim();
            const allergy = safeText(stripInlineHeaderLabels(allergyRaw));
            const noteRaw = stripInlineHeaderLabels((document.getElementById('pNote')?.value || '').trim());
            const planRaw = (document.getElementById('inputPlanMx_Admit')?.value || '').trim();
            const plan = formatPlanSummaryText(planRaw);
            const planText = document.getElementById('admissionPlanSummaryText');
            const logDateRaw = (document.getElementById('logDate')?.value || '').trim();
            const admitDateObj = parseThaiDateInput(admitRaw);
            const logDateObj = parseThaiDateInput(logDateRaw) || new Date();
            const losDays = calculateLosDays(admitDateObj, logDateObj);

            const cc = safeText(stripInlineHeaderLabels(toSingleLine(document.getElementById('inputCC')?.value)));
            const hpi = safeText(stripInlineHeaderLabels(toSingleLine(document.getElementById('inputHPI')?.value)));
            const pmh = safeText(stripInlineHeaderLabels(toSingleLine(document.getElementById('inputPMH')?.value)));
            const fhx = safeText(stripInlineHeaderLabels(toSingleLine(document.getElementById('inputFHx')?.value)));

            nameEl.textContent = nameDisplay;
            dxEl.textContent = dx;
            admitEl.textContent = admit;
            allergyEl.textContent = allergy;
            losEl.textContent = losDays ? `${losDays} วัน` : '...';
            ccEl.textContent = cc;
            hpiEl.textContent = hpi;
            pmhEl.textContent = pmh;
            fhxEl.textContent = fhx;

            if (planText) {
                planText.textContent = planRaw ? plan : 'ยังไม่ได้กรอก';
            }

            const isNegative = isNegativeAllergy(allergy);
            allergyEl.classList.toggle('text-red-700', !isNegative);
            allergyEl.classList.toggle('text-gray-900', isNegative);

            if (noteRaw) {
                noteRow.classList.remove('hidden');
                noteEl.textContent = noteRaw;
            } else {
                noteRow.classList.add('hidden');
                noteEl.textContent = '';
            }
        }

        function showHistorySection({ scroll = false } = {}) {
            const container = document.getElementById('historyContainer');
            const showBtn = document.getElementById('showHistoryBtn');
            if (container) container.classList.remove('hidden');
            if (showBtn) showBtn.classList.add('hidden');
            if (scroll && container) container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function setHeaderSectionHidden(isHidden, options = {}) {
            const { scroll = false, persist = true, focusEdit = false } = options;
            const headerSection = document.getElementById('headerSection');
            const notice = document.getElementById('headerHiddenNotice');
            const summary = document.getElementById('admissionSummary');

            if (headerSection) headerSection.classList.toggle('hidden', isHidden);
            if (notice) notice.classList.toggle('hidden', !isHidden);
            if (summary) summary.classList.toggle('hidden', !isHidden);

            if (isHidden) {
                showHistorySection({ scroll });
            } else if (scroll && headerSection) {
                headerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            if (focusEdit) {
                switchHeaderView('form');
                const nameInput = document.getElementById('pFName');
                if (nameInput) {
                    setTimeout(() => {
                        nameInput.focus();
                        nameInput.click();
                    }, 100);
                }
            }

            if (persist && !isRestoringForm) saveFormState();
        }

        function revealHeaderSectionForEdit() {
            setHeaderSectionHidden(false, { scroll: true, focusEdit: true });
        }

        function saveHeaderAndHide() {
            const headerTextView = document.getElementById('headerTextView');
            if (headerTextView && !headerTextView.classList.contains('hidden')) {
                switchHeaderView('form');
            } else {
                updateHeaderFromForm();
            }
            updateAdmissionSummary();
            setHeaderSectionHidden(true, { scroll: true });
        }

        function toggleAdmissionSummaryDetails() {
            const details = document.getElementById('admissionSummaryDetails');
            const btn = document.getElementById('admissionSummaryToggle');
            if (!details || !btn) return;
            const isOpen = !details.classList.contains('hidden');
            details.classList.toggle('hidden', isOpen);
            btn.textContent = isOpen ? 'ดูรายละเอียดแรกรับ' : 'ซ่อนรายละเอียดแรกรับ';
            btn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
        }

        function checkHistoryVisibility() {
            const history = document.getElementById('historyPart').value.trim();
            const container = document.getElementById('historyContainer');
            const showBtn = document.getElementById('showHistoryBtn');
            if (history === "") { container.classList.add('hidden'); showBtn.classList.remove('hidden'); }
            else { container.classList.add('hidden'); showBtn.classList.remove('hidden'); }
        }

        function toggleHistory() {
            const container = document.getElementById('historyContainer');
            if (container.classList.contains('hidden')) { container.classList.remove('hidden'); document.getElementById('showHistoryBtn').classList.add('hidden'); }
            else { container.classList.add('hidden'); document.getElementById('showHistoryBtn').classList.remove('hidden'); }
        }

        function toggleHistoryLock() {
            const textarea = document.getElementById('historyPart');
            const btn = document.getElementById('btnHistoryLock');
            const isLocked = textarea.hasAttribute('readonly');
            if (isLocked) {
                textarea.removeAttribute('readonly');
                textarea.classList.remove('bg-gray-100', 'text-gray-600', 'cursor-not-allowed');
                textarea.classList.add('bg-white', 'text-gray-900');
                btn.innerHTML = '<i class="fas fa-lock-open text-green-600"></i> ปลดล็อกแล้ว';
                btn.classList.remove('bg-gray-200', 'text-gray-700', 'border-gray-300');
                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
                textarea.focus();
            } else {
                textarea.setAttribute('readonly', 'true');
                textarea.classList.remove('bg-white', 'text-gray-900');
                textarea.classList.add('bg-gray-100', 'text-gray-600', 'cursor-not-allowed');
                btn.innerHTML = '<i class="fas fa-lock text-xs"></i> ล็อก';
                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-200');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'border-gray-300');
            }
        }

        function splitHistoryEntries(historyText) {
            const lines = (historyText || '').split('\n');
            const entries = [];
            let current = [];
            lines.forEach((line) => {
                if (line.startsWith('🔻')) {
                    if (current.length) entries.push(current);
                    current = [line];
                    return;
                }
                if (current.length) current.push(line);
            });
            if (current.length) entries.push(current);
            return entries;
        }

        function extractSoapSection(lines, label) {
            const pattern = new RegExp(`^\\s*${label}:\\s*`);
            const startIndex = lines.findIndex((line) => pattern.test(line));
            if (startIndex === -1) return '';
            const sectionLines = [];
            const firstLine = lines[startIndex].replace(pattern, '').trim();
            if (firstLine) sectionLines.push(firstLine);

            for (let i = startIndex + 1; i < lines.length; i++) {
                const line = lines[i];
                if (/^\s*(S|O|A|P):\s*/.test(line)) break;
                if (/^\s*🔻\s*/.test(line)) break;
                if (/^\s*(={5,}|-{5,})\s*$/.test(line)) break;
                if (!line.trim()) continue;
                sectionLines.push(line.trim());
            }

            return sectionLines.join('\n');
        }

        function formatReportBlock(label, value) {
            const raw = (value || '').trim();
            if (!raw) return `${label}: ...`;
            const lines = raw
                .split('\n')
                .map((line) => line.trim())
                .filter(Boolean);
            if (!lines.length) return `${label}: ...`;
            return lines
                .map((line, idx) => (idx === 0 ? `${label}: ${line}` : `   ${line}`))
                .join('\n');
        }

        function buildHistoryReportText() {
            const historyText = document.getElementById('historyPart')?.value || '';
            const entries = splitHistoryEntries(historyText);
            if (!entries.length) return '';
            const lastEntry = entries[entries.length - 1];
            const headerLine = (lastEntry[0] || '').replace(/^🔻\s*/, '').trim();
            const bodyLines = lastEntry.slice(1);

            const s = extractSoapSection(bodyLines, 'S');
            const o = extractSoapSection(bodyLines, 'O');
            const a = extractSoapSection(bodyLines, 'A');
            const p = extractSoapSection(bodyLines, 'P');

            const nameRaw = (document.getElementById('pFName')?.value || '').trim();
            const ageRaw = (document.getElementById('pAge')?.value || '').trim();
            let nameDisplay = nameRaw || '...';
            if (ageRaw) nameDisplay = `${nameDisplay} (${ageRaw} ปี)`;

            const dxRaw = (document.getElementById('pDx')?.value || '').trim();
            const indicationRaw = (document.getElementById('pIndication')?.value || '').trim();
            let dxCombined = dxRaw || '';
            if (indicationRaw) {
                dxCombined = dxRaw ? `${dxRaw} (${indicationRaw})` : indicationRaw;
            }

            const admitRaw = (document.getElementById('pAdmitDate')?.value || '').trim();
            const allergyRaw = stripInlineHeaderLabels((document.getElementById('pAllergy')?.value || '').trim());

            const safe = (value) => (value && value.trim() ? value.trim() : '...');

            return [
                'รายงานสรุปจากประวัติอาการเดิม',
                `ผู้ป่วย: ${safe(nameDisplay)}`,
                `Dx: ${safe(dxCombined)}`,
                `Admit: ${safe(admitRaw)}`,
                `Allergy: ${safe(allergyRaw)}`,
                '',
                `บันทึกล่าสุด: ${safe(headerLine)}`,
                formatReportBlock('S', s),
                formatReportBlock('O', o),
                formatReportBlock('A', a),
                formatReportBlock('P', p),
            ].join('\n');
        }

        const REPORT_VIEWS = ['summary', 'table', 'text'];

        function setReportView(view) {
            const nextView = REPORT_VIEWS.includes(view) ? view : 'summary';
            const tabMap = {
                summary: 'reportTabSummary',
                table: 'reportTabTable',
                text: 'reportTabText',
            };
            const viewMap = {
                summary: 'reportViewSummary',
                table: 'reportViewTable',
                text: 'reportViewText',
            };

            Object.entries(tabMap).forEach(([key, id]) => {
                const btn = document.getElementById(id);
                if (!btn) return;
                btn.classList.remove('report-tab-active', 'report-tab-inactive');
                btn.classList.add(key === nextView ? 'report-tab-active' : 'report-tab-inactive');
            });

            Object.entries(viewMap).forEach(([key, id]) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('hidden', key !== nextView);
            });
        }

        function parseEntryTimestamp(headerLine) {
            const clean = (headerLine || '').replace(/^🔻\s*/, '').trim();
            const match = clean.match(/^(\d{1,2}\s+[^\s]+\s+\d{2,4})(?:\s+(\d{1,2}:\d{2}))?/);
            return {
                headerText: clean,
                dateText: match ? match[1] : '',
                timeText: match ? (match[2] || '') : '',
            };
        }

        function extractNumericValue(text, pattern) {
            if (!text) return null;
            const match = text.match(pattern);
            if (!match || match[1] === undefined) return null;
            const value = Number(match[1]);
            return Number.isFinite(value) ? value : null;
        }

        function extractBpValuesFromText(text) {
            const raw = text || '';
            const matches = [...raw.matchAll(/\bBP(?:\s*\d*\)?)?\s*[:=]?\s*([0-9]{2,3}\s*\/\s*[0-9]{2,3})/gi)];
            const values = [];
            matches.forEach((match) => {
                const value = match[1].replace(/\s+/g, '');
                if (value && !values.includes(value)) values.push(value);
            });
            return values;
        }

        function parseBpValue(bpString) {
            const match = (bpString || '').match(/(\d{2,3})\s*\/\s*(\d{2,3})/);
            if (!match) return null;
            const sys = Number(match[1]);
            const dia = Number(match[2]);
            if (!Number.isFinite(sys) || !Number.isFinite(dia)) return null;
            return { sys, dia };
        }

        function parseDtxNumeric(value) {
            const raw = (value || '').trim();
            if (!raw) return null;
            if (/^hi\b/i.test(raw) || /\bhi\b/i.test(raw)) return null;
            const match = raw.match(/([0-9]+(?:\.[0-9])?)/);
            if (!match) return null;
            const num = Number(match[1]);
            return Number.isFinite(num) ? num : null;
        }

        function parseVitalsFromOSection(oSection) {
            const raw = (oSection || '').trim();
            if (!raw) return null;

            const lines = raw
                .split('\n')
                .map((line) => line.trim())
                .filter(Boolean);
            const textInline = lines.join(' ');

            const bt = extractNumericValue(textInline, /\bBT\s*=\s*([0-9]+(?:\.[0-9])?)/i);
            const pr = extractNumericValue(textInline, /\bPR\s*=\s*([0-9]+)/i);
            const rr = extractNumericValue(textInline, /\bRR\s*=\s*([0-9]+)/i);

            const bpValues = extractBpValuesFromText(raw);
            const bpDisplay = bpValues.join(', ');
            const bpParsed = parseBpValue(bpValues[bpValues.length - 1] || '');

            const spo2 = extractNumericValue(raw, /\bSpO2\s*[:=]?\s*([0-9]{2,3})/i);

            const dtxLine = lines.find((line) => /DTX\s*:/i.test(line)) || '';
            const dtxRaw = dtxLine
                .replace(/^[•\-\s]+/, '')
                .replace(/DTX\s*:\s*/i, '')
                .trim();
            const dtxValue = parseDtxNumeric(dtxRaw);

            const hasAny = [bt, pr, rr, bpDisplay, spo2, dtxRaw].some((value) => {
                if (typeof value === 'number') return true;
                return Boolean(value);
            });

            if (!hasAny) return null;

            return {
                bt,
                pr,
                rr,
                bpDisplay,
                bpSys: bpParsed?.sys ?? null,
                bpDia: bpParsed?.dia ?? null,
                spo2,
                dtxRaw,
                dtxValue,
            };
        }

        function buildVitalsTimeline(historyText) {
            const entries = splitHistoryEntries(historyText || '');
            const timeline = [];

            entries.forEach((entry) => {
                const headerLine = entry[0] || '';
                const { headerText, dateText, timeText } = parseEntryTimestamp(headerLine);
                const bodyLines = entry.slice(1);
                const oSection = extractSoapSection(bodyLines, 'O');
                const vitals = parseVitalsFromOSection(oSection);
                if (!vitals) return;
                timeline.push({
                    headerText,
                    dateText,
                    timeText,
                    ...vitals,
                });
            });

            return timeline;
        }

        function formatMetricValue(value, key) {
            if (value === null || value === undefined || value === '') return '-';
            const num = Number(value);
            if (!Number.isFinite(num)) return String(value);
            if (key === 'bt') return num.toFixed(1);
            return String(Math.round(num));
        }

        function isFiniteNumber(value) {
            if (value === null || value === undefined || value === '') return false;
            return Number.isFinite(Number(value));
        }

        function findLatestEntry(timeline, predicate) {
            for (let i = timeline.length - 1; i >= 0; i -= 1) {
                if (predicate(timeline[i])) return timeline[i];
            }
            return null;
        }

        function renderSparkline(container, values, color) {
            if (!container) return;
            container.innerHTML = '';
            const width = 120;
            const height = 36;
            const padding = 3;

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', String(height));

            if (!values.length) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', String(padding));
                line.setAttribute('x2', String(width - padding));
                line.setAttribute('y1', String(height / 2));
                line.setAttribute('y2', String(height / 2));
                line.setAttribute('stroke', '#cbd5f5');
                line.setAttribute('stroke-width', '2');
                svg.appendChild(line);
                container.appendChild(svg);
                return;
            }

            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1;

            const points = values.map((value, index) => {
                const x = padding + (index * (width - padding * 2)) / Math.max(values.length - 1, 1);
                const y = height - padding - ((value - min) / range) * (height - padding * 2);
                return { x, y };
            });

            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', color);
            polyline.setAttribute('stroke-width', '2');
            polyline.setAttribute('points', points.map((pt) => `${pt.x},${pt.y}`).join(' '));
            svg.appendChild(polyline);

            const lastPoint = points[points.length - 1];
            if (lastPoint) {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', String(lastPoint.x));
                circle.setAttribute('cy', String(lastPoint.y));
                circle.setAttribute('r', '2.5');
                circle.setAttribute('fill', color);
                svg.appendChild(circle);
            }

            container.appendChild(svg);
        }

        function renderSparklineDual(container, seriesA, seriesB, colorA, colorB) {
            if (!container) return;
            container.innerHTML = '';
            const width = 120;
            const height = 36;
            const padding = 3;

            const combined = []
                .concat(seriesA || [], seriesB || [])
                .map((value) => Number(value))
                .filter((value) => Number.isFinite(value));

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', String(height));

            if (!combined.length) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', String(padding));
                line.setAttribute('x2', String(width - padding));
                line.setAttribute('y1', String(height / 2));
                line.setAttribute('y2', String(height / 2));
                line.setAttribute('stroke', '#cbd5f5');
                line.setAttribute('stroke-width', '2');
                svg.appendChild(line);
                container.appendChild(svg);
                return;
            }

            const min = Math.min(...combined);
            const max = Math.max(...combined);
            const range = max - min || 1;

            const buildPoints = (values) => {
                const data = Array.isArray(values) ? values : [];
                if (!data.length) return [];
                return data.map((value, index) => {
                    const x = padding + (index * (width - padding * 2)) / Math.max(data.length - 1, 1);
                    const y = height - padding - ((value - min) / range) * (height - padding * 2);
                    return { x, y };
                });
            };

            const drawLine = (points, color) => {
                if (!points.length) return;
                const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                polyline.setAttribute('fill', 'none');
                polyline.setAttribute('stroke', color);
                polyline.setAttribute('stroke-width', '2');
                polyline.setAttribute('points', points.map((pt) => `${pt.x},${pt.y}`).join(' '));
                svg.appendChild(polyline);
            };

            const drawLastPoint = (points, color) => {
                const lastPoint = points[points.length - 1];
                if (!lastPoint) return;
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', String(lastPoint.x));
                circle.setAttribute('cy', String(lastPoint.y));
                circle.setAttribute('r', '2.5');
                circle.setAttribute('fill', color);
                svg.appendChild(circle);
            };

            const pointsA = buildPoints(seriesA);
            const pointsB = buildPoints(seriesB);

            drawLine(pointsB, colorB);
            drawLine(pointsA, colorA);
            drawLastPoint(pointsB, colorB);
            drawLastPoint(pointsA, colorA);

            container.appendChild(svg);
        }

        function renderReportSummary(timeline) {
            const grid = document.getElementById('reportSummaryGrid');
            const empty = document.getElementById('reportSummaryEmpty');
            const rangeEl = document.getElementById('reportSummaryRange');
            if (!grid) return;
            grid.innerHTML = '';

            if (!timeline.length) {
                if (empty) empty.classList.remove('hidden');
                if (rangeEl) {
                    rangeEl.textContent = 'ช่วงเวลา: -';
                    rangeEl.classList.add('hidden');
                }
                return;
            }
            if (empty) empty.classList.add('hidden');
            if (rangeEl) rangeEl.classList.remove('hidden');

            const formatRangeStamp = (entry) => {
                if (!entry) return '-';
                const dateText = (entry.dateText || '').trim();
                const timeText = (entry.timeText || '').trim();
                if (dateText && timeText) return `${dateText} ${timeText}`;
                if (dateText) return dateText;
                if (timeText) return timeText;
                return (entry.headerText || '').trim() || '-';
            };
            if (rangeEl) {
                const firstEntry = timeline[0];
                const lastEntry = timeline[timeline.length - 1];
                const firstStamp = formatRangeStamp(firstEntry);
                const lastStamp = formatRangeStamp(lastEntry);
                const startDate = parseThaiDateInput(firstEntry?.dateText || '');
                const endDate = parseThaiDateInput(lastEntry?.dateText || '');
                const daySpan = calculateLosDays(startDate, endDate);
                let rangeText = `ช่วงเวลา: ${firstStamp} - ${lastStamp}`;
                if (daySpan) rangeText += ` (รวม ${daySpan} วัน)`;
                rangeEl.textContent = rangeText;
            }

            const metrics = [
                { key: 'bt', label: 'BT', unit: '°C', color: '#f97316', valueKey: 'bt' },
                { key: 'pr', label: 'PR', unit: '/min', color: '#ef4444', valueKey: 'pr' },
                { key: 'rr', label: 'RR', unit: '/min', color: '#06b6d4', valueKey: 'rr' },
                { key: 'bp', label: 'BP', unit: 'mmHg', color: '#6366f1', valueKey: 'bpSys', displayKey: 'bpDisplay' },
                { key: 'spo2', label: 'SpO2', unit: '%', color: '#0ea5e9', valueKey: 'spo2' },
                { key: 'dtx', label: 'DTX', unit: 'mg%', color: '#2563eb', valueKey: 'dtxValue', displayKey: 'dtxRaw' },
            ];

            metrics.forEach((metric) => {
                const series = timeline
                    .map((entry) => entry[metric.valueKey])
                    .filter(isFiniteNumber)
                    .map((value) => Number(value));
                const lastEntry = findLatestEntry(timeline, (entry) => {
                    const displayVal = metric.displayKey ? entry[metric.displayKey] : entry[metric.valueKey];
                    return displayVal !== null && displayVal !== undefined && displayVal !== '';
                });
                const lastDisplay = lastEntry
                    ? (metric.displayKey ? lastEntry[metric.displayKey] : formatMetricValue(lastEntry[metric.valueKey], metric.key))
                    : '-';

                let bpSeries = null;
                let bpDiaSeries = null;
                if (metric.key === 'bp') {
                    const bpEntries = timeline.filter((entry) =>
                        isFiniteNumber(entry.bpSys) && isFiniteNumber(entry.bpDia)
                    );
                    bpSeries = bpEntries.map((entry) => Number(entry.bpSys));
                    bpDiaSeries = bpEntries.map((entry) => Number(entry.bpDia));
                }

                const card = document.createElement('div');
                card.className = 'report-card';

                const header = document.createElement('div');
                header.className = 'flex items-center justify-between text-xs font-bold';
                header.style.color = metric.color;
                header.innerHTML = `<span>${metric.label}</span><span>${metric.unit}</span>`;

                const value = document.createElement('div');
                value.className = 'text-lg font-bold text-gray-900';
                value.textContent = String(lastDisplay || '-');

                const sparkline = document.createElement('div');
                sparkline.className = 'report-sparkline';
                if (metric.key === 'bp') {
                    renderSparklineDual(sparkline, bpSeries, bpDiaSeries, metric.color, '#a5b4fc');
                } else {
                    renderSparkline(sparkline, series, metric.color);
                }

                const meta = document.createElement('div');
                meta.className = 'text-xs text-gray-500';
                if (metric.key === 'bp') {
                    const sysSeries = bpSeries || [];
                    const diaSeries = bpDiaSeries || [];
                    const buildRangeText = (label, values) => {
                        if (!values.length) return '';
                        const minVal = Math.min(...values);
                        const maxVal = Math.max(...values);
                        return `${label} ${formatMetricValue(minVal, 'bp')}-${formatMetricValue(maxVal, 'bp')}`;
                    };
                    const sysText = buildRangeText('SBP', sysSeries);
                    const diaText = buildRangeText('DBP', diaSeries);
                    if (sysText && diaText) {
                        meta.textContent = `${sysText} / ${diaText}`;
                    } else if (sysText) {
                        meta.textContent = sysText;
                    } else if (diaText) {
                        meta.textContent = diaText;
                    } else {
                        meta.textContent = 'ยังไม่มีข้อมูลต่อเนื่อง';
                    }
                } else if (series.length) {
                    const min = Math.min(...series);
                    const max = Math.max(...series);
                    meta.textContent = `min ${formatMetricValue(min, metric.key)} / max ${formatMetricValue(max, metric.key)}`;
                } else {
                    meta.textContent = 'ยังไม่มีข้อมูลต่อเนื่อง';
                }

                card.appendChild(header);
                card.appendChild(value);
                card.appendChild(sparkline);
                card.appendChild(meta);
                grid.appendChild(card);
            });
        }

        function appendReportCell(row, text, align = 'center') {
            const td = document.createElement('td');
            td.className = 'px-2 py-2 whitespace-nowrap';
            if (align === 'left') {
                td.classList.add('text-left');
            } else if (align === 'right') {
                td.classList.add('text-right');
            } else {
                td.classList.add('text-center');
            }
            td.textContent = text;
            row.appendChild(td);
        }

        function renderReportTable(timeline) {
            const body = document.getElementById('reportVitalsTableBody');
            const empty = document.getElementById('reportTableEmpty');
            if (!body) return;
            body.innerHTML = '';

            if (!timeline.length) {
                if (empty) empty.classList.remove('hidden');
                return;
            }
            if (empty) empty.classList.add('hidden');

            const rows = timeline.slice().reverse();
            rows.forEach((entry) => {
                const row = document.createElement('tr');
                appendReportCell(row, entry.dateText || '-', 'center');
                appendReportCell(row, entry.timeText || '-', 'center');
                appendReportCell(row, formatMetricValue(entry.bt, 'bt'), 'center');
                appendReportCell(row, formatMetricValue(entry.pr, 'pr'), 'center');
                appendReportCell(row, formatMetricValue(entry.rr, 'rr'), 'center');
                appendReportCell(row, entry.bpDisplay || '-', 'center');
                appendReportCell(row, formatMetricValue(entry.spo2, 'spo2'), 'center');
                appendReportCell(row, entry.dtxRaw || '-', 'left');
                body.appendChild(row);
            });
        }

        function openHistoryReport() {
            const report = buildHistoryReportText();
            if (!report) {
                showToast('ยังไม่มีประวัติอาการเดิมให้สรุป', 'warning');
                return;
            }
            const historyText = document.getElementById('historyPart')?.value || '';
            const timeline = buildVitalsTimeline(historyText);
            const output = document.getElementById('reportOutput');
            const modal = document.getElementById('reportModal');
            if (output) output.value = report;
            renderReportSummary(timeline);
            renderReportTable(timeline);
            setReportView(timeline.length ? 'summary' : 'text');
            if (modal) modal.classList.remove('hidden');
            setTimeout(() => {
                if (output) output.focus();
            }, 50);
        }

        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            if (modal) modal.classList.add('hidden');
        }

        function copyReportToClipboard() {
            const output = document.getElementById('reportOutput');
            if (!output) return;
            const text = output.value || '';
            if (!text.trim()) {
                showToast('ยังไม่มีรายงานให้คัดลอก', 'warning');
                return;
            }

            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                navigator.clipboard.writeText(text)
                    .then(() => showToast('คัดลอกรายงานแล้ว'))
                    .catch(() => {
                        output.select();
                        try {
                            document.execCommand('copy');
                            showToast('คัดลอกรายงานแล้ว');
                        } catch (_) {
                            showToast('คัดลอกไม่สำเร็จ', 'error');
                        }
                    });
                return;
            }

            output.select();
            try {
                document.execCommand('copy');
                showToast('คัดลอกรายงานแล้ว');
            } catch (_) {
                showToast('คัดลอกไม่สำเร็จ', 'error');
            }
        }

        // --- HELPER: Copy Admit Meds to Header ---
        function copyAdmitMedsToHeader() {
            const admitMeds = document.getElementById('inputCont_Admit').value.trim();
            if (!admitMeds) {
                showToast("ไม่มีข้อมูลในช่อง Continuous Order ให้คัดลอก", "warning");
                return;
            }

            // Clear old text and set new text immediately (No confirmation)
            setMedsContent(admitMeds);

            // Trigger update to render text view
            updateHeaderFromForm();

            // Reset verification status since meds changed
            document.getElementById('medsVerified').checked = false;
            updateMedsStatus();
            markMedsDirty();

            showToast("อัปเดตรายการยาปัจจุบันเรียบร้อย!");
            markDirty();
            saveFormState();
        }

        // --- NEW CONFIRMATION SYSTEM (Replaces blocked window.confirm) ---
        function openResetConfirmation() {
            document.getElementById('newCaseModal').classList.remove('hidden');
        }

        function openClearFormConfirmation() {
            document.getElementById('clearFormModal').classList.remove('hidden');
        }

        function closeConfirmation() {
            document.getElementById('newCaseModal').classList.add('hidden');
            document.getElementById('clearFormModal').classList.add('hidden');
            document.getElementById('safetyCheckModal').classList.add('hidden');
        }

        function executeClearForm() {
            resetFormFields();
            initDate({ force: true });
            closeConfirmation();
            saveFormState();
        }

        function resetFormFields() {
            // Removed 'inputAllergy_Admit' from the list
            const ids = ['inputS', 'valBP', 'valT', 'valP', 'valR', 'valDTX', 'valDTX_Hr', 'valSpO2', 'valUrine', 'valStool', 'inputO_Extra', 'inputAP', 'inputOneDay_Admit', 'inputCont_Admit', 'inputPlanMx_Admit', 'medsChangedList', 'medsChangeBaseline'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            updateBpCountBadge();
            // Reset DTX Type selection (no default)
            const prevRestoring = isRestoringForm;
            isRestoringForm = true;
            setDtxType('');
            setDtxHiState(false);
            isRestoringForm = prevRestoring;
            // Reset Assessment (A)
            const assessInput = document.getElementById('assessmentStatus');
            if (assessInput) assessInput.value = '';
            const watch = document.getElementById('assessmentWatch');
            if (watch) watch.checked = false;
            const risk = document.getElementById('assessmentRisk');
            if (risk) risk.checked = false;
            const medsChanged = document.getElementById('medsChanged');
            if (medsChanged) medsChanged.checked = false;
            setMedsEditorEditable(false);
            updateMedsChangeSummary();
            updateAdmissionSummary();
            updateAssessmentButtons('');
            markDirty();
        }

        function resetCaseForImport() {
            hasGenerated = false;
            clearDirtyState();
            clearFormState();
            setHeaderSectionHidden(false, { persist: false });

            const headerPart = document.getElementById('headerPart');
            const historyPart = document.getElementById('historyPart');
            if (headerPart) headerPart.value = "";
            if (historyPart) historyPart.value = "";
            checkHistoryVisibility();

            document.getElementById('pFName').value = "";
            document.getElementById('pAge').value = "";
            document.getElementById('pDx').value = "";
            document.getElementById('pIndication').value = "";
            document.getElementById('pAllergy').value = "";
            document.getElementById('pNote').value = "";
            const ccEl = document.getElementById('inputCC');
            const hpiEl = document.getElementById('inputHPI');
            const pmhEl = document.getElementById('inputPMH');
            const fhxEl = document.getElementById('inputFHx');
            if (ccEl) ccEl.value = "";
            if (hpiEl) hpiEl.value = "";
            if (pmhEl) pmhEl.value = "";
            if (fhxEl) fhxEl.value = "";
            const allergyError = document.getElementById('allergyError');
            if (allergyError) allergyError.classList.add('hidden');
            document.getElementById('pAllergy').classList.remove('ring-error');
            setMedsContent('');

            resetFormFields();
            document.getElementById('outputArea').value = "";
            document.getElementById('resultSection').classList.add('hidden');

            document.getElementById('medsVerified').checked = false;
            updateMedsStatus();
            setMedsUpdateDate('', { persist: false });
            medsDirty = false;

            hasManualTime = false;
            initDate({ force: true });
            setTipsMode('existing');
        }

        // --- CORE NEW CASE LOGIC (No Alert/Confirm - Uses Modal) ---
        function executeNewCase() {
            closeConfirmation();

            try {
                console.log('Execute New Case Triggered');
                hasGenerated = false;
                clearDirtyState();
                clearFormState();
                setHeaderSectionHidden(false, { persist: false });

                // 1. Reset Storage
                document.getElementById('headerPart').value = "";
                document.getElementById('historyPart').value = "";
                checkHistoryVisibility();

                // 2. Clear Header Inputs Manually
                document.getElementById('pFName').value = "";
                document.getElementById('pAge').value = "";
                document.getElementById('pDx').value = "";
                document.getElementById('pIndication').value = "";

                document.getElementById('pAllergy').value = "";
                document.getElementById('pNote').value = "";
                // Clear baseline Admission History fields
                const ccEl = document.getElementById('inputCC');
                const hpiEl = document.getElementById('inputHPI');
                const pmhEl = document.getElementById('inputPMH');
                const fhxEl = document.getElementById('inputFHx');
                if (ccEl) ccEl.value = "";
                if (hpiEl) hpiEl.value = "";
                if (pmhEl) pmhEl.value = "";
                if (fhxEl) fhxEl.value = "";
                const allergyError = document.getElementById('allergyError');
                if (allergyError) allergyError.classList.add('hidden');
                document.getElementById('pAllergy').classList.remove('ring-error');
                setMedsContent('');

                // 3. Set Dates (Manual Logic - Independent of initDate)
                const today = new Date();
                const day = today.getDate();
                const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
                const monthShort = months[today.getMonth()];
                const year = (today.getFullYear() + 543).toString().slice(-2);

                document.getElementById('pAdmitDate').value = `${day} ${monthShort} ${year}`;
                document.getElementById('logDate').value = `${day} ${monthShort} ${year}`;
                const timeEl = document.getElementById('logTime');
                if (timeEl) timeEl.value = formatTimeHHMM(today);

                // 4. Clear Body Inputs
                resetFormFields();
                document.getElementById('outputArea').value = "";
                document.getElementById('resultSection').classList.add('hidden');

                // 5. Force View & Meds Status
                document.getElementById('medsVerified').checked = false;
                const medsChanged = document.getElementById('medsChanged');
                if (medsChanged) medsChanged.checked = false;
                updateMedsStatus();
                setMedsUpdateDate('', { persist: false });
                medsDirty = false;
                switchHeaderView('form', { skipParse: true });

                // 6. FORCE ADMIT MODE ON
                toggleAdmitMode(true);

                // 7. Focus Logic
                window.scrollTo(0, 0);
                setTimeout(() => {
                    const nameInput = document.getElementById('pFName');
                    if (nameInput) {
                        nameInput.focus();
                        nameInput.click();
                    }
                }, 150);

                hasManualTime = false;
                showToast("เริ่มเคสใหม่เรียบร้อย!");
                setTipsMode('new');
                saveFormState();
            } catch (err) {
                console.error("Error in executeNewCase: ", err);
                showToast("เกิดข้อผิดพลาดในการเริ่มเคสใหม่", "error");
            }
        }

        // --- NEW START BUTTON HANDLER ---
        function startNewCase() {
            // No native confirm() here. Open modal instead.
            openResetConfirmation();
        }

        function triggerClearToday() {
            openClearFormConfirmation();
        }

        function isPlaceholderHeader(text) {
            const normalized = (text || '').trim();
            if (!normalized) return true;

            const baseHeaders = [defaultHeader, blankTemplate].map((value) => (value || '').trim());
            if (baseHeaders.includes(normalized)) return true;

            const lines = normalized.split('\n').map((line) => line.trim()).filter(Boolean);
            let hasRealData = false;

            lines.forEach((line) => {
                if (hasRealData) return;
                if (/^=+/.test(line)) return;

                if (/^ผู้ป่วย:/i.test(line)) {
                    const val = line.replace(/^ผู้ป่วย:\s*/i, '').replace(/\(.*?\)/g, '').trim();
                    if (val && val !== '...' && val !== 'ชื่อ-นามสกุล') hasRealData = true;
                    return;
                }

                if (/^Dx:/i.test(line)) {
                    const val = line.replace(/^Dx:\s*/i, '').trim();
                    if (val && val !== '...') hasRealData = true;
                    return;
                }

                if (/^Admit:/i.test(line)) {
                    const val = line.replace(/^Admit:\s*/i, '').trim();
                    if (val && val !== '...') hasRealData = true;
                    return;
                }

                if (/^(CC|HPI|PH|FHx|Allergy):/i.test(line)) {
                    const val = line.replace(/^(CC|HPI|PH|FHx|Allergy):\s*/i, '').trim();
                    if (val && val !== '...') hasRealData = true;
                    return;
                }

                if (/^💊/.test(line)) {
                    const dateMatch = line.match(/\(([^)]+)\)/);
                    if (dateMatch && /\d/.test(dateMatch[1])) hasRealData = true;
                    return;
                }

                if (/^[•\-]/.test(line)) {
                    if (!line.includes('ยังไม่มีรายการยา') && !line.includes('...')) hasRealData = true;
                    return;
                }

                hasRealData = true;
            });

            return !hasRealData;
        }

        function hasExistingCaseData() {
            const history = document.getElementById('historyPart')?.value?.trim() || '';
            if (history) return true;

            const formIds = [
                'pFName', 'pAge', 'pDx', 'pIndication', 'pAdmitDate', 'pAllergy', 'pNote', 'pMedsCont',
                'inputCC', 'inputHPI', 'inputPMH', 'inputFHx',
            ];
            const hasFormData = formIds.some((id) => (document.getElementById(id)?.value || '').trim());
            if (hasFormData) return true;

            const headerText = document.getElementById('headerPart')?.value || '';
            return !isPlaceholderHeader(headerText);
        }

        function startExistingCase(options = {}) {
            const { skipImportPrompt = false } = options;
            const shouldPromptImport = !skipImportPrompt && !hasExistingCaseData();
            switchHeaderView('form');
            toggleAdmitMode(false);
            const el = document.getElementById('dailyEntrySection');
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTipsMode('existing');
            showToast('พร้อมทำรายงานเคสเดิมแล้ว', 'info');
            saveFormState();
            if (shouldPromptImport) {
                openImportModal();
            }
        }

        function generateLog() {
            // VALIDATION: Time must be selected
            const timeEl = document.getElementById('logTime');
            const timeGroup = document.getElementById('timePickerGroup');
            const timeVal = (timeEl?.value || '').trim();
            if (!timeVal) {
                if (timeGroup) timeGroup.classList.add('ring-error');
                if (timeEl) timeEl.classList.add('ring-error');
                setTimeout(() => {
                    if (timeGroup) timeGroup.classList.remove('ring-error');
                    if (timeEl) timeEl.classList.remove('ring-error');
                }, 1000);
                showToast("กรุณาเลือกเวลา ก่อนสร้างข้อความ", "error");
                if (timeGroup) timeGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // VALIDATION: Allergy must be filled
            const allergy = document.getElementById('pAllergy').value.trim();
            if (!allergy) {
                // Switch to form view ensuring input is visible
                switchHeaderView('form');
                const allergyInput = document.getElementById('pAllergy');
                const allergyError = document.getElementById('allergyError');
                if (allergyError) allergyError.classList.remove('hidden');

                // VISUAL FEEDBACK FOR ALLERGY
                setTimeout(() => {
                    allergyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    allergyInput.classList.add('ring-error');
                    allergyInput.focus();
                    setTimeout(() => allergyInput.classList.remove('ring-error'), 1000);
                }, 100); // Small delay to allow view switch

                showToast("กรุณาระบุประวัติการแพ้ยา (หากไม่มีให้พิมพ์ “ปฏิเสธ” หรือ “-”)", "error");
                return;
            }

            // VALIDATION: DTX type must be selected if DTX value is filled
            const dtxVal = document.getElementById('valDTX')?.value?.trim() || '';
            const dtxType = document.getElementById('dtxType')?.value?.trim() || '';
            if (dtxVal && !dtxType) {
                const dtxGroup = document.getElementById('dtxTypeButtonGroup');
                const dtxError = document.getElementById('dtxTypeError');
                if (dtxError) dtxError.classList.remove('hidden');

                if (dtxGroup) {
                    dtxGroup.classList.add('ring-error');
                    setTimeout(() => dtxGroup.classList.remove('ring-error'), 1000);
                    dtxGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                showToast("กรุณาเลือกช่วงเวลาเจาะ DTX: ก่อน/หลัง/สุ่ม", "error");
                return;
            }

            if (!document.getElementById('medsVerified').checked) {
                // Open Safety Modal instead of native confirm
                document.getElementById('safetyCheckModal').classList.remove('hidden');
                // Scroll to meds to visually indicate
                switchHeaderView('form');
                document.getElementById('medsContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
                const container = document.getElementById('medsContainer');
                container.classList.add('ring-4', 'ring-red-400');
                setTimeout(() => container.classList.remove('ring-4', 'ring-red-400'), 1000);
                return;
            }
            executeGenerateLog();
        }

        function handleBulletKeydown(e) {
            if (e.key === 'Enter') {
                const textarea = e.target;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;
                const before = value.substring(0, start);
                const after = value.substring(end);

                // Find current line
                const lastLineIndex = before.lastIndexOf('\n');
                const currentLine = before.substring(lastLineIndex + 1);

                // Check if current line starts with bullet
                if (/^[\u2022\u25cf\u25cb\-\*]\s/.test(currentLine)) {
                    e.preventDefault();
                    // If line is ONLY bullet, remove it (end of list)
                    if (/^[\u2022\u25cf\u25cb\-\*]\s*$/.test(currentLine)) {
                        textarea.value = value.substring(0, lastLineIndex + 1) + after;
                        textarea.selectionStart = textarea.selectionEnd = lastLineIndex + 1;
                    } else {
                        // Insert new bullet
                        const bullet = currentLine.match(/^[\u2022\u25cf\u25cb\-\*]\s/)[0];
                        const newValue = before + '\n' + bullet + after;
                        textarea.value = newValue;
                        textarea.selectionStart = textarea.selectionEnd = start + 1 + bullet.length;
                    }
                }
            }
        }

        function seedBulletOnFocus(e) {
            const textarea = e?.target;
            if (!textarea || textarea.dataset.autobullet !== 'true') return;
            if (textarea.value.trim() !== '') return;
            textarea.value = '• ';
            if (typeof textarea.setSelectionRange === 'function') {
                const pos = textarea.value.length;
                textarea.setSelectionRange(pos, pos);
            }
        }

        function confirmSafetyCheck() {
            document.getElementById('medsVerified').checked = true;
            updateMedsStatus();
            document.getElementById('safetyCheckModal').classList.add('hidden');
            executeGenerateLog();
        }

        function cancelSafetyCheck() {
            document.getElementById('safetyCheckModal').classList.add('hidden');
        }

        function executeGenerateLog() {
            saveData();
            const header = document.getElementById('headerPart').value.trim();
            const history = document.getElementById('historyPart').value.trim();
            const date = document.getElementById('logDate').value;
            const logTimeEl = document.getElementById('logTime');
            let time = logTimeEl?.value?.trim() || '';
            if (logTimeEl && !time) {
                time = formatTimeHHMM(new Date());
                logTimeEl.value = time;
            }
            const isAdmit = document.getElementById('isAdmitMode').value === 'true';

            // Define Indentation (3 spaces for SOAP multiline)
            const SOAP_INDENT = "   ";

            // Helper to add • bullets (Only if starts with -)
            const addBullets = (text) => {
                if (!text) return "";
                return text
                    .split('\n')
                    .map(line => line.trim())
                    .filter(Boolean)
                    .map(line => {
                        if (line.startsWith('-')) return '• ' + line.replace(/^-+\s*/, '');
                        return line; // Do not force bullet if user didn't type it
                    })
                    .join('\n');
            };

            // Helper: Format Plan text as "P: • ..." with aligned bullets (4 spaces)
            const P_ALIGN = "    ";
            const formatPBlock = (text) => {
                const bulletText = addBullets(text);
                if (!bulletText) return "";
                const lines = bulletText.split('\n');
                return lines
                    .map((line, idx) => (idx === 0 ? `P: ${line}` : `${P_ALIGN}${line}`))
                    .join('\n');
            };

            const assessStatus = document.getElementById('assessmentStatus')?.value?.trim() || '';
            const assessWatch = document.getElementById('assessmentWatch')?.checked;
            const assessRisk = document.getElementById('assessmentRisk')?.checked;
            const aParts = [];
            if (assessStatus) aParts.push(assessStatus);
            if (assessWatch) aParts.push('เฝ้าดูอาการใกล้ชิด');
            if (assessRisk) aParts.push('เสี่ยงเกิดภาวะแทรกซ้อน');
            const aLine = aParts.length ? `A: ${aParts.join(', ')}` : "";

            let pFinal = "";
            const medsChangedLines = getMedsChangedLines();

            if (isAdmit) {
                const ORDER_INDENT = "  ";
                const oneDay = document.getElementById('inputOneDay_Admit').value.trim();
                const cont = document.getElementById('inputCont_Admit').value.trim();
                const planMx = document.getElementById('inputPlanMx_Admit').value.trim();

                const indentWith = (text, indent) => {
                    if (!text) return "";
                    return text.split('\n').map(line => indent + line).join('\n');
                };

                const blocks = [];
                if (oneDay) blocks.push(`One Day Order:\n${indentWith(addBullets(oneDay), ORDER_INDENT)}`);
                if (cont) blocks.push(`Continuous Order:\n${indentWith(addBullets(cont), ORDER_INDENT)}`);
                if (planMx) blocks.push(formatPBlock(planMx));

                pFinal = blocks.join('\n');
            } else {
                const rawP = document.getElementById('inputAP').value.trim();
                const combinedP = [rawP, medsChangedLines.join('\n')].filter(Boolean).join('\n');
                if (combinedP) pFinal = formatPBlock(combinedP);
            }

            const s = document.getElementById('inputS').value.trim();
            const formatSoapBlock = (label, text) => {
                const cleaned = (text || '').trim();
                if (!cleaned) return "";
                const lines = cleaned
                    .split('\n')
                    .map(line => line.trim())
                    .filter(Boolean);
                if (!lines.length) return "";
                return lines
                    .map((line, idx) => (idx === 0 ? `${label}: ${line}` : `${SOAP_INDENT}${line}`))
                    .join('\n');
            };

            const bpRaw = document.getElementById('valBP').value.trim();
            const bpValues = parseBpReadings(bpRaw);
            const bpLines = [];
            if (bpValues.length > 1) {
                bpValues.forEach((val, idx) => {
                    bpLines.push(`BP ${idx + 1}) ${val}`);
                });
            }
            const t = document.getElementById('valT').value.trim();
            const p = document.getElementById('valP').value.trim();
            const r = document.getElementById('valR').value.trim();

            // Updated DTX Generation Logic (Simplified format)
            const dtxVal = document.getElementById('valDTX').value.trim();
            let dtxStr = "";
            if (dtxVal) {
                const type = document.getElementById('dtxType').value.trim();
                const hrs = document.getElementById('valDTX_Hr').value.trim();
                const isDtxHi = dtxVal.toUpperCase() === 'HI';

                let contextStr = "";
                if (type === 'AC') {
                    // Result: (ก่อนอาหาร 3 ชม.) or (ก่อนอาหาร)
                    contextStr = hrs ? `ก่อนอาหาร ${hrs} ชม.` : `ก่อนอาหาร`;
                } else if (type === 'PC') {
                    // Result: (หลังอาหาร 3 ชม.) or (หลังอาหาร)
                    contextStr = hrs ? `หลังอาหาร ${hrs} ชม.` : `หลังอาหาร`;
                } else if (type === 'R') {
                    contextStr = `Random`;
                }

                const dtxLabel = isDtxHi ? 'HI' : `${dtxVal} mg%`;
                dtxStr = contextStr ? `${dtxLabel} (${contextStr})` : dtxLabel;
            }

            const spo2 = document.getElementById('valSpO2').value.trim();
            const urine = document.getElementById('valUrine').value.trim();
            const stool = document.getElementById('valStool').value.trim();
            const oExtra = document.getElementById('inputO_Extra').value.trim();

            let oLines = [];
            let vsParts = [];
            if (t) vsParts.push(`BT=${t}`);
            if (p) vsParts.push(`PR=${p}`);
            if (r) vsParts.push(`RR=${r}`);
            if (bpValues.length === 1) vsParts.push(`BP=${bpValues[0]}`);

            const vsInline = vsParts.length ? `${vsParts.join(', ')}` : "";
            if (bpLines.length) oLines.push(...bpLines);
            // Keep excretion on its own line after V/S (no bullet)
            const excParts = [];
            if (urine) excParts.push(`ปัสสาวะ ${urine} ครั้ง`);
            if (stool) excParts.push(`ถ่าย ${stool} ครั้ง`);
            if (excParts.length) oLines.push(excParts.join(', '));
            if (dtxStr) oLines.push(`• DTX: ${dtxStr}`);
            if (spo2) oLines.push(`• SpO2: ${spo2}%`);

            if (oExtra) {
                oExtra
                    .split('\n')
                    .map(line => line.trim())
                    .filter(Boolean)
                    .forEach((line) => oLines.push(line));
            }

            // Apply Indent to all O lines (except V/S which is shown inline with O:)
            const oFinal = oLines.map(line => SOAP_INDENT + line).join('\n');

            let logHeaderLine = `🔻 ${date}${time ? ' ' + time : ''}`;
            if (isAdmit) logHeaderLine += " (แรกรับ)";

            let newEntry = `${logHeaderLine}\n`;
            const sBlock = formatSoapBlock('S', s);
            if (sBlock) newEntry += `${sBlock}\n`;
            if (vsInline || oFinal) {
                newEntry += vsInline ? `O: ${vsInline}\n` : `O:\n`;
                if (oFinal) newEntry += `${oFinal}\n`;
            }
            const apParts = [];
            const aBlock = formatSoapBlock('A', aLine ? aLine.replace(/^A:\s*/, '') : '');
            if (aBlock) apParts.push(aBlock);
            if (pFinal) apParts.push(pFinal);
            const apText = apParts.join('\n');
            if (apText) newEntry += apText;

            const separator = "==============";

            // Updated Logic: 
            // 1. Shortened the separator line.
            // 2. Smart Check: Add separator if it's the FIRST entry of that DATE.
            // 3. Same day entries get standard double-spacing (\n\n) for readability.
            let spacer = "\n\n"; // Default spacing (1 blank line)

            // Check if current date string is already in history
            const isFirstEntryOfDay = !history.includes(date);

            if (history !== "" && isFirstEntryOfDay) {
                spacer = "\n\n-----------------\n";
            }

            let fullLog = history === "" ? `${header}\n${separator}\n${newEntry}` : `${header}\n${separator}\n${history}${spacer}${newEntry}`;

            document.getElementById('outputArea').value = fullLog;
            document.getElementById('resultSection').classList.remove('hidden');
            setTimeout(() => document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            hasGenerated = true;
            clearDirtyState();
        }

        function copyToClipboard() {
            const copyText = document.getElementById("outputArea");
            copyText.select();

            const onSuccess = () => {
                // Show Big Modal
                const modal = document.getElementById('copySuccessModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    // Auto close fallback
                    setTimeout(() => { if (!modal.classList.contains('hidden')) { /* Optional auto close? No, let them feel successful. */ } }, 3000);
                } else {
                    showToast("คัดลอกเรียบร้อย!");
                }
            };

            try { document.execCommand('copy'); onSuccess(); }
            catch (err) { navigator.clipboard.writeText(copyText.value).then(onSuccess); }
        }

        function closeCopyModal() {
            const modal = document.getElementById('copySuccessModal');
            if (modal) modal.classList.add('hidden');
        }

        function shareToLine() {
            const text = document.getElementById('outputArea')?.value?.trim();
            if (!text) {
                showToast("ยังไม่มีข้อความให้แชร์", "warning");
                return;
            }
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
            window.open(lineUrl, '_blank');
        }

        function showToast(message, type = "success") {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            document.getElementById('toastMsg').innerText = message;

            if (icon) {
                let iconName = "check-circle";
                let color = "#86efac"; // green-300
                if (type === "error") {
                    iconName = "exclamation-circle";
                    color = "#fecaca"; // red-200
                } else if (type === "warning") {
                    iconName = "exclamation-triangle";
                    color = "#fde68a"; // yellow-200
                } else if (type === "info") {
                    iconName = "info-circle";
                    color = "#bfdbfe"; // blue-200
                }
                icon.className = `fas fa-${iconName} mr-2`;
                icon.style.color = color;
            }

            toast.classList.remove('hidden');
            if (toast._timer) clearTimeout(toast._timer);
            toast._timer = setTimeout(() => toast.classList.add('hidden'), 3500);
        }

        const TIPS_DETAIL_STORAGE_KEY = 'patientLog_tipsDetail';
        let tipsModeState = 'existing';
        let tipsDetailState = false;

        function updateCaseModeToggle() {
            const isNew = tipsModeState === 'new';
            const badge = document.getElementById('caseModeBadge');

            if (badge) {
                badge.textContent = isNew ? 'รับเคสใหม่' : 'เคสเดิม';
                badge.classList.toggle('mode-badge-new', isNew);
                badge.classList.toggle('mode-badge-existing', !isNew);
            }
        }

        function updateTipsTitle() {
            const title = document.getElementById('tipsTitle');
            if (!title) return;
            const modeText = tipsModeState === 'new' ? 'เคสใหม่' : 'เคสเดิม';
            title.textContent = `วิธีใช้ (${modeText})`;
        }

        function setTipsDetail(isDetailed, { persist = true } = {}) {
            tipsDetailState = Boolean(isDetailed);
            const btn = document.getElementById('tipsToggleBtn');
            const container = document.getElementById('tipsContainer');
            if (btn) {
                btn.setAttribute('aria-pressed', tipsDetailState ? 'true' : 'false');
                btn.setAttribute('aria-expanded', tipsDetailState ? 'true' : 'false');
                btn.setAttribute('aria-label', tipsDetailState ? 'ซ่อนวิธีใช้' : 'แสดงวิธีใช้');
                btn.classList.toggle('bg-white', !tipsDetailState);
                btn.classList.toggle('border-gray-200', !tipsDetailState);
                btn.classList.toggle('text-blue-700', !tipsDetailState);
                btn.classList.toggle('bg-amber-100', tipsDetailState);
                btn.classList.toggle('border-amber-200', tipsDetailState);
                btn.classList.toggle('text-amber-700', tipsDetailState);
            }
            if (container) container.classList.toggle('hidden', !tipsDetailState);

            if (persist) {
                localStorage.setItem(TIPS_DETAIL_STORAGE_KEY, tipsDetailState ? '1' : '0');
            }
            updateTipsTitle();
            updateTipsVisibility();
        }

        function toggleTipsDetail() {
            setTipsDetail(!tipsDetailState);
        }

        function setTipsMode(mode) {
            const isNew = mode === 'new';
            tipsModeState = isNew ? 'new' : 'existing';
            updateTipsTitle();
            updateTipsVisibility();
            updateCaseModeToggle();
            updateHeaderSaveButtonVisibility();
        }

        function updateTipsVisibility() {
            const existingList = document.getElementById('tipsExisting');
            const newList = document.getElementById('tipsNew');
            const isNew = tipsModeState === 'new';

            if (existingList) existingList.classList.toggle('hidden', isNew);
            if (newList) newList.classList.toggle('hidden', !isNew);
        }

        function handleCaseModeExisting() {
            if (tipsModeState === 'existing') return;
            startExistingCase();
        }

        function handleCaseModeNew() {
            if (tipsModeState === 'new') return;
            startNewCase();
        }

        function initTipsMode() {
            const header = document.getElementById('headerPart')?.value?.trim() || '';
            const isDefault = !header || header === defaultHeader.trim();
            setTipsMode(isDefault ? 'new' : 'existing');
        }

        function updateHeaderSaveButtonVisibility() {
            const btn = document.getElementById('headerSaveHideBtn');
            if (!btn) return;
            btn.classList.toggle('hidden', tipsModeState !== 'existing');
        }

        function initTipsDetail() {
            const stored = localStorage.getItem(TIPS_DETAIL_STORAGE_KEY);
            const isDetailed = stored === '1';
            setTipsDetail(isDetailed, { persist: false });
        }

        function initAdvancedMode() {
            const stored = localStorage.getItem(ADVANCED_MODE_STORAGE_KEY);
            const isEnabled = stored === '1';
            setAdvancedMode(isEnabled, { persist: false, syncView: false });
        }

        window.onload = function () {
            initFontSize();
            loadData();
            initTipsMode();
            initTipsDetail();
            initAdvancedMode();
            initDirtyTracking();
            loadFormState();
            syncMedsEditorState();
            initMedsUpdateDate();
            initNumericInputs();
            initDate();
            updateBpCountBadge();
            updateMedsStatus();
            renderMedsInlineChanges();
            updateMedsChangeSummary();
            updateAdmissionSummary();
            updateGenerateButtonState();
            const timeInput = document.getElementById('logTime');
            if (timeInput) {
                timeInput.addEventListener('input', () => { hasManualTime = true; saveFormState(); });
                timeInput.addEventListener('change', () => { hasManualTime = true; saveFormState(); });
            }
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) setCurrentTime();
            });
            setInterval(() => {
                if (!document.hidden) setCurrentTime();
            }, 60000);
            document.getElementById('headerPart').addEventListener('input', saveData);
            document.getElementById('historyPart').addEventListener('input', saveData);
        };
    </script>
</body>

</html>
