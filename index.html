<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Daily Log Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; color: #111827; font-weight: 400; line-height: 1.5; }
        .line-green { color: #06c755; }
        .bg-line-green { background-color: #06c755; }
        .bg-line-dark { background-color: #05a546; }

        :focus-visible { outline: 3px solid rgba(6, 199, 85, 0.65); outline-offset: 2px; }
        
        /* Active Shift Button Style */
        .shift-btn-active {
            background-color: #06c755;
            color: white;
            border-color: #06c755;
        }
        .shift-btn-inactive {
            background-color: white;
            color: #4b5563;
            border-color: #d1d5db;
        }
        .shift-btn-inactive:hover {
            background-color: #f3f4f6;
        }

        /* Chrome, Safari, Edge, Opera - Remove inner spin button for number inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        
        .tab-active {
            padding: 0.35rem 0.6rem;
            border-radius: 0.5rem;
            border-bottom: 2px solid #06c755;
            color: #06c755;
            font-weight: bold;
        }
        .tab-inactive {
            padding: 0.35rem 0.6rem;
            border-radius: 0.5rem;
            color: #374151;
        }
        #tabForm:hover, #tabText:hover { background-color: #e5e7eb; }

        /* Animations */
        @keyframes pulse-once {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.95; transform: scale(0.99); background-color: #eff6ff; } /* Light blue flash */
        }
        .animate-pulse-once {
            animation: pulse-once 0.5s ease-in-out;
        }

        /* NEW: Error Visualization Styles */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .ring-error {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.6) !important; /* Red glow */
            border-color: #ef4444 !important;
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @media (prefers-reduced-motion: reduce) {
            .animate-pulse-once { animation: none !important; }
            .ring-error { animation: none !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- Hidden Date Picker Helper -->
    <input type="date" id="hiddenDatePicker" class="hidden" onchange="applyDateSelection()">
    <input type="hidden" id="dateTargetId"> 

    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden relative">
        <!-- Header -->
        <div class="bg-line-green p-4 text-white flex flex-wrap justify-between items-center gap-2">
            <h1 class="text-xl font-bold"><i class="fas fa-notes-medical mr-2"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h1>
            
            <div class="flex gap-2">
                <!-- Import Button -->
                <button onclick="openImportModal()" class="bg-yellow-400 text-yellow-950 hover:bg-yellow-300 px-4 py-2.5 rounded-lg text-base font-bold shadow transition flex items-center gap-2">
                    <i class="fas fa-file-import"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å LINE
                </button>
                <!-- New Case Button (Now opens Custom Modal) -->
                <button onclick="openResetConfirmation()" class="bg-white text-green-800 hover:bg-green-50 px-4 py-2.5 rounded-lg text-base font-bold shadow transition flex items-center gap-2">
                    <i class="fas fa-user-plus"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>

        <div class="p-6 space-y-6">
            
            <!-- Section 1: Fixed Info -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
	                <div class="flex justify-between items-center mb-2 border-b border-gray-200 pb-2">
	                    <label class="block text-gray-700 font-bold text-lg"><i class="fas fa-user-injured mr-1"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</label>
	                    <div class="flex text-base space-x-3">
	                        <button onclick="switchHeaderView('form')" id="tabForm" class="tab-active pb-1">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
	                        <button onclick="switchHeaderView('text')" id="tabText" class="tab-inactive pb-1">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö</button>
	                    </div>
	                </div>

                <!-- Form View -->
                <div id="headerFormView" class="space-y-3">
                    <div class="grid grid-cols-6 gap-3">
                        <div class="col-span-4">
                            <label class="block text-sm text-gray-800 font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="pFName" class="w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base" placeholder="‡∏ô‡∏≤‡∏á‡∏™‡∏°‡∏®‡∏£‡∏µ ‡∏î‡∏µ‡πÉ‡∏à" oninput="updateHeaderFromForm()">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm text-gray-800 font-semibold">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                            <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="pAge" class="w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base" placeholder="75" oninput="updateHeaderFromForm()">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-800 font-semibold">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (Dx)</label>
                            <input type="text" id="pDx" class="w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base" placeholder="DM, HT" oninput="updateHeaderFromForm()">
                        </div>
                        <div>
                             <label class="block text-sm text-gray-800 font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö (Admit)</label>
                             <div class="flex relative">
                                <input type="text" id="pAdmitDate" class="w-full border border-gray-300 rounded-l-lg px-3 py-2 h-11 text-base" placeholder="17 ‡∏ò.‡∏Ñ. 68" oninput="updateHeaderFromForm()">
                                <!-- Date Picker Trigger -->
                                <div class="relative">
                                    <button class="bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg px-4 h-11 hover:bg-gray-200 text-gray-700">
                                        <i class="far fa-calendar-alt"></i>
                                    </button>
                                    <input type="date" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" onchange="handleDateChange(this, 'pAdmitDate')">
                                </div>
                             </div>
                        </div>
                    </div>
	                    <div>
	                        <label class="block text-sm text-red-700 font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤ (Allergy) <span class="text-red-700">*</span></label>
	                        <input type="text" id="pAllergy" class="w-full border border-red-300 bg-red-50 rounded-lg px-3 py-2 h-11 text-base text-red-900 placeholder-red-400" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏û‡πâ Penicillin (‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Import)" oninput="updateHeaderFromForm()">
	                        <p id="allergyError" class="hidden mt-2 text-sm text-red-800 font-semibold" role="alert">
	                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú-‚Äù
	                        </p>
	                    </div>
	                </div>

                <!-- Text View -->
                <div id="headerTextView" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-2 flex flex-col gap-2">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-magic text-blue-500 mt-1"></i>
                            <div>
                                <p class="text-sm text-blue-900 font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Smart Repair):</p>
                                <p class="text-sm text-blue-900">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏™‡∏ö‡∏≤‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏ß‡πâ: ‡∏ä‡∏∑‡πà‡∏≠ > ‡πÇ‡∏£‡∏Ñ > ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà > ‡∏¢‡∏≤)</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="restoreTemplate()" class="text-sm bg-white border border-blue-300 text-blue-800 px-3 py-2 rounded-lg hover:bg-blue-50 shadow-sm flex items-center">
                                <i class="fas fa-undo-alt mr-1"></i> ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á (Restore Template)
                            </button>
                        </div>
                    </div>
	                    <textarea id="headerPart" class="w-full h-64 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-base font-mono" spellcheck="false" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
	                </div>
	            </div>

            <!-- Section 2: Previous Logs -->
            <div id="historyContainer" class="bg-gray-50 p-4 rounded-lg border border-gray-200 hidden">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                        <label class="block text-gray-700 font-bold text-lg"><i class="fas fa-history mr-1"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°</label>
                        <!-- Lock Toggle Button -->
                        <button onclick="toggleHistoryLock()" id="btnHistoryLock" class="text-sm font-bold bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-full transition flex items-center gap-2 shadow-sm border border-gray-300">
                            <i class="fas fa-lock text-xs"></i> ‡∏•‡πá‡∏≠‡∏Å
                        </button>
                    </div>
                    <button onclick="toggleHistory()" class="text-sm text-blue-700 underline px-2 py-1 rounded hover:bg-blue-50">‡∏ã‡πà‡∏≠‡∏ô</button>
                </div>
                <!-- Default State: Readonly & Gray Background -->
                <textarea id="historyPart" readonly class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-base font-mono bg-gray-100 text-gray-600 cursor-not-allowed transition-colors duration-200" placeholder="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)..."></textarea>
            </div>
            
            <div id="showHistoryBtn" class="text-center hidden">
                <button onclick="toggleHistory()" class="text-base text-gray-700 hover:text-gray-900 underline border border-dashed border-gray-300 px-5 py-2 rounded-full bg-white">
                    <i class="fas fa-plus-circle mr-1"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
                </button>
            </div>

            <!-- Section 3: New Entry -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm relative">
                <div class="flex justify-between items-center mb-4">
                    <label class="block text-blue-800 font-bold text-lg"><i class="fas fa-edit mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÉ‡∏´‡∏°‡πà)</label>
                    <button onclick="openClearFormConfirmation()" class="text-sm text-blue-700 hover:text-blue-900 underline px-2 py-1 rounded hover:bg-blue-100">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-base font-semibold text-gray-800 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div class="flex relative">
                            <input type="text" id="logDate" class="block w-full border border-gray-300 rounded-l-lg shadow-sm px-3 py-2 h-11 text-base text-center font-bold text-gray-800">
                            <!-- Date Picker Trigger -->
                            <div class="relative">
                                <button class="bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg px-4 h-11 hover:bg-gray-200 text-gray-700 shadow-sm">
                                    <i class="far fa-calendar-alt"></i>
                                </button>
                                <input type="date" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" onchange="handleDateChange(this, 'logDate')">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-base font-semibold text-gray-800 mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ & ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó <span class="text-red-700 text-sm">(‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</span></label>
                        <div class="flex flex-col gap-2">
                            <!-- Shift Buttons Group (Moved Up) -->
                            <!-- Added ID: shiftButtonGroup for validation targeting -->
                            <div class="flex shadow-sm rounded-lg transition-all duration-300" role="group" id="shiftButtonGroup" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤">
                                <button type="button" onclick="setShift('‡πÄ‡∏ä‡πâ‡∏≤')" id="btnShiftMorning" aria-pressed="false" class="flex-1 px-3 py-3 text-base font-bold border border-gray-300 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-green-500 text-gray-800 shift-btn-inactive">‚òÄÔ∏è ‡πÄ‡∏ä‡πâ‡∏≤</button>
                                <button type="button" onclick="setShift('‡∏ö‡πà‡∏≤‡∏¢')" id="btnShiftAfternoon" aria-pressed="false" class="flex-1 px-3 py-3 text-base font-bold border-t border-b border-r border-gray-300 hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-green-500 text-gray-800 shift-btn-inactive">üå§Ô∏è ‡∏ö‡πà‡∏≤‡∏¢</button>
                                <button type="button" onclick="setShift('‡πÄ‡∏¢‡πá‡∏ô')" id="btnShiftEvening" aria-pressed="false" class="flex-1 px-3 py-3 text-base font-bold border border-gray-300 rounded-r-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-green-500 text-gray-800 shift-btn-inactive">üåá ‡πÄ‡∏¢‡πá‡∏ô</button>
	                            </div>
	                            <input type="hidden" id="logShift" value="">
	                            <p id="shiftError" class="hidden text-sm text-red-800 font-semibold" role="alert">
	                                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢/‡πÄ‡∏¢‡πá‡∏ô) ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î ‚Äú‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‚Äù
	                            </p>

	                            <!-- Admit Toggle Button (Moved Down) -->
	                            <button type="button" onclick="toggleAdmitMode()" id="btnToggleAdmit" class="w-full px-3 py-3 text-base font-bold border border-blue-300 text-blue-800 rounded-lg hover:bg-blue-50 transition-all flex justify-center items-center gap-2 bg-white shadow-sm">
	                                <i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö (Admit Note)
                            </button>
                            <input type="hidden" id="isAdmitMode" value="false">
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                     <!-- Admit Fields (Toggled via button) -->
                     <div id="admitFields_container" class="hidden space-y-3 bg-blue-50 p-3 rounded border border-blue-200 relative mt-2">
                        <div class="absolute -top-3 left-3 bg-blue-100 text-blue-900 text-sm font-bold px-2 py-1 rounded border border-blue-200">
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö (Admission Note)
                        </div>
                        <div class="mt-2"><label class="block text-sm font-bold text-gray-800">CC</label><input type="text" id="inputCC" class="block w-full border border-gray-300 rounded-lg px-3 py-2 h-11 text-base focus:ring-blue-200 focus:border-blue-400"></div>
                        <div><label class="block text-sm font-bold text-gray-800">HPI</label><textarea id="inputHPI" rows="2" class="block w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-blue-200 focus:border-blue-400"></textarea></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-sm font-bold text-gray-800">PH (Past Hx)</label><textarea id="inputPMH" rows="2" class="block w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-blue-200 focus:border-blue-400"></textarea></div>
                            <div><label class="block text-sm font-bold text-gray-800">FHx (Family Hx)</label><textarea id="inputFHx" rows="2" class="block w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-blue-200 focus:border-blue-400"></textarea></div>
                        </div>
                        <!-- Removed Duplicate Allergy Field -->
                        <p class="text-sm text-gray-700 text-right">*‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 (Header) ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                    </div>

                    <!-- Standard S (Always Visible) -->
                    <div id="standardS_container">
                        <label class="block text-sm font-bold text-blue-600 mb-1">S (Subjective - ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô):</label>
                        <input type="text" id="inputS" class="block w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 h-11 text-base" placeholder="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ö‡∏≠‡∏Å‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠ Notify Ward ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏î‡∏µ, ‡∏ö‡πà‡∏ô‡∏õ‡∏ß‡∏î‡πÅ‡∏ú‡∏•">
                    </div>

                    <!-- V/S Helper (Restored White Wrapper, Label Outside) -->
                    <div>
                        <label class="block text-sm font-bold text-blue-600 mb-1">O (Objective):</label>
                        
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
                                <!-- BT: Orange -->
                                <div class="relative">
                                    <label class="block text-sm text-center font-bold text-orange-700 mb-1">
                                        <i class="fas fa-thermometer-half mr-1"></i>BT<br>
                                        <span class="text-sm text-gray-700 font-normal">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</span>
                                    </label>
                                    <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" data-numeric="decimal1" id="valT" class="w-full border-2 border-orange-100 focus:border-orange-500 rounded-lg h-11 p-2 text-base text-center bg-white focus:ring-2 focus:ring-orange-200">
                                </div>
                                <!-- PR: Red -->
                                <div class="relative">
                                    <label class="block text-sm text-center font-bold text-red-700 mb-1">
                                        <i class="fas fa-heartbeat mr-1"></i>PR<br>
                                        <span class="text-sm text-gray-700 font-normal">‡∏ä‡∏µ‡∏û‡∏à‡∏£</span>
                                    </label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valP" class="w-full border-2 border-red-100 focus:border-red-500 rounded-lg h-11 p-2 text-base text-center bg-white focus:ring-2 focus:ring-red-200">
                                </div>
                                <!-- RR: Blue -->
                                <div class="relative">
                                    <label class="block text-sm text-center font-bold text-cyan-700 mb-1">
                                        <i class="fas fa-lungs mr-1"></i>RR<br>
                                        <span class="text-sm text-gray-700 font-normal">‡∏´‡∏≤‡∏¢‡πÉ‡∏à</span>
                                    </label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valR" class="w-full border-2 border-cyan-100 focus:border-cyan-500 rounded-lg h-11 p-2 text-base text-center bg-white focus:ring-2 focus:ring-cyan-200">
                                </div>
                                <!-- BP: Purple -->
                                <div class="relative">
                                    <label class="block text-sm text-center font-bold text-indigo-700 mb-1">
                                        <i class="fas fa-tachometer-alt mr-1"></i>BP<br>
                                        <span class="text-sm text-gray-700 font-normal">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</span>
                                    </label>
                                    <input type="text" id="valBP" class="w-full border-2 border-indigo-100 focus:border-indigo-500 rounded-lg h-11 p-2 text-base text-center bg-white focus:ring-2 focus:ring-indigo-200">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3 pt-2 border-t border-dashed border-gray-200">
                                 <!-- Updated DTX Section (Clean Design - No Box) -->
                                 <div class="relative">
                                    <label class="block text-sm font-bold text-blue-700 mb-1">DTX (mg%)</label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valDTX" class="w-full border-2 border-blue-100 focus:border-blue-500 rounded-lg h-11 p-2 text-base text-center mb-2 placeholder-blue-400" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤">
                                    
                                    <div class="flex gap-1 items-center">
                                        <!-- DTX Type Buttons (Replaced Dropdown) -->
                                        <div class="flex-1 flex shadow-sm rounded-md" role="group">
                                            <button type="button" onclick="setDtxType('AC')" id="btnDtxAC" class="flex-1 px-3 py-2 text-sm font-bold border border-blue-300 rounded-l hover:bg-blue-50 focus:z-10 bg-blue-600 text-white border-blue-600">‡∏Å‡πà‡∏≠‡∏ô</button>
                                            <button type="button" onclick="setDtxType('PC')" id="btnDtxPC" class="flex-1 px-3 py-2 text-sm font-bold border-t border-b border-r border-blue-300 hover:bg-blue-50 focus:z-10 bg-white text-blue-800">‡∏´‡∏•‡∏±‡∏á</button>
                                            <button type="button" onclick="setDtxType('R')" id="btnDtxR" class="flex-1 px-3 py-2 text-sm font-bold border border-blue-300 rounded-r hover:bg-blue-50 focus:z-10 bg-white text-blue-800">‡∏™‡∏∏‡πà‡∏°</button>
                                        </div>
                                        <input type="hidden" id="dtxType" value="AC">

                                        <div class="relative w-16">
                                            <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valDTX_Hr" class="w-full border border-gray-300 rounded-lg text-sm text-center bg-white focus:ring-1 focus:ring-blue-200 focus:border-blue-500 h-10 pr-6" placeholder="?">
                                            <span class="absolute right-2 top-2 text-xs text-gray-600 pointer-events-none">‡∏ä‡∏°.</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-3">
                                    <div>
                                        <label class="block text-sm text-gray-800 font-bold mb-1">SpO2</label>
                                        <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valSpO2" class="w-full border border-gray-300 rounded-lg h-11 p-2 text-base text-center bg-white" placeholder="%">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-sm text-gray-800 text-center">‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞</label>
                                            <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valUrine" class="w-full border border-gray-300 rounded-lg h-11 p-2 text-base text-center bg-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm text-gray-800 text-center">‡∏ñ‡πà‡∏≤‡∏¢</label>
                                            <input type="text" inputmode="numeric" pattern="[0-9]*" data-numeric="int" id="valStool" class="w-full border border-gray-300 rounded-lg h-11 p-2 text-base text-center bg-white">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-gray-100 pt-2 mt-2">
                                <label class="block text-sm text-gray-800 mb-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• O ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                                <textarea id="inputO_Extra" rows="2" class="w-full border border-gray-300 rounded-lg p-3 text-base bg-gray-50" placeholder="‡∏ú‡∏• Lab ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- A/P Section (Dynamic) -->
                    <div>
                        <label class="block text-sm font-bold text-blue-600 mb-1">A/P (Assessment/Plan):</label>
                        
                        <!-- Standard A/P (Shown when NOT in Admit Mode) -->
                        <div id="standardAP_container">
                            <textarea id="inputAP" rows="4" class="block w-full border border-gray-300 rounded-lg shadow-sm p-3 text-base focus:ring-blue-200 focus:border-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏â‡∏µ‡∏î‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô, ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤..."></textarea>
                        </div>

                        <!-- Admit Plan (Shown ONLY in Admit Mode) -->
                        <div id="admitPlan_container" class="hidden space-y-3 bg-green-50 p-3 rounded border border-green-200 relative mt-1">
                            <div class="absolute -top-3 right-3 bg-green-100 text-green-900 text-sm font-bold px-2 py-1 rounded border border-green-200">
                                ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö (Admission Orders)
                            </div>
                            
                            <!-- One Day -->
                            <div>
                                <label class="block text-sm font-bold text-blue-800 mb-1"><i class="fas fa-hourglass-half mr-1"></i> One Day Order</label>
                                <textarea id="inputOneDay_Admit" rows="3" class="w-full border border-blue-200 rounded-lg p-3 text-base font-mono focus:ring-blue-200 focus:border-blue-500" placeholder="NSS 1000 ml IV 80 ml/hr..."></textarea>
                            </div>

                            <!-- Continuous -->
                            <div>
                                <div class="flex justify-between items-end mb-1">
                                    <label class="block text-sm font-bold text-green-800"><i class="fas fa-sync-alt mr-1"></i> Continuous Order (Start / Continue)</label>
                                    <button onclick="copyAdmitMedsToHeader()" class="text-sm bg-green-100 text-green-900 border border-green-200 px-3 py-2 rounded-lg hover:bg-green-200 transition flex items-center gap-2">
                                        <i class="fas fa-arrow-up"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                                    </button>
                                </div>
                                <textarea id="inputCont_Admit" rows="4" class="w-full border border-green-200 rounded-lg p-3 text-base font-mono focus:ring-green-200 focus:border-green-500" placeholder="DTX premeal ‡∏ä ‡∏¢&#10;Novomix 18-0-8 sc ac ‡∏ä ‡∏¢ #1&#10;Simvastatin (20) 1x1 o hs #30"></textarea>
                                <p class="text-sm text-gray-700 mt-1">*‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏ô Header</p>
                            </div>

                            <!-- Plan Mx -->
                            <div>
                                <label class="block text-sm font-bold text-gray-800 mb-1"><i class="fas fa-user-md mr-1"></i> Plan / Management</label>
                                <textarea id="inputPlanMx_Admit" rows="3" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-gray-200 focus:border-gray-500" placeholder="- Admit ward...
- Consult..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Single Continuous Order Block (MOVED HERE) -->
            <div class="bg-white p-3 rounded border-2 border-green-100 shadow-sm transition duration-300 mt-4" id="medsContainer">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-base font-bold text-green-800"><i class="fas fa-pills mr-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Continuous Order)</label>
                    <span id="medsStatusBadge" class="text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold border border-red-200 shadow-sm">
                        <i class="fas fa-exclamation-circle"></i> ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    </span>
                </div>
                
                <p class="text-sm text-gray-700 mb-2">
                    <i class="fas fa-info-circle text-blue-400"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô Header)<br>
                </p>
                <textarea id="pMedsCont" rows="6" class="w-full border border-gray-300 rounded-lg p-3 text-base placeholder-gray-400 font-mono mb-2 focus:ring-2 focus:ring-green-200 focus:border-green-500 outline-none transition" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
‚Ä¢ DrugName A 500mg 1x3 pc
‚Ä¢ DrugName B 10mg 1x1 hs
(‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)" oninput="handleMedsInput()"></textarea>

                <!-- Verification Checkbox -->
                <div class="flex items-center bg-gray-50 p-2 rounded border border-gray-200 hover:bg-white cursor-pointer transition select-none" onclick="toggleMedsCheckFromRow()">
                    <input type="checkbox" id="medsVerified" class="w-6 h-6 text-green-600 rounded focus:ring-green-500 border-gray-300 mr-3 cursor-pointer" onchange="updateMedsStatus(event)">
                    <label for="medsVerified" class="text-base font-bold text-gray-800 cursor-pointer">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á/‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß (Verified)
                    </label>
                </div>
            </div>

            <button onclick="generateLog()" class="w-full bg-line-green hover:bg-line-dark text-white font-bold py-4 px-4 rounded-lg shadow transition duration-200 flex justify-center items-center gap-2 text-xl">
                <i class="fas fa-magic"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            </button>

            <div id="resultSection" class="hidden">
                <div class="relative bg-gray-100 p-4 rounded-lg border border-gray-300">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Preview:</label>
                    <textarea id="outputArea" class="w-full h-64 bg-white p-3 text-base font-mono border rounded-lg focus:outline-none" readonly></textarea>
                    <button onclick="copyToClipboard()" class="mt-3 w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg flex justify-center items-center gap-2 text-base"><i class="fas fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å (Copy)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2"><i class="fas fa-file-import text-yellow-500 mr-2"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LINE</h2>
            <p class="text-sm text-gray-600 mb-3">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Copy ‡∏°‡∏≤‡∏à‡∏≤‡∏Å LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
            <textarea id="importText" rows="10" class="w-full border-2 border-gray-200 rounded-lg p-3 text-base font-mono focus:border-yellow-500 focus:ring-0" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeImportModal()" class="px-5 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="processImport()" class="px-5 py-3 bg-yellow-400 text-yellow-950 font-bold rounded-lg hover:bg-yellow-300">‡∏ï‡∏Å‡∏•‡∏á ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <!-- NEW CASE CONFIRM MODAL (Fixes the issue with blocked confirm()) -->
    <div id="newCaseModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-user-plus text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà?</h3>
                <div class="mt-2">
                    <p class="text-base text-gray-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</p>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 grid grid-cols-2 gap-3">
                <button type="button" onclick="closeConfirmation()" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-5 py-3 bg-white text-base font-bold text-gray-800 hover:bg-gray-50 focus:outline-none">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="button" onclick="executeNewCase()" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-5 py-3 bg-green-600 text-base font-bold text-white hover:bg-green-700 focus:outline-none">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                </button>
            </div>
        </div>
    </div>

    <!-- CLEAR FORM CONFIRM MODAL -->
    <div id="clearFormModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-bold text-gray-900 mb-2">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?</h3>
            <p class="text-base text-gray-700 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (Header ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeConfirmation()" class="w-full rounded-lg border border-gray-300 px-5 py-3 bg-white text-gray-800 hover:bg-gray-50 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="executeClearForm()" class="w-full rounded-lg border border-transparent px-5 py-3 bg-red-600 text-white hover:bg-red-700 font-bold">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <!-- GENERATE CONFIRM MODAL (Safety Check) -->
    <div id="safetyCheckModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 border-l-4 border-red-500">
            <h3 class="text-lg font-bold text-red-600 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h3>
            <p class="text-base text-gray-800 mb-4">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏¥‡πä‡∏Å '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ Continuous Order</p>
            <div class="flex flex-col gap-2">
                <button onclick="confirmSafetyCheck()" class="w-full rounded-lg bg-green-600 text-white px-5 py-3 hover:bg-green-700 font-bold text-base">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏¢‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠)</button>
                <button onclick="cancelSafetyCheck()" class="w-full rounded-lg bg-gray-200 text-gray-800 px-5 py-3 hover:bg-gray-300 font-bold text-base">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
            </div>
        </div>
    </div>

	    <div id="toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-4 rounded-xl shadow-lg transform transition-all duration-300 z-50 text-base max-w-[90vw]" role="status" aria-live="polite">
	        <i id="toastIcon" class="fas fa-check-circle mr-2" style="color:#86efac"></i> <span id="toastMsg">Success!</span>
	    </div>

    <script>
	        const defaultHeader = `‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ... (‡∏≠‡∏≤‡∏¢‡∏∏ ... ‡∏õ‡∏µ)\nDx: ...\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: ...\nüíä ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤)\n‚Ä¢ ...`;
	        const blankTemplate = `‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ... (‡∏≠‡∏≤‡∏¢‡∏∏ ... ‡∏õ‡∏µ)\nDx: ...\n‡πÅ‡∏û‡πâ‡∏¢‡∏≤: ...\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: ...\nüíä ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô\n‚Ä¢ ...`;
	        const defaultHistory = ``; 
	
	        function sanitizeNumericInput(input) {
	            const mode = input?.dataset?.numeric;
	            if (!mode) return;
	
	            const before = input.value;
	            let after = before;
	
	            if (mode === 'int') {
	                after = before.replace(/\D+/g, '');
	            } else if (mode === 'decimal1') {
	                after = before.replace(/,/g, '.').replace(/[^0-9.]/g, '');
	                if (after.startsWith('.')) after = '0' + after;
	                const dotIndex = after.indexOf('.');
	                if (dotIndex !== -1) {
	                    const intPart = after.slice(0, dotIndex);
	                    const fracPart = after.slice(dotIndex + 1).replace(/\./g, '');
	                    after = intPart + '.' + fracPart.slice(0, 1);
	                }
	            }
	
	            if (after !== before) input.value = after;
	        }
	
	        function initNumericInputs() {
	            document.querySelectorAll('input[data-numeric]').forEach((input) => {
	                input.addEventListener('input', () => sanitizeNumericInput(input));
	                sanitizeNumericInput(input);
	            });
	        }

        function handleMedsInput() {
            document.getElementById('medsVerified').checked = false;
            updateMedsStatus();
            updateHeaderFromForm();
        }

        function toggleMedsCheckFromRow() {
            const checkbox = document.getElementById('medsVerified');
            checkbox.checked = !checkbox.checked;
            updateMedsStatus();
        }

        function updateMedsStatus(e) {
            if(e) e.stopPropagation();
            const isChecked = document.getElementById('medsVerified').checked;
            const container = document.getElementById('medsContainer');
            const badge = document.getElementById('medsStatusBadge');

            if (isChecked) {
                container.classList.remove('border-red-300', 'bg-red-50');
                container.classList.add('border-green-400', 'bg-green-50');
                badge.className = "text-sm px-3 py-1 rounded-full bg-green-100 text-green-800 font-bold border border-green-200 shadow-sm";
                badge.innerHTML = '<i class="fas fa-check-circle"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
            } else {
                container.classList.remove('border-green-400', 'bg-green-50');
                container.classList.add('border-red-300', 'bg-red-50');
                badge.className = "text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold border border-red-200 shadow-sm";
                badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            }
        }

        function openImportModal() { document.getElementById('importModal').classList.remove('hidden'); document.getElementById('importText').value = ''; }
        function closeImportModal() { document.getElementById('importModal').classList.add('hidden'); }
        
	        function processImport() {
	            const text = document.getElementById('importText').value;
	            if(!text.trim()) return;
	            handleFullTextImport(text);
	            closeImportModal();
	            document.getElementById('medsVerified').checked = false;
	            updateMedsStatus();
	            showToast("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "warning");
	        }

        function handleFullTextImport(text) {
            const parts = text.split(/^={10,}$/m);
            let newHeader = "", newHistory = "";
            if (parts.length >= 2) {
                newHeader = parts[0].trim();
                let rawHistory = parts.slice(1).join('\n==============\n').trim();
                const titleLine = "(‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)";
                if(rawHistory.includes(titleLine)) rawHistory = rawHistory.replace(titleLine, '').trim();
                newHistory = rawHistory;
            } else {
                newHeader = text.trim(); 
            }
            
            // AUTOMATIC ALLERGY DETECTION
            // Look for "Allergy" or "‡πÅ‡∏û‡πâ‡∏¢‡∏≤" patterns in the FULL text, not just header
            const allergyMatch = text.match(/(?:‡πÅ‡∏û‡πâ‡∏¢‡∏≤|Allergy)[\s:]*([^\n]+)/i);
            if (allergyMatch && allergyMatch[1]) {
                const detectedAllergy = allergyMatch[1].trim();
                // Update form field directly to ensure it sticks
                const allergyInput = document.getElementById('pAllergy');
                // Only update if current field is empty or contains "..." (placeholder)
                if(!allergyInput.value || allergyInput.value.includes("...")) {
                    allergyInput.value = detectedAllergy;
                }
            }

            document.getElementById('headerPart').value = newHeader;
            if(newHistory) document.getElementById('historyPart').value = newHistory;
            saveData();
            switchHeaderView('text'); 
            checkHistoryVisibility();
        }

        document.getElementById('hiddenDatePicker').style.display = 'block';
        document.getElementById('hiddenDatePicker').style.position = 'absolute';
        document.getElementById('hiddenDatePicker').style.opacity = '0';
        document.getElementById('hiddenDatePicker').style.height = '0';
        document.getElementById('hiddenDatePicker').style.width = '0';
        document.getElementById('hiddenDatePicker').style.bottom = '0';
        document.getElementById('hiddenDatePicker').style.left = '0';

        function handleDateChange(input, targetId) {
             document.getElementById('dateTargetId').value = targetId;
             document.getElementById('hiddenDatePicker').value = input.value; 
             applyDateSelection();
        }

        function applyDateSelection() {
            const dateVal = document.getElementById('hiddenDatePicker').value; 
            if(!dateVal) return;
            const targetId = document.getElementById('dateTargetId').value;
            const targetInput = document.getElementById(targetId);
            const parts = dateVal.split('-');
            const yearAD = parseInt(parts[0]);
            const month = parts[1];
            const day = parts[2];
            const yearBE = (yearAD + 543).toString().slice(-2);

            const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            const mIndex = parseInt(month) - 1;
            targetInput.value = `${parseInt(day)} ${months[mIndex]} ${yearBE}`;

            if(targetId === 'pAdmitDate') updateHeaderFromForm();
        }

	        function setShift(shift) {
	            document.getElementById('logShift').value = shift;
	            updateShiftButtons(shift);
	            const shiftError = document.getElementById('shiftError');
	            if (shiftError) shiftError.classList.add('hidden');
	            const shiftGroup = document.getElementById('shiftButtonGroup');
	            if (shiftGroup) shiftGroup.classList.remove('ring-error');
	        }

        function updateShiftButtons(activeShift) {
            const shifts = ['‡πÄ‡∏ä‡πâ‡∏≤', '‡∏ö‡πà‡∏≤‡∏¢', '‡πÄ‡∏¢‡πá‡∏ô'];
            const btnIds = {'‡πÄ‡∏ä‡πâ‡∏≤': 'btnShiftMorning', '‡∏ö‡πà‡∏≤‡∏¢': 'btnShiftAfternoon', '‡πÄ‡∏¢‡πá‡∏ô': 'btnShiftEvening'};
            
            // If no shift selected (activeShift is empty), reset all
            if (!activeShift) {
                Object.values(btnIds).forEach(id => {
                    const btn = document.getElementById(id);
                    btn.className = "flex-1 px-3 py-3 text-base font-bold border border-gray-300 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-green-500 text-gray-800 shift-btn-inactive";
                    btn.setAttribute('aria-pressed', 'false');
                    // Fix border radiuses based on position manually if needed, or rely on simple classes
                    if(id === 'btnShiftMorning') btn.classList.add('rounded-l-lg', 'border-r-0');
                    if(id === 'btnShiftAfternoon') btn.classList.remove('rounded-l-lg', 'rounded-r-lg');
                    if(id === 'btnShiftEvening') btn.classList.add('rounded-r-lg', 'border-l-0');
                });
                return;
            }

            // Otherwise, highlight active one
            shifts.forEach(s => {
                const btn = document.getElementById(btnIds[s]);
                // Reset basic shape classes
                let baseClasses = "flex-1 px-3 py-3 text-base font-bold border focus:z-10 focus:ring-2 focus:ring-green-500 ";
                
                if (s === '‡πÄ‡∏ä‡πâ‡∏≤') baseClasses += "rounded-l-lg border-r-0 ";
                else if (s === '‡πÄ‡∏¢‡πá‡∏ô') baseClasses += "rounded-r-lg border-l-0 ";
                
                if (s === activeShift) {
                    btn.className = baseClasses + "shift-btn-active";
                    btn.setAttribute('aria-pressed', 'true');
                } else {
                    btn.className = baseClasses + "shift-btn-inactive border-gray-300 hover:bg-gray-100";
                    btn.setAttribute('aria-pressed', 'false');
                }
            });
        }

        // NEW: Function to handle DTX Type Buttons
        function setDtxType(type) {
            document.getElementById('dtxType').value = type;
            const types = ['AC', 'PC', 'R'];
            const btnIds = {'AC': 'btnDtxAC', 'PC': 'btnDtxPC', 'R': 'btnDtxR'};

            types.forEach(t => {
                const btn = document.getElementById(btnIds[t]);
                // Active Style (Blue)
                if (t === type) {
                    btn.classList.remove('bg-white', 'text-blue-700', 'border-blue-300');
                    btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                } else {
                    // Inactive Style (White)
                    btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                    btn.classList.add('bg-white', 'text-blue-700', 'border-blue-300');
                }
            });
        }
        
        function toggleAdmitMode(forceState = null) {
            const isAdmitInput = document.getElementById('isAdmitMode');
            const currentVal = isAdmitInput.value === 'true';
            const newState = (forceState !== null) ? forceState : !currentVal;
            
            isAdmitInput.value = newState ? 'true' : 'false';
            
            const btn = document.getElementById('btnToggleAdmit');
            const admitFields = document.getElementById('admitFields_container');
            const standardAP = document.getElementById('standardAP_container');
            const admitPlan = document.getElementById('admitPlan_container');

            if(newState) {
                btn.classList.remove('bg-white', 'text-blue-600', 'border-blue-300');
                btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
                btn.innerHTML = '<i class="fas fa-check-circle"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö (‡πÄ‡∏õ‡∏¥‡∏î)';
                admitFields.classList.remove('hidden');
                admitFields.classList.add('animate-pulse-once');
                standardAP.classList.add('hidden');
                admitPlan.classList.remove('hidden');
                setTimeout(() => admitFields.classList.remove('animate-pulse-once'), 500);
            } else {
                btn.classList.add('bg-white', 'text-blue-600', 'border-blue-300');
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
                btn.innerHTML = '<i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö (Admit Note)';
                admitFields.classList.add('hidden');
                standardAP.classList.remove('hidden');
                admitPlan.classList.add('hidden');
            }
        }

        function initDate() {
            const today = new Date();
            const day = today.getDate();
            const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            const monthShort = months[today.getMonth()];
            const year = (today.getFullYear() + 543).toString().slice(-2);
            document.getElementById('logDate').value = `${day} ${monthShort} ${year}`;
            
            // NO DEFAULT SHIFT (Must select manually)
            setShift(''); 
            
            toggleAdmitMode(false);
        }

        function loadData() {
            const savedHeader = localStorage.getItem('patientLog_header') || defaultHeader;
            const savedHistory = localStorage.getItem('patientLog_history') || defaultHistory;
            document.getElementById('headerPart').value = savedHeader;
            document.getElementById('historyPart').value = savedHistory;
            checkHistoryVisibility();
        }

        function saveData() {
            localStorage.setItem('patientLog_header', document.getElementById('headerPart').value);
            localStorage.setItem('patientLog_history', document.getElementById('historyPart').value);
        }

        function restoreTemplate() {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                document.getElementById('headerPart').value = blankTemplate;
            }
        }

        function parseHeaderToForm() {
            const raw = document.getElementById('headerPart').value.trim();
            if (!raw) return;
            if (raw.match(/^={10,}$/m)) { handleFullTextImport(raw); return; }
            const lines = raw.split('\n').map(l => l.trim()).filter(l => l);
            let nameVal = "", ageVal = "", dxVal = "", allergyVal = "", admitVal = "", medsText = "";

            const nameMatch = raw.match(/‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:\s*(.*?)(?:\s*\((\d+)\s*‡∏õ‡∏µ\))?$/m);
            if (nameMatch) { nameVal = nameMatch[1]; ageVal = nameMatch[2] || ""; } 
            else if (lines.length > 0) {
                let line0 = lines[0].replace("‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:", "").trim();
                const ageMatch = line0.match(/(.*?)(?:\s*\((\d+)\s*‡∏õ‡∏µ\))?$/);
                if(ageMatch) { nameVal = ageMatch[1]; ageVal = ageMatch[2] || ""; } else { nameVal = line0; }
            }

            const dxMatch = raw.match(/Dx:\s*(.*?)(?:\n|$)/);
            if (dxMatch) {
                let dxText = dxMatch[1].trim();
                if(dxText.includes("‡πÅ‡∏û‡πâ‡∏¢‡∏≤:")) { const parts = dxText.split("‡πÅ‡∏û‡πâ‡∏¢‡∏≤:"); dxText = parts[0].trim(); allergyVal = parts[1].trim(); }
                dxVal = dxText;
            } else if (lines.length > 1) {
                let potentialDx = lines[1];
                if (!potentialDx.includes("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö") && !potentialDx.includes("‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ")) dxVal = potentialDx.replace("Dx:", "").replace("‡πÅ‡∏û‡πâ‡∏¢‡∏≤:", "").trim();
            }

            const allergyMatch = raw.match(/‡πÅ‡∏û‡πâ‡∏¢‡∏≤:\s*(.*?)(?:\n|$)/);
            if(allergyMatch) allergyVal = allergyMatch[1].trim();

            const admitMatch = raw.match(/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö:\s*(.*?)(?:\n|$)/);
            if (admitMatch) admitVal = admitMatch[1].trim();
            else { for(const line of lines) { if (line.match(/(\d{1,2}[\/\s][^\s]+[\/\s]\d{2,4})/) && !line.includes("‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ")) { admitVal = line.replace("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö:", "").trim(); break; } } }

            const medsHeaderRegex = /(?:üíä|üíâ)?\s*‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/;
            const medsStartMatch = raw.match(medsHeaderRegex);
            if (medsStartMatch) {
                medsText = raw.substring(medsStartMatch.index + medsStartMatch[0].length).trim();
            } else {
                let startMedsIndex = -1;
                for(let i=3; i<lines.length; i++) { if(lines[i].startsWith('‚Ä¢') || lines[i].startsWith('-')) { startMedsIndex = i; break; } }
                if (startMedsIndex !== -1) medsText = lines.slice(startMedsIndex).join('\n');
            }
            if(medsText) {
                medsText = medsText.split('\n').map(l => l.trim()).filter(l => l && !l.includes('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï') && !l.includes('Update') && l !== '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤)').map(l => l.replace(/^[‚Ä¢-]\s*/, '')).join('\n');
            }

            document.getElementById('pFName').value = nameVal === "..." ? "" : nameVal;
            document.getElementById('pAge').value = ageVal;
            document.getElementById('pDx').value = dxVal === "..." ? "" : dxVal;
            document.getElementById('pAllergy').value = allergyVal;
            document.getElementById('pAdmitDate').value = admitVal === "..." ? "" : admitVal;
            document.getElementById('pMedsCont').value = medsText === "..." ? "" : medsText;
        }

	        function switchHeaderView(view) {
	            if (view === 'form') {
	                parseHeaderToForm();
	                document.getElementById('headerFormView').classList.remove('hidden');
	                document.getElementById('headerTextView').classList.add('hidden');
	                document.getElementById('medsContainer').classList.remove('hidden');
	                document.getElementById('tabForm').className = "tab-active pb-1";
	                document.getElementById('tabText').className = "tab-inactive pb-1";
	                const allergyError = document.getElementById('allergyError');
	                if (allergyError) allergyError.classList.add('hidden');
	                document.getElementById('pAllergy').classList.remove('ring-error');
	                updateHeaderFromForm();
	            } else {
	                document.getElementById('headerFormView').classList.add('hidden');
	                document.getElementById('headerTextView').classList.remove('hidden');
	                document.getElementById('medsContainer').classList.add('hidden');
	                document.getElementById('tabForm').className = "tab-inactive pb-1";
	                document.getElementById('tabText').className = "tab-active pb-1";
	            }
	        }

	        function updateHeaderFromForm() {
	            const name = document.getElementById('pFName').value.trim() || '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•';
	            const age = document.getElementById('pAge').value.trim();
	            const dx = document.getElementById('pDx').value.trim() || '...';
	            const admitDate = document.getElementById('pAdmitDate').value.trim() || '...';
	            const allergy = document.getElementById('pAllergy').value.trim();
	            const medsCont = document.getElementById('pMedsCont').value.trim();
	
	            const allergyError = document.getElementById('allergyError');
	            if (allergyError && allergy) allergyError.classList.add('hidden');
	            if (allergy) document.getElementById('pAllergy').classList.remove('ring-error');
	            const ageStr = age ? ` (${age} ‡∏õ‡∏µ)` : '';
	            const allergyStr = allergy ? `\n‡πÅ‡∏û‡πâ‡∏¢‡∏≤: ${allergy}` : '';
	            const today = new Date();
	            const dateStr = `${today.getDate()}/${today.getMonth()+1}/${(today.getFullYear()+543).toString().slice(-2)}`;
            let medsBlock = `üíä ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${dateStr})`;
            if (medsCont) {
                const lines = medsCont.split('\n');
                lines.forEach(line => { const cleanLine = line.trim(); if(cleanLine) medsBlock += `\n${cleanLine.startsWith('‚Ä¢') ? cleanLine : '‚Ä¢ ' + cleanLine}`; });
            } else { medsBlock += `\n‚Ä¢ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤)`; }
            document.getElementById('headerPart').value = `‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${name}${ageStr}\nDx: ${dx}${allergyStr}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: ${admitDate}\n${medsBlock}`;
            saveData();
        }

        function checkHistoryVisibility() {
            const history = document.getElementById('historyPart').value.trim();
            const container = document.getElementById('historyContainer');
            const showBtn = document.getElementById('showHistoryBtn');
            if (history === "") { container.classList.add('hidden'); showBtn.classList.remove('hidden'); } 
            else { container.classList.add('hidden'); showBtn.classList.remove('hidden'); }
        }

        function toggleHistory() {
            const container = document.getElementById('historyContainer');
            if (container.classList.contains('hidden')) { container.classList.remove('hidden'); document.getElementById('showHistoryBtn').classList.add('hidden'); } 
            else { container.classList.add('hidden'); document.getElementById('showHistoryBtn').classList.remove('hidden'); }
        }

        function toggleHistoryLock() {
            const textarea = document.getElementById('historyPart');
            const btn = document.getElementById('btnHistoryLock');
            const isLocked = textarea.hasAttribute('readonly');
            if (isLocked) {
                textarea.removeAttribute('readonly');
                textarea.classList.remove('bg-gray-100', 'text-gray-600', 'cursor-not-allowed');
                textarea.classList.add('bg-white', 'text-gray-900');
                btn.innerHTML = '<i class="fas fa-lock-open text-green-600"></i> ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
                btn.classList.remove('bg-gray-200', 'text-gray-700', 'border-gray-300');
                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
                textarea.focus();
            } else {
                textarea.setAttribute('readonly', 'true');
                textarea.classList.remove('bg-white', 'text-gray-900');
                textarea.classList.add('bg-gray-100', 'text-gray-600', 'cursor-not-allowed');
                btn.innerHTML = '<i class="fas fa-lock text-xs"></i> ‡∏•‡πá‡∏≠‡∏Å';
                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-200');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'border-gray-300');
            }
        }

        // --- HELPER: Copy Admit Meds to Header ---
	        function copyAdmitMedsToHeader() {
	            const admitMeds = document.getElementById('inputCont_Admit').value.trim();
	            if (!admitMeds) {
	                showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Continuous Order ‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å", "warning");
	                return;
	            }
            
            const headerMedsInput = document.getElementById('pMedsCont');
            
            // Clear old text and set new text immediately (No confirmation)
            headerMedsInput.value = admitMeds;
            
            // Trigger update to render text view
            updateHeaderFromForm();
            
            // Reset verification status since meds changed
            document.getElementById('medsVerified').checked = false;
            updateMedsStatus();
            
            showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        }

        // --- NEW CONFIRMATION SYSTEM (Replaces blocked window.confirm) ---
        function openResetConfirmation() {
            document.getElementById('newCaseModal').classList.remove('hidden');
        }
        
        function openClearFormConfirmation() {
            document.getElementById('clearFormModal').classList.remove('hidden');
        }

        function closeConfirmation() {
            document.getElementById('newCaseModal').classList.add('hidden');
            document.getElementById('clearFormModal').classList.add('hidden');
            document.getElementById('safetyCheckModal').classList.add('hidden');
        }

        function executeClearForm() {
            resetFormFields();
            initDate();
            closeConfirmation();
        }

        function resetFormFields() {
            // Removed 'inputAllergy_Admit' from the list
            const ids = ['inputS', 'inputCC', 'inputHPI', 'inputPMH', 'inputFHx', 'valBP', 'valT', 'valP', 'valR', 'valDTX', 'valDTX_Hr', 'valSpO2', 'valUrine', 'valStool', 'inputO_Extra', 'inputAP', 'inputOneDay_Admit', 'inputCont_Admit', 'inputPlanMx_Admit'];
            ids.forEach(id => { 
                const el = document.getElementById(id); 
                if(el) el.value = ''; 
            });
            // Reset DTX Buttons to default (AC)
            setDtxType('AC');
        }

        // --- CORE NEW CASE LOGIC (No Alert/Confirm - Uses Modal) ---
		        function executeNewCase() {
	            closeConfirmation();
	            
	            try {
	                console.log('Execute New Case Triggered');

                // 1. Reset Storage
                document.getElementById('headerPart').value = ""; 
                document.getElementById('historyPart').value = "";
                checkHistoryVisibility();
                
                // 2. Clear Header Inputs Manually
                document.getElementById('pFName').value = "";
                document.getElementById('pAge').value = "";
	                document.getElementById('pDx').value = "";
	                document.getElementById('pAllergy').value = "";
	                const allergyError = document.getElementById('allergyError');
	                if (allergyError) allergyError.classList.add('hidden');
	                document.getElementById('pAllergy').classList.remove('ring-error');
	                document.getElementById('pMedsCont').value = "";
	                
	                // 3. Set Dates (Manual Logic - Independent of initDate)
	                const today = new Date();
                const day = today.getDate();
                const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
                const monthShort = months[today.getMonth()];
                const year = (today.getFullYear() + 543).toString().slice(-2);
                
                document.getElementById('pAdmitDate').value = `${day} ${monthShort} ${year}`;
                document.getElementById('logDate').value = `${day} ${monthShort} ${year}`;

                // Set Shift Manually (Set to blank as per request)
                setShift('');

                // 4. Clear Body Inputs
                resetFormFields();
                document.getElementById('outputArea').value = "";
                document.getElementById('resultSection').classList.add('hidden');

                // 5. Force View & Meds Status
                document.getElementById('headerFormView').classList.remove('hidden');
                document.getElementById('headerTextView').classList.add('hidden');
                document.getElementById('medsContainer').classList.remove('hidden');
                document.getElementById('tabForm').className = "tab-active pb-1";
                document.getElementById('tabText').className = "tab-inactive pb-1";
                document.getElementById('medsVerified').checked = false;
                updateMedsStatus();

                // 6. Force Update Header
                updateHeaderFromForm();

                // 7. FORCE ADMIT MODE ON (Direct DOM Manipulation)
                const isAdmitInput = document.getElementById('isAdmitMode');
                isAdmitInput.value = 'true';
                
                const btnAdmit = document.getElementById('btnToggleAdmit');
                btnAdmit.classList.remove('bg-white', 'text-blue-600', 'border-blue-300');
                btnAdmit.classList.add('bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
                btnAdmit.innerHTML = '<i class="fas fa-check-circle"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö (‡πÄ‡∏õ‡∏¥‡∏î)';
                
                document.getElementById('admitFields_container').classList.remove('hidden');
                document.getElementById('standardAP_container').classList.add('hidden');
                document.getElementById('admitPlan_container').classList.remove('hidden');

                // 8. Focus Logic
                window.scrollTo(0, 0); 
                setTimeout(() => {
                    const nameInput = document.getElementById('pFName');
                    if(nameInput) {
                        nameInput.focus();
                        nameInput.click();
                    }
                }, 150);
                
	                showToast("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
	            } catch (err) {
	                console.error("Error in executeNewCase: ", err);
	                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà", "error");
	            }
	        }

        // --- NEW START BUTTON HANDLER ---
        function startNewCase() {
            // No native confirm() here. Open modal instead.
            openResetConfirmation();
        }
        
        function triggerClearToday() {
            openClearFormConfirmation();
        }

	        function generateLog() {
	            // VALIDATION: Shift must be selected
	            const shift = document.getElementById('logShift').value;
	            if(!shift) {
	                // VISUAL FEEDBACK FOR SHIFT
	                const shiftGroup = document.getElementById('shiftButtonGroup');
	                shiftGroup.classList.add('ring-error');
	                const shiftError = document.getElementById('shiftError');
	                if (shiftError) shiftError.classList.remove('hidden');
	                
	                // Remove class after animation ends to allow re-triggering
	                setTimeout(() => shiftGroup.classList.remove('ring-error'), 1000);

	                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢/‡πÄ‡∏¢‡πá‡∏ô) ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°", "error");
	                // Scroll to shift selector
	                shiftGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
	                return;
	            }

            // VALIDATION: Allergy must be filled
	            const allergy = document.getElementById('pAllergy').value.trim();
	            if (!allergy) {
	                // Switch to form view ensuring input is visible
	                switchHeaderView('form');
	                const allergyInput = document.getElementById('pAllergy');
	                const allergyError = document.getElementById('allergyError');
	                if (allergyError) allergyError.classList.remove('hidden');
	                
	                // VISUAL FEEDBACK FOR ALLERGY
	                setTimeout(() => {
	                    allergyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
	                    allergyInput.classList.add('ring-error');
	                    allergyInput.focus();
	                    setTimeout(() => allergyInput.classList.remove('ring-error'), 1000);
	                }, 100); // Small delay to allow view switch

	                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤ (‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú-‚Äù)", "error");
	                return;
	            }

            if (!document.getElementById('medsVerified').checked) {
                // Open Safety Modal instead of native confirm
                document.getElementById('safetyCheckModal').classList.remove('hidden');
                // Scroll to meds to visually indicate
                switchHeaderView('form');
                document.getElementById('medsContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
                const container = document.getElementById('medsContainer');
                container.classList.add('ring-4', 'ring-red-400');
                setTimeout(() => container.classList.remove('ring-4', 'ring-red-400'), 1000);
                return;
            }
            executeGenerateLog();
        }

        function confirmSafetyCheck() {
            document.getElementById('medsVerified').checked = true;
            updateMedsStatus();
            document.getElementById('safetyCheckModal').classList.add('hidden');
            executeGenerateLog();
        }

        function cancelSafetyCheck() {
            document.getElementById('safetyCheckModal').classList.add('hidden');
        }

        function executeGenerateLog() {
            saveData();
            const header = document.getElementById('headerPart').value.trim();
            const history = document.getElementById('historyPart').value.trim();
            const date = document.getElementById('logDate').value;
            const shift = document.getElementById('logShift').value;
            const isAdmit = document.getElementById('isAdmitMode').value === 'true';
            
            // Define Indentation (4 spaces as requested)
            const INDENT = "    ";

            // Helper to indent text lines
            const indentText = (text) => {
                if (!text) return "";
                return text.split('\n').map(line => INDENT + line).join('\n');
            };

            // Helper to add ‚Ä¢ bullets (normalize "-" to "‚Ä¢")
            const addBullets = (text) => {
                if (!text) return "";
                return text
                    .split('\n')
                    .map(line => line.trim())
                    .filter(Boolean)
                    .map(line => {
                        if (line.startsWith('‚Ä¢')) return line;
                        if (line.startsWith('-')) return '‚Ä¢ ' + line.replace(/^-+\s*/, '');
                        return '‚Ä¢ ' + line;
                    })
                    .join('\n');
            };

            let apFinal = "";
            if (isAdmit) {
                const oneDay = document.getElementById('inputOneDay_Admit').value.trim();
                const cont = document.getElementById('inputCont_Admit').value.trim();
                const planMx = document.getElementById('inputPlanMx_Admit').value.trim();

                const orderBlocks = [];
                if (oneDay) orderBlocks.push(`One Day Order:\n${indentText(addBullets(oneDay))}`);
                if (cont) orderBlocks.push(`Continuous Order:\n${indentText(addBullets(cont))}`);

                const sections = [];
                if (orderBlocks.length) sections.push(orderBlocks.join('\n'));
                if (planMx) sections.push(`Plan / Mx:\n${indentText(addBullets(planMx))}`);

                apFinal = sections.join('\n\n');
            } else {
                const rawAP = document.getElementById('inputAP').value.trim();
                if (rawAP) apFinal = indentText(addBullets(rawAP));
            }

            let sBlock = "";
            if (isAdmit) {
                const cc = document.getElementById('inputCC').value.trim();
                const hpi = document.getElementById('inputHPI').value.trim();
                const pmh = document.getElementById('inputPMH').value.trim();
                const fhx = document.getElementById('inputFHx').value.trim();
                
                // Pull Allergy from Header (Section 1) instead of local input
                const allergy = document.getElementById('pAllergy').value.trim();
                
                if (cc) sBlock += `CC: ${cc}\n`;
                if (hpi) sBlock += `HPI: ${hpi}\n`;
                if (pmh) sBlock += `PH: ${pmh}\n`;
                if (fhx) sBlock += `FHx: ${fhx}\n`;
                // Add allergy to the note if present in header
                if (allergy && allergy !== "..." && allergy !== "") sBlock += `Allergy: ${allergy}\n`;
            } 
            const s = document.getElementById('inputS').value.trim();
            if(s) sBlock += `S: ${s}\n`;

            const bp = document.getElementById('valBP').value.trim();
            const t = document.getElementById('valT').value.trim();
            const p = document.getElementById('valP').value.trim();
            const r = document.getElementById('valR').value.trim();
            
            // Updated DTX Generation Logic (Simplified format)
            const dtxVal = document.getElementById('valDTX').value.trim();
            let dtxStr = "";
            if(dtxVal) {
                const type = document.getElementById('dtxType').value;
                const hrs = document.getElementById('valDTX_Hr').value.trim();
                
                let contextStr = "";
                if (type === 'AC') {
                    // Result: (‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 3 ‡∏ä‡∏°.) or (‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£)
                    contextStr = hrs ? `‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ${hrs} ‡∏ä‡∏°.` : `‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£`;
                } else if (type === 'PC') {
                    // Result: (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 3 ‡∏ä‡∏°.) or (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£)
                    contextStr = hrs ? `‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ${hrs} ‡∏ä‡∏°.` : `‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£`;
                } else if (type === 'R') {
                    contextStr = `Random`;
                }
                
                dtxStr = `${dtxVal} mg% (${contextStr})`;
            }

            const spo2 = document.getElementById('valSpO2').value.trim();
            const urine = document.getElementById('valUrine').value.trim();
            const stool = document.getElementById('valStool').value.trim();
            const oExtra = document.getElementById('inputO_Extra').value.trim();

            let oLines = [];
            let vsParts = [];
            if(t) vsParts.push(`T=${t}`);
            if(p) vsParts.push(`P=${p}`);
            if(r) vsParts.push(`R=${r}`);
            if(bp) vsParts.push(`BP=${bp}`);
            const vsInline = vsParts.length ? `V/S: ${vsParts.join(', ')}` : "";
            if(dtxStr) oLines.push(`‚Ä¢ DTX: ${dtxStr}`);
            if(spo2) oLines.push(`‚Ä¢ SpO2: ${spo2}%`);
            
            // Updated Excretion Logic: Combined line + Added '‡∏Ñ‡∏£‡∏±‡πâ‡∏á' + Renamed label
            let excParts = [];
            if(urine) excParts.push(`‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ ${urine} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
            if(stool) excParts.push(`‡∏ñ‡πà‡∏≤‡∏¢ ${stool} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
            
            if(excParts.length > 0) {
                oLines.push(`‚Ä¢ Excretion: ${excParts.join(', ')}`);
            }

            if(oExtra) oLines.push(oExtra);

            // Apply Indent to all O lines (except V/S which is shown inline with O:)
            const oFinal = oLines.map(line => INDENT + line).join('\n');
            
            let logHeaderLine = `üîª ${date} ${shift}`;
            if(isAdmit) logHeaderLine += " (‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö)"; 

            let newEntry = `${logHeaderLine}\n${sBlock}`;
            if (vsInline || oFinal) {
                newEntry += vsInline ? `O: ${vsInline}\n` : `O:\n`;
                if (oFinal) newEntry += `${oFinal}\n`;
            }
            if(apFinal) newEntry += `A/P:\n${apFinal}`;

            const separator = "==============\n(‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)";
            
            // Updated Logic: 
            // 1. Shortened the separator line.
            // 2. Smart Check: Add separator if it's the FIRST entry of that DATE (regardless of shift).
            // 3. Same day entries get standard double-spacing (\n\n) for readability.
            let spacer = "\n\n"; // Default spacing (1 blank line)
            
            // Check if current date string is already in history
            const isFirstEntryOfDay = !history.includes(date);

            if (history !== "" && isFirstEntryOfDay) {
                spacer = "\n\n-----------------\n";
            }

            let fullLog = history === "" ? `${header}\n${separator}\n${newEntry}` : `${header}\n${separator}\n${history}${spacer}${newEntry}`;

            document.getElementById('outputArea').value = fullLog;
            document.getElementById('resultSection').classList.remove('hidden');
            setTimeout(() => document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
        }

        function copyToClipboard() {
            const copyText = document.getElementById("outputArea");
            copyText.select();
            try { document.execCommand('copy'); showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); }
            catch (err) { navigator.clipboard.writeText(copyText.value).then(()=>showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")); }
        }

	        function showToast(message, type = "success") {
	            const toast = document.getElementById('toast');
	            const icon = document.getElementById('toastIcon');
	            document.getElementById('toastMsg').innerText = message;

	            if (icon) {
	                let iconName = "check-circle";
	                let color = "#86efac"; // green-300
	                if (type === "error") {
	                    iconName = "exclamation-circle";
	                    color = "#fecaca"; // red-200
	                } else if (type === "warning") {
	                    iconName = "exclamation-triangle";
	                    color = "#fde68a"; // yellow-200
	                } else if (type === "info") {
	                    iconName = "info-circle";
	                    color = "#bfdbfe"; // blue-200
	                }
	                icon.className = `fas fa-${iconName} mr-2`;
	                icon.style.color = color;
	            }

	            toast.classList.remove('hidden');
	            if (toast._timer) clearTimeout(toast._timer);
	            toast._timer = setTimeout(() => toast.classList.add('hidden'), 3500);
	        }

	        window.onload = function() {
	            loadData();
	            initDate();
	            initNumericInputs();
	            updateMedsStatus();
	            document.getElementById('headerPart').addEventListener('input', saveData);
	            document.getElementById('historyPart').addEventListener('input', saveData); 
	        };
    </script>
</body>
</html>
